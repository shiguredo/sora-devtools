"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[40],{4234:function(e,t,i){i.d(t,{Z:function(){return ed}});var n=i(828);class a{constructor(){if(!RTCRtpSender.prototype.createEncodedStreams)throw Error("E2EE is not supported in this browser.");this.worker=null,this.onWorkerDisconnect=null}startWorker(){let e=atob("InVzZSBzdHJpY3QiOwpjb25zdCBjb25uZWN0aW9uSWRMZW5ndGggPSAyNjsKZnVuY3Rpb24gYnl0ZUNvdW50KG4pIHsKICAgIGlmIChuID09PSAwKSB7CiAgICAgICAgcmV0dXJuIDE7CiAgICB9CiAgICAvLyBsb2cyNTYoeCkgPSBsb2coeCkgLyBsb2coMjU2KQogICAgcmV0dXJuIE1hdGguZmxvb3IoTWF0aC5sb2cobikgLyBNYXRoLmxvZygyICoqIDgpICsgMSk7Cn0KZnVuY3Rpb24gYXJyYXlCdWZmZXJUb051bWJlcihhcnJheUJ1ZmZlcikgewogICAgLy8gMzJiaXQg44G+44Gn44KS5oOz5a6aIChCaWdJbnQg44G444Gu5pu444GN5o+b44GI5pmC44Gr6KaB5L+u5q2jKQogICAgY29uc3QgbmV3QXJyYXlCdWZmZXIgPSBuZXcgQXJyYXlCdWZmZXIoVWludDMyQXJyYXkuQllURVNfUEVSX0VMRU1FTlQpOwogICAgY29uc3QgbmV3RGF0YVZpZXcgPSBuZXcgRGF0YVZpZXcobmV3QXJyYXlCdWZmZXIpOwogICAgY29uc3QgZGF0YVZpZXcgPSBuZXcgRGF0YVZpZXcoYXJyYXlCdWZmZXIpOwogICAgY29uc3QgcGFkZGluZ0xlbmd0aCA9IFVpbnQzMkFycmF5LkJZVEVTX1BFUl9FTEVNRU5UIC0gZGF0YVZpZXcuYnl0ZUxlbmd0aDsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcGFkZGluZ0xlbmd0aDsgaSArPSAxKSB7CiAgICAgICAgbmV3RGF0YVZpZXcuc2V0VWludDgoaSwgMCk7CiAgICB9CiAgICBmb3IgKGxldCBpID0gcGFkZGluZ0xlbmd0aCwgaiA9IDA7IGkgPCBVaW50MzJBcnJheS5CWVRFU19QRVJfRUxFTUVOVDsgaSArPSAxLCBqICs9IDEpIHsKICAgICAgICBuZXdEYXRhVmlldy5zZXRVaW50OChpLCBkYXRhVmlldy5nZXRVaW50OChqKSk7CiAgICB9CiAgICByZXR1cm4gbmV3RGF0YVZpZXcuZ2V0VWludDMyKDApOwp9CmZ1bmN0aW9uIGVuY29kZVNGcmFtZUhlYWRlcihzLCBjb3VudCwga2V5SWQpIHsKICAgIC8vICAwIDEgMiAzIDQgNSA2IDcKICAgIC8vICstKy0rLSstKy0rLSstKy0rLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSsKICAgIC8vIHxTfExFTiAgfDF8S0xFTiB8ICAgS0lELi4uIChsZW5ndGg9S0xFTikgICAgfCAgICBDVFIuLi4gKGxlbmd0aD1MRU4pICAgIHwKICAgIC8vICstKy0rLSstKy0rLSstKy0rLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSsKICAgIC8vIFM6IDEgYml0CiAgICAvLyBMRU46IDMgYml0CiAgICAvLyBYOiAxIGJpdAogICAgLy8gS0xFTjogMyBiaXQKICAgIC8vIEtJRDogS0xFTiBieXRlCiAgICAvLyBDVFI6IExFTiBieXRlCiAgICAvLyBUT0RPOiBrZXlJZCAoS0lEKSDjgYwgTnVtYmVyLk1BWF9TQUZFX0lOVEVHRVIsIDcgYnl0ZSDjgpLotoXjgYjjgabjgYTjgZ/loLTlkIjjga/jgqjjg6njg7zjgYvkvovlpJYKICAgIC8vIFRPRE86IGNvdW50IChDVFIpIOOBjCBOdW1iZXIuTUFYX1NBRkVfSU5URUdFUiwgNyBieXRlIOOCkui2heOBiOOBpuOBhOOBn+WgtOWQiOOBr+OCqOODqeODvOOBi+S+i+WklgogICAgaWYgKG1heEtleUlkIDwga2V5SWQgfHwgbWF4Q291bnQgPCBjb3VudCkgewogICAgICAgIHRocm93IG5ldyBFcnJvcignRVhDRUVERUQtTUFYSU1VTS1CUk9BRENBU1RJTkctVElNRScpOwogICAgfQogICAgY29uc3Qga2xlbiA9IGJ5dGVDb3VudChrZXlJZCk7CiAgICBjb25zdCBsZW4gPSBieXRlQ291bnQoY291bnQpOwogICAgY29uc3QgaGVhZGVyQnVmZmVyID0gbmV3IEFycmF5QnVmZmVyKDEgKyBrbGVuICsgbGVuKTsKICAgIGNvbnN0IGhlYWRlckRhdGFWaWV3ID0gbmV3IERhdGFWaWV3KGhlYWRlckJ1ZmZlcik7CiAgICAvLyBTLCBMRU4sIDEsIEtMRU4g44GnIDEgYnl0ZQogICAgaGVhZGVyRGF0YVZpZXcuc2V0VWludDgoMCwgKHMgPDwgNykgKyAobGVuIDw8IDQpICsgKDEgPDwgMykgKyBrbGVuKTsKICAgIGNvbnN0IGhlYWRlclVpbnQ4QXJyYXkgPSBuZXcgVWludDhBcnJheShoZWFkZXJCdWZmZXIpOwogICAgY29uc3Qga2V5SWRCdWZmZXIgPSBuZXcgQXJyYXlCdWZmZXIoVWludDMyQXJyYXkuQllURVNfUEVSX0VMRU1FTlQpOwogICAgY29uc3Qga2V5SWREYXRhVmlldyA9IG5ldyBEYXRhVmlldyhrZXlJZEJ1ZmZlcik7CiAgICBrZXlJZERhdGFWaWV3LnNldFVpbnQzMigwLCBrZXlJZCk7CiAgICBjb25zdCBrZXlJZFVpbnQ4QXJyYXkgPSBuZXcgVWludDhBcnJheShrZXlJZEJ1ZmZlcik7CiAgICBoZWFkZXJVaW50OEFycmF5LnNldChrZXlJZFVpbnQ4QXJyYXkuc3ViYXJyYXkoVWludDMyQXJyYXkuQllURVNfUEVSX0VMRU1FTlQgLSBrbGVuKSwgMSk7CiAgICBjb25zdCBjb3VudEJ1ZmZlciA9IG5ldyBBcnJheUJ1ZmZlcihVaW50MzJBcnJheS5CWVRFU19QRVJfRUxFTUVOVCk7CiAgICBjb25zdCBjb3VudERhdGFWaWV3ID0gbmV3IERhdGFWaWV3KGNvdW50QnVmZmVyKTsKICAgIGNvdW50RGF0YVZpZXcuc2V0VWludDMyKDAsIGNvdW50KTsKICAgIGNvbnN0IGNvdW50VWludDhBcnJheSA9IG5ldyBVaW50OEFycmF5KGNvdW50QnVmZmVyKTsKICAgIGhlYWRlclVpbnQ4QXJyYXkuc2V0KGNvdW50VWludDhBcnJheS5zdWJhcnJheShVaW50MzJBcnJheS5CWVRFU19QRVJfRUxFTUVOVCAtIGxlbiksIGtsZW4gKyAxKTsKICAgIHJldHVybiBoZWFkZXJVaW50OEFycmF5Owp9CmZ1bmN0aW9uIHNwbGl0SGVhZGVyKHNmcmFtZSkgewogICAgY29uc3Qgc2ZyYW1lRGF0YVZpZXcgPSBuZXcgRGF0YVZpZXcoc2ZyYW1lKTsKICAgIGNvbnN0IGhlYWRlciA9IHNmcmFtZURhdGFWaWV3LmdldFVpbnQ4KDApOwogICAgY29uc3QgbGVuID0gKGhlYWRlciAmIDB4NzApID4+IDQ7CiAgICBjb25zdCBrbGVuID0gaGVhZGVyICYgMHgwNzsKICAgIGNvbnN0IHNmcmFtZUhlYWRlckxlbmd0aCA9IDEgKyBrbGVuICsgbGVuOwogICAgY29uc3Qgc2ZyYW1lSGVhZGVyID0gc2ZyYW1lLnNsaWNlKDAsIHNmcmFtZUhlYWRlckxlbmd0aCk7CiAgICBpZiAoc2ZyYW1lSGVhZGVyLmJ5dGVMZW5ndGggPCBzZnJhbWVIZWFkZXJMZW5ndGgpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1VORVhQRUNURUQtU0ZSQU1FLUxFTkdUSCcpOwogICAgfQogICAgY29uc3QgY29ubmVjdGlvbklkID0gc2ZyYW1lLnNsaWNlKHNmcmFtZUhlYWRlckxlbmd0aCwgc2ZyYW1lSGVhZGVyTGVuZ3RoICsgY29ubmVjdGlvbklkTGVuZ3RoKTsKICAgIGNvbnN0IGVuY3J5cHRlZEZyYW1lID0gc2ZyYW1lLnNsaWNlKHNmcmFtZUhlYWRlckxlbmd0aCArIGNvbm5lY3Rpb25JZExlbmd0aCwgc2ZyYW1lLmJ5dGVMZW5ndGgpOwogICAgcmV0dXJuIFtzZnJhbWVIZWFkZXIsIGNvbm5lY3Rpb25JZCwgZW5jcnlwdGVkRnJhbWVdOwp9CmZ1bmN0aW9uIHBhcnNlU0ZyYW1lSGVhZGVyKHNmcmFtZUhlYWRlcikgewogICAgY29uc3Qgc2ZyYW1lSGVhZGVyRGF0YVZpZXcgPSBuZXcgRGF0YVZpZXcoc2ZyYW1lSGVhZGVyKTsKICAgIGNvbnN0IGhlYWRlciA9IHNmcmFtZUhlYWRlckRhdGFWaWV3LmdldFVpbnQ4KDApOwogICAgY29uc3QgcyA9IChoZWFkZXIgJiAweDgwKSA+PiA3OwogICAgY29uc3QgbGVuID0gKGhlYWRlciAmIDB4NzApID4+IDQ7CiAgICBjb25zdCB4ID0gKGhlYWRlciAmIDB4MDgpID4+IDM7CiAgICBjb25zdCBrbGVuID0gaGVhZGVyICYgMHgwNzsKICAgIC8vIHggZmxhZwogICAgaWYgKHggIT09IDEpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1VORVhQRUNURUQtWC1GTEFHJyk7CiAgICB9CiAgICBjb25zdCBoZWFkZXJMZW5ndGggPSAxICsga2xlbiArIGxlbjsKICAgIGlmIChzZnJhbWVIZWFkZXJEYXRhVmlldy5ieXRlTGVuZ3RoIDwgaGVhZGVyTGVuZ3RoKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdVTkVYUEVDVEVELVNGUkFNRS1IRUFERVItTEVOR1RIJyk7CiAgICB9CiAgICBjb25zdCBrZXlJZEJ1ZmZlciA9IHNmcmFtZUhlYWRlci5zbGljZSgxLCAxICsga2xlbik7CiAgICBjb25zdCBrZXlJZCA9IGFycmF5QnVmZmVyVG9OdW1iZXIoa2V5SWRCdWZmZXIpOwogICAgY29uc3QgY291bnRCdWZmZXIgPSBzZnJhbWVIZWFkZXIuc2xpY2UoMSArIGtsZW4sIGhlYWRlckxlbmd0aCk7CiAgICBjb25zdCBjb3VudCA9IGFycmF5QnVmZmVyVG9OdW1iZXIoY291bnRCdWZmZXIpOwogICAgcmV0dXJuIFtzLCBjb3VudCwga2V5SWRdOwp9Ci8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4vc2ZyYW1lLnRzIi8+Ci8vIFRPRE86IOaJseOBhuaVsOWApOOBjOWkp+OBjeOBhOeuh+aJgOOBp+OBryBOdW1iZXIg44GL44KJIEJpZ0ludCDjgavnva7jgY3mj5vjgYjjgosKLy8gVE9ETzogQmlnSW50IOOBq+e9ruOBjeaPm+OBiOOCi+mam+OBq+WkieabtOOBmeOCiwpjb25zdCBtYXhLZXlJZCA9IDIgKiogMzI7CmNvbnN0IG1heENvdW50ID0gMiAqKiAzMjsKY29uc3Qgc2VsZkRlcml2ZUtleU1hcCA9IG5ldyBNYXAoKTsKY29uc3QgY291bnRNYXAgPSBuZXcgTWFwKCk7CmNvbnN0IHdyaXRlSVZNYXAgPSBuZXcgTWFwKCk7CmNvbnN0IHJlbW90ZURlcml2ZUtleU1hcCA9IG5ldyBNYXAoKTsKY29uc3QgbGF0ZXN0UmVtb3RlS2V5SWRNYXAgPSBuZXcgTWFwKCk7CmNvbnN0IGxpdHRsZUVuZGlhbiA9IHRydWU7CmNvbnN0IGJpZ0VuZGlhbiA9ICFsaXR0bGVFbmRpYW47CmNvbnN0IHRleHRFbmNvZGVyID0gbmV3IFRleHRFbmNvZGVyKCk7CmNvbnN0IHRleHREZWNvZGVyID0gbmV3IFRleHREZWNvZGVyKCk7Ci8vIFZQOCDjga7jgb8KLy8gVE9ETyhuYWthaSk6IFZQOSAvIEFWMSDjgoLlsIbmnaXnmoTjgavlr77lv5zjgoLogIPjgYjjgosKY29uc3QgdW5lbmNyeXB0ZWRCeXRlcyA9IHsKICAgIC8vIEkg44OV44Os44O844OgCiAgICBrZXk6IDEwLAogICAgLy8g6Z2eIEkg44OV44Os44O844OgCiAgICBkZWx0YTogMywKICAgIC8vIOOCquODvOODh+OCo+OCqgogICAgdW5kZWZpbmVkOiAxLAp9OwpmdW5jdGlvbiBnZXRDb3VudChjb25uZWN0aW9uSWQpIHsKICAgIHJldHVybiBjb3VudE1hcC5nZXQoY29ubmVjdGlvbklkKSB8fCAwOwp9CmZ1bmN0aW9uIHNldENvdW50KGNvbm5lY3Rpb25JZCwgY291bnQpIHsKICAgIHJldHVybiBjb3VudE1hcC5zZXQoY29ubmVjdGlvbklkLCBjb3VudCk7Cn0KZnVuY3Rpb24gZ2V0UmVtb3RlRGVyaXZlS2V5KGNvbm5lY3Rpb25JZCwga2V5SWQpIHsKICAgIGlmICghcmVtb3RlRGVyaXZlS2V5TWFwLmhhcyhjb25uZWN0aW9uSWQpKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdSRU1PVEUtREVSSVZFS0VZLU1BUC1OT1QtRk9VTkQnKTsKICAgIH0KICAgIGNvbnN0IGRlcml2ZUtleU1hcCA9IHJlbW90ZURlcml2ZUtleU1hcC5nZXQoY29ubmVjdGlvbklkKTsKICAgIGlmICghZGVyaXZlS2V5TWFwKSB7CiAgICAgICAgcmV0dXJuOwogICAgfQogICAgcmV0dXJuIGRlcml2ZUtleU1hcC5nZXQoa2V5SWQpOwp9CmZ1bmN0aW9uIHNldFJlbW90ZURlcml2ZUtleShjb25uZWN0aW9uSWQsIGtleUlkLCBkZXJpdmVLZXkpIHsKICAgIGxldCBkZXJpdmVLZXlNYXAgPSByZW1vdGVEZXJpdmVLZXlNYXAuZ2V0KGNvbm5lY3Rpb25JZCk7CiAgICBpZiAoIWRlcml2ZUtleU1hcCkgewogICAgICAgIGRlcml2ZUtleU1hcCA9IG5ldyBNYXAoKTsKICAgIH0KICAgIGRlcml2ZUtleU1hcC5zZXQoa2V5SWQsIGRlcml2ZUtleSk7CiAgICByZW1vdGVEZXJpdmVLZXlNYXAuc2V0KGNvbm5lY3Rpb25JZCwgZGVyaXZlS2V5TWFwKTsKfQpmdW5jdGlvbiBzZXRMYXRlc3RSZW1vdGVLZXlJZChjb25uZWN0aW9uSWQsIGtleUlkKSB7CiAgICBjb25zdCBsYXRlc3RSZW1vdGVLZXlJZCA9IGxhdGVzdFJlbW90ZUtleUlkTWFwLmdldChjb25uZWN0aW9uSWQpOwogICAgaWYgKGxhdGVzdFJlbW90ZUtleUlkKSB7CiAgICAgICAgaWYgKGxhdGVzdFJlbW90ZUtleUlkIDwga2V5SWQpIHsKICAgICAgICAgICAgbGF0ZXN0UmVtb3RlS2V5SWRNYXAuc2V0KGNvbm5lY3Rpb25JZCwga2V5SWQpOwogICAgICAgIH0KICAgIH0KICAgIGVsc2UgewogICAgICAgIGxhdGVzdFJlbW90ZUtleUlkTWFwLnNldChjb25uZWN0aW9uSWQsIGtleUlkKTsKICAgIH0KfQpmdW5jdGlvbiByZW1vdmVPbGRSZW1vdGVEZXJpdmVLZXlzKCkgewogICAgbGF0ZXN0UmVtb3RlS2V5SWRNYXAuZm9yRWFjaCgobGF0ZXN0S2V5SWQsIGNvbm5lY3Rpb25JZCkgPT4gewogICAgICAgIGNvbnN0IGRlcml2ZUtleU1hcCA9IHJlbW90ZURlcml2ZUtleU1hcC5nZXQoY29ubmVjdGlvbklkKTsKICAgICAgICBpZiAoZGVyaXZlS2V5TWFwKSB7CiAgICAgICAgICAgIGRlcml2ZUtleU1hcC5mb3JFYWNoKChfLCBrZXlJZCkgPT4gewogICAgICAgICAgICAgICAgaWYgKGxhdGVzdEtleUlkICE9PSBrZXlJZCkgewogICAgICAgICAgICAgICAgICAgIGRlcml2ZUtleU1hcC5kZWxldGUoa2V5SWQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9KTsKfQpmdW5jdGlvbiByZW1vdmVEZXJpdmVLZXkoY29ubmVjdGlvbklkKSB7CiAgICBsYXRlc3RSZW1vdGVLZXlJZE1hcC5kZWxldGUoY29ubmVjdGlvbklkKTsKICAgIHJlbW90ZURlcml2ZUtleU1hcC5kZWxldGUoY29ubmVjdGlvbklkKTsKfQpmdW5jdGlvbiBnZXRMYXRlc3RTZWxmRGVyaXZlS2V5KCkgewogICAgY29uc3QgZGVyaXZlS2V5ID0gc2VsZkRlcml2ZUtleU1hcC5nZXQoJ2xhdGVzdCcpOwogICAgaWYgKCFkZXJpdmVLZXkpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0xBVEVTVC1TRUxGLURFUklWRUtFWS1OT1RfRk9VTkQnKTsKICAgIH0KICAgIHJldHVybiBkZXJpdmVLZXk7Cn0KZnVuY3Rpb24gc2V0U2VsZkRlcml2ZUtleShjb25uZWN0aW9uSWQsIGtleUlkLCBkZXJpdmVLZXkpIHsKICAgIGNvbnN0IGN1cnJlbnRTZWxmRGVyaXZlS2V5ID0gc2VsZkRlcml2ZUtleU1hcC5nZXQoJ2xhdGVzdCcpOwogICAgaWYgKGN1cnJlbnRTZWxmRGVyaXZlS2V5KSB7CiAgICAgICAgaWYgKGN1cnJlbnRTZWxmRGVyaXZlS2V5LmtleUlkIDwga2V5SWQpIHsKICAgICAgICAgICAgY29uc3QgbmV4dFNlbGZEZXJpdmVLZXkgPSB7IGNvbm5lY3Rpb25JZCwga2V5SWQsIGRlcml2ZUtleSB9OwogICAgICAgICAgICBzZWxmRGVyaXZlS2V5TWFwLnNldCgnbGF0ZXN0JywgbmV4dFNlbGZEZXJpdmVLZXkpOwogICAgICAgIH0KICAgIH0KICAgIGVsc2UgewogICAgICAgIGNvbnN0IG5leHRTZWxmRGVyaXZlS2V5ID0geyBjb25uZWN0aW9uSWQsIGtleUlkLCBkZXJpdmVLZXkgfTsKICAgICAgICBzZWxmRGVyaXZlS2V5TWFwLnNldCgnbGF0ZXN0JywgbmV4dFNlbGZEZXJpdmVLZXkpOwogICAgfQp9CmZ1bmN0aW9uIHNpbGVuY2VGcmFtZShlbmNvZGVkRnJhbWUpIHsKICAgIC8vIGNvbm5lY3Rpb24uY3JlYXRlZCwgcmVjZWl2ZU1lc3NhZ2Ug5Y+X5L+h5YmN44Gu5aC05ZCICiAgICBpZiAoZW5jb2RlZEZyYW1lLnR5cGUgPT09IHVuZGVmaW5lZCkgewogICAgICAgIC8vIOmfs+WjsOOBr+aal+WPt+WMluOBr+OBhOOCi+OBqOiBnuOBkeOBn+OCguOBruOBmOOCg+OBquOBhOOBruOBp+e9ruOBjeaPm+OBiOOCiwogICAgICAgIGNvbnN0IG5ld0RhdGEgPSBuZXcgQXJyYXlCdWZmZXIoMyk7CiAgICAgICAgY29uc3QgbmV3VWludDggPSBuZXcgVWludDhBcnJheShuZXdEYXRhKTsKICAgICAgICAvLyBPcHVzIOOCteOCpOODrOODs+OCueODleODrOODvOODoAogICAgICAgIG5ld1VpbnQ4LnNldChbMHhkOCwgMHhmZiwgMHhmZV0pOwogICAgICAgIGVuY29kZWRGcmFtZS5kYXRhID0gbmV3RGF0YTsKICAgIH0KICAgIGVsc2UgewogICAgICAgIC8vIOaYoOWDj+OBjOato+W4uOOBmOOCg+OBquOBhOOBn+OCgSBQTEkg44K544OI44O844Og44GM55m655Sf44GX44Gm44GX44G+44GGCiAgICAgICAgLy8g44Gd44Gu44Gf44KBIDMyMHgyNDAg44Gu55yf44Gj6buS44Gq55S76Z2i44Gr572u44GN5o+b44GI44KLCiAgICAgICAgY29uc3QgbmV3RGF0YSA9IG5ldyBBcnJheUJ1ZmZlcig2MCk7CiAgICAgICAgY29uc3QgbmV3VWludDggPSBuZXcgVWludDhBcnJheShuZXdEYXRhKTsKICAgICAgICBuZXdVaW50OC5zZXQoWwogICAgICAgICAgICAweGIwLCAweDA1LCAweDAwLCAweDlkLCAweDAxLCAweDJhLCAweGEwLCAweDAwLCAweDVhLCAweDAwLCAweDM5LCAweDAzLCAweDAwLCAweDAwLCAweDFjLAogICAgICAgICAgICAweDIyLCAweDE2LCAweDE2LCAweDIyLCAweDY2LCAweDEyLCAweDIwLCAweDA0LCAweDkwLCAweDQwLCAweDAwLCAweGM1LCAweDAxLCAweGUwLCAweDdjLAogICAgICAgICAgICAweDRkLCAweDJmLCAweGZhLCAweGRkLCAweDRkLCAweGE1LCAweDdmLCAweDg5LCAweGE1LCAweGZmLCAweDViLCAweGE5LCAweGI0LCAweGFmLCAweGYxLAogICAgICAgICAgICAweDM0LCAweGJmLCAweGViLCAweDc1LCAweDM2LCAweDk1LCAweGZlLCAweDI2LCAweDk2LCAweDYwLCAweGZlLCAweGZmLCAweGJhLCAweGZmLCAweDQwLAogICAgICAgIF0pOwogICAgICAgIGVuY29kZWRGcmFtZS5kYXRhID0gbmV3RGF0YTsKICAgIH0KICAgIHJldHVybiBlbmNvZGVkRnJhbWU7Cn0KZnVuY3Rpb24gc2V0V3JpdGVJVihjb25uZWN0aW9uSWQsIGtleUlkLCB3cml0ZUlWKSB7CiAgICBjb25zdCBrZXkgPSBbY29ubmVjdGlvbklkLCBrZXlJZC50b1N0cmluZygpXS5qb2luKCc6Jyk7CiAgICB3cml0ZUlWTWFwLnNldChrZXksIHdyaXRlSVYpOwp9CmZ1bmN0aW9uIGdldFdyaXRlSVYoY29ubmVjdGlvbklkLCBrZXlJZCkgewogICAgY29uc3Qga2V5ID0gW2Nvbm5lY3Rpb25JZCwga2V5SWQudG9TdHJpbmcoKV0uam9pbignOicpOwogICAgcmV0dXJuIHdyaXRlSVZNYXAuZ2V0KGtleSk7Cn0KZnVuY3Rpb24gZ2VuZXJhdGVJVihjb3VudCwgY29ubmVjdGlvbklkLCBrZXlJZCkgewogICAgLy8gVE9ETzoga2V5SWQg44GMIE51bWJlci5NQVhfU0FGRV9JTlRFR0VSLCA3IGJ5dGUg44KS6LaF44GI44Gm44GE44Gf5aC05ZCI44Gv44Ko44Op44O844GL5L6L5aSWCiAgICAvLyBUT0RPOiBjb3VudCDjgYwgTnVtYmVyLk1BWF9TQUZFX0lOVEVHRVIsIDcgYnl0ZSDjgpLotoXjgYjjgabjgYTjgZ/loLTlkIjjga/jgqjjg6njg7zjgYvkvovlpJYKICAgIC8vIDMyIGJpdCDjgb7jgacKICAgIGlmIChtYXhLZXlJZCA8IGtleUlkIHx8IG1heENvdW50IDwgY291bnQpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0VYQ0VFREVELU1BWElNVU0tQlJPQURDQVNUSU5HLVRJTUUnKTsKICAgIH0KICAgIGNvbnN0IHdyaXRlSVYgPSBnZXRXcml0ZUlWKGNvbm5lY3Rpb25JZCwga2V5SWQpOwogICAgaWYgKCF3cml0ZUlWKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdXUklURUlWLU5PVC1GT1VORCcpOwogICAgfQogICAgY29uc3QgcGFkZGluZ0xlbmd0aCA9IE5uIC0gVWludDMyQXJyYXkuQllURVNfUEVSX0VMRU1FTlQ7CiAgICBjb25zdCBjb3VudFdpdGhQYWRkaW5nQnVmZmVyID0gbmV3IEFycmF5QnVmZmVyKE5uKTsKICAgIGNvbnN0IGNvdW50V2l0aFBhZGRpbmdEYXRhVmlldyA9IG5ldyBEYXRhVmlldyhjb3VudFdpdGhQYWRkaW5nQnVmZmVyKTsKICAgIGNvdW50V2l0aFBhZGRpbmdEYXRhVmlldy5zZXRVaW50MzIocGFkZGluZ0xlbmd0aCwgY291bnQsIGJpZ0VuZGlhbik7CiAgICBjb25zdCBpdiA9IG5ldyBVaW50OEFycmF5KE5uKTsKICAgIGNvbnN0IGNvdW50V2l0aFBhZGRpbmcgPSBuZXcgVWludDhBcnJheShjb3VudFdpdGhQYWRkaW5nQnVmZmVyKTsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgTm47IGkrKykgewogICAgICAgIGl2W2ldID0gd3JpdGVJVltpXSBeIGNvdW50V2l0aFBhZGRpbmdbaV07CiAgICB9CiAgICByZXR1cm4gaXY7Cn0KZnVuY3Rpb24gcGFyc2VQYXlsb2FkKHBheWxvYWRUeXBlLCBwYXlsb2FkKSB7CiAgICByZXR1cm4gWwogICAgICAgIG5ldyBVaW50OEFycmF5KHBheWxvYWQsIDAsIHVuZW5jcnlwdGVkQnl0ZXNbcGF5bG9hZFR5cGVdKSwKICAgICAgICBuZXcgVWludDhBcnJheShwYXlsb2FkLCB1bmVuY3J5cHRlZEJ5dGVzW3BheWxvYWRUeXBlXSksCiAgICBdOwp9CmZ1bmN0aW9uIGVuY29kZUZyYW1lQWRkKGhlYWRlciwgc2ZyYW1lSGVhZGVyLCBjb25uZWN0aW9uSWQpIHsKICAgIGNvbnN0IGNvbm5lY3Rpb25JZERhdGEgPSB0ZXh0RW5jb2Rlci5lbmNvZGUoY29ubmVjdGlvbklkKTsKICAgIGNvbnN0IGZyYW1lQWRkID0gbmV3IFVpbnQ4QXJyYXkoaGVhZGVyLmJ5dGVMZW5ndGggKyBzZnJhbWVIZWFkZXIuYnl0ZUxlbmd0aCArIGNvbm5lY3Rpb25JZERhdGEuYnl0ZUxlbmd0aCk7CiAgICBmcmFtZUFkZC5zZXQoaGVhZGVyLCAwKTsKICAgIGZyYW1lQWRkLnNldChzZnJhbWVIZWFkZXIsIGhlYWRlci5ieXRlTGVuZ3RoKTsKICAgIGZyYW1lQWRkLnNldChjb25uZWN0aW9uSWREYXRhLCBoZWFkZXIuYnl0ZUxlbmd0aCArIHNmcmFtZUhlYWRlci5ieXRlTGVuZ3RoKTsKICAgIHJldHVybiBmcmFtZUFkZDsKfQphc3luYyBmdW5jdGlvbiBlbmNyeXB0RnVuY3Rpb24oZW5jb2RlZEZyYW1lLCBjb250cm9sbGVyKSB7CiAgICBjb25zdCB7IGNvbm5lY3Rpb25JZCwga2V5SWQsIGRlcml2ZUtleSB9ID0gZ2V0TGF0ZXN0U2VsZkRlcml2ZUtleSgpOwogICAgaWYgKCFkZXJpdmVLZXkpIHsKICAgICAgICByZXR1cm47CiAgICB9CiAgICBjb25zdCBjdXJyZW50Q291bnQgPSBnZXRDb3VudChjb25uZWN0aW9uSWQpOwogICAgLy8gY291bnQg44GMIDMyIGJpdCDku6XkuIrjga7loLTlkIjjga/lgZzmraLjgZnjgosKICAgIGlmIChjdXJyZW50Q291bnQgPiBtYXhDb3VudCkgewogICAgICAgIHBvc3RNZXNzYWdlKHsgdHlwZTogJ2Rpc2Nvbm5lY3QnIH0pOwogICAgfQogICAgY29uc3QgaXYgPSBnZW5lcmF0ZUlWKGN1cnJlbnRDb3VudCwgY29ubmVjdGlvbklkLCBrZXlJZCk7CiAgICBpZiAoIWl2KSB7CiAgICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3QgW2hlYWRlciwgcGF5bG9hZF0gPSBwYXJzZVBheWxvYWQoZW5jb2RlZEZyYW1lLnR5cGUsIGVuY29kZWRGcmFtZS5kYXRhKTsKICAgIGNvbnN0IHNmcmFtZUhlYWRlciA9IGVuY29kZVNGcmFtZUhlYWRlcigwLCBjdXJyZW50Q291bnQsIGtleUlkKTsKICAgIGNvbnN0IGZyYW1lQWRkID0gZW5jb2RlRnJhbWVBZGQoaGVhZGVyLCBzZnJhbWVIZWFkZXIsIGNvbm5lY3Rpb25JZCk7CiAgICBjcnlwdG8uc3VidGxlCiAgICAgICAgLmVuY3J5cHQoewogICAgICAgIG5hbWU6ICdBRVMtR0NNJywKICAgICAgICBpdjogaXYsCiAgICAgICAgLy8g5pqX5Y+35YyW44GV44KM44Gm44GE44Gq44GE6YOo5YiGCiAgICAgICAgYWRkaXRpb25hbERhdGE6IGZyYW1lQWRkLAogICAgfSwgZGVyaXZlS2V5LCBwYXlsb2FkKQogICAgICAgIC50aGVuKChjaXBoZXJUZXh0KSA9PiB7CiAgICAgICAgY29uc3QgbmV3RGF0YSA9IG5ldyBBcnJheUJ1ZmZlcihmcmFtZUFkZC5ieXRlTGVuZ3RoICsgY2lwaGVyVGV4dC5ieXRlTGVuZ3RoKTsKICAgICAgICBjb25zdCBuZXdEYXRhVWludDggPSBuZXcgVWludDhBcnJheShuZXdEYXRhKTsKICAgICAgICBuZXdEYXRhVWludDguc2V0KGZyYW1lQWRkLCAwKTsKICAgICAgICBuZXdEYXRhVWludDguc2V0KG5ldyBVaW50OEFycmF5KGNpcGhlclRleHQpLCBmcmFtZUFkZC5ieXRlTGVuZ3RoKTsKICAgICAgICBlbmNvZGVkRnJhbWUuZGF0YSA9IG5ld0RhdGE7CiAgICAgICAgY29udHJvbGxlci5lbnF1ZXVlKGVuY29kZWRGcmFtZSk7CiAgICB9KTsKICAgIHNldENvdW50KGNvbm5lY3Rpb25JZCwgY3VycmVudENvdW50ICsgMSk7Cn0KYXN5bmMgZnVuY3Rpb24gZGVjcnlwdEZ1bmN0aW9uKGVuY29kZWRGcmFtZSwgY29udHJvbGxlcikgewogICAgLy8g56m644OV44Os44O844Og5a++5b+cCiAgICBpZiAoZW5jb2RlZEZyYW1lLmRhdGEuYnl0ZUxlbmd0aCA8IDEpIHsKICAgICAgICByZXR1cm47CiAgICB9CiAgICB0cnkgewogICAgICAgIGNvbnN0IGZyYW1lTWV0YWRhdGFCdWZmZXIgPSBlbmNvZGVkRnJhbWUuZGF0YS5zbGljZSgwLCB1bmVuY3J5cHRlZEJ5dGVzW2VuY29kZWRGcmFtZS50eXBlXSk7CiAgICAgICAgY29uc3QgZnJhbWVNZXRhZGF0YSA9IG5ldyBVaW50OEFycmF5KGZyYW1lTWV0YWRhdGFCdWZmZXIpOwogICAgICAgIGNvbnN0IFtzZnJhbWVIZWFkZXJCdWZmZXIsIGNvbm5lY3Rpb25JZEJ1ZmZlciwgZW5jcnlwdGVkRnJhbWVCdWZmZXJdID0gc3BsaXRIZWFkZXIoZW5jb2RlZEZyYW1lLmRhdGEuc2xpY2UodW5lbmNyeXB0ZWRCeXRlc1tlbmNvZGVkRnJhbWUudHlwZV0pKTsKICAgICAgICBjb25zdCBzZnJhbWVIZWFkZXIgPSBuZXcgVWludDhBcnJheShzZnJhbWVIZWFkZXJCdWZmZXIpOwogICAgICAgIGNvbnN0IGNvbm5lY3Rpb25JZCA9IHRleHREZWNvZGVyLmRlY29kZShjb25uZWN0aW9uSWRCdWZmZXIpOwogICAgICAgIGNvbnN0IFtzLCBjb3VudCwga2V5SWRdID0gcGFyc2VTRnJhbWVIZWFkZXIoc2ZyYW1lSGVhZGVyQnVmZmVyKTsKICAgICAgICAvLyDku4rlm57jga8gcyBmbGFnIOOBryAwIOOBruOBvwogICAgICAgIGlmIChzICE9PSAwKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignVU5FWFBFQ1RFRC1TLUZMQUcnKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZGVyaXZlS2V5ID0gZ2V0UmVtb3RlRGVyaXZlS2V5KGNvbm5lY3Rpb25JZCwga2V5SWQpOwogICAgICAgIGlmICghZGVyaXZlS2V5KSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgY29uc3QgaXYgPSBnZW5lcmF0ZUlWKGNvdW50LCBjb25uZWN0aW9uSWQsIGtleUlkKTsKICAgICAgICBpZiAoIWl2KSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgY29uc3QgZnJhbWVBZGQgPSBlbmNvZGVGcmFtZUFkZChmcmFtZU1ldGFkYXRhLCBzZnJhbWVIZWFkZXIsIGNvbm5lY3Rpb25JZCk7CiAgICAgICAgY3J5cHRvLnN1YnRsZQogICAgICAgICAgICAuZGVjcnlwdCh7CiAgICAgICAgICAgIG5hbWU6ICdBRVMtR0NNJywKICAgICAgICAgICAgaXY6IGl2LAogICAgICAgICAgICBhZGRpdGlvbmFsRGF0YTogZnJhbWVBZGQsCiAgICAgICAgfSwgZGVyaXZlS2V5LCBuZXcgVWludDhBcnJheShlbmNyeXB0ZWRGcmFtZUJ1ZmZlcikpCiAgICAgICAgICAgIC50aGVuKChwbGFpblRleHQpID0+IHsKICAgICAgICAgICAgY29uc3QgbmV3RGF0YSA9IG5ldyBBcnJheUJ1ZmZlcihmcmFtZU1ldGFkYXRhQnVmZmVyLmJ5dGVMZW5ndGggKyBwbGFpblRleHQuYnl0ZUxlbmd0aCk7CiAgICAgICAgICAgIGNvbnN0IG5ld1VpbnQ4ID0gbmV3IFVpbnQ4QXJyYXkobmV3RGF0YSk7CiAgICAgICAgICAgIG5ld1VpbnQ4LnNldChuZXcgVWludDhBcnJheShmcmFtZU1ldGFkYXRhQnVmZmVyLCAwLCB1bmVuY3J5cHRlZEJ5dGVzW2VuY29kZWRGcmFtZS50eXBlXSkpOwogICAgICAgICAgICBuZXdVaW50OC5zZXQobmV3IFVpbnQ4QXJyYXkocGxhaW5UZXh0KSwgdW5lbmNyeXB0ZWRCeXRlc1tlbmNvZGVkRnJhbWUudHlwZV0pOwogICAgICAgICAgICBlbmNvZGVkRnJhbWUuZGF0YSA9IG5ld0RhdGE7CiAgICAgICAgICAgIGNvbnRyb2xsZXIuZW5xdWV1ZShlbmNvZGVkRnJhbWUpOwogICAgICAgIH0pOwogICAgfQogICAgY2F0Y2ggKGUpIHsKICAgICAgICAvLyDmg7PlrprlpJbjga7jg5HjgrHjg4Pjg4jjg5Xjgqnjg7zjg57jg4Pjg4jjgpLlj5fkv6HjgZfjgZ/loLTlkIgKICAgICAgICBjb250cm9sbGVyLmVucXVldWUoc2lsZW5jZUZyYW1lKGVuY29kZWRGcmFtZSkpOwogICAgfQp9Ci8vLyA8cmVmZXJlbmNlIHBhdGg9Ii4vZTJlZS50cyIvPgovLyBub25jZSDjgrXjgqTjgroKY29uc3QgTm4gPSAxMjsKLy8ga2V5IOOCteOCpOOCugpjb25zdCBOayA9IDE2OwovLyBrZXkg44K144Kk44K677yIYml077yJCmNvbnN0IGtleUxlbmd0aCA9IE5rICogODsKYXN5bmMgZnVuY3Rpb24gZ2VuZXJhdGVEZXJpdmVLZXkobWF0ZXJpYWwpIHsKICAgIGNvbnN0IHNhbHQgPSB0ZXh0RW5jb2Rlci5lbmNvZGUoJ1NGcmFtZTEwJyk7CiAgICBjb25zdCBpbmZvID0gdGV4dEVuY29kZXIuZW5jb2RlKCdrZXknKTsKICAgIGNvbnN0IGRlcml2ZUtleSA9IGF3YWl0IGNyeXB0by5zdWJ0bGUuZGVyaXZlS2V5KHsKICAgICAgICBuYW1lOiAnSEtERicsCiAgICAgICAgc2FsdDogc2FsdCwKICAgICAgICBoYXNoOiAnU0hBLTI1NicsCiAgICAgICAgaW5mbzogaW5mbywKICAgIH0sIG1hdGVyaWFsLCB7CiAgICAgICAgbmFtZTogJ0FFUy1HQ00nLAogICAgICAgIGxlbmd0aDoga2V5TGVuZ3RoLAogICAgfSwgZmFsc2UsIFsnZW5jcnlwdCcsICdkZWNyeXB0J10pOwogICAgcmV0dXJuIGRlcml2ZUtleTsKfQphc3luYyBmdW5jdGlvbiBnZW5lcmF0ZVdyaXRlSVYobWF0ZXJpYWwpIHsKICAgIGNvbnN0IHNhbHQgPSB0ZXh0RW5jb2Rlci5lbmNvZGUoJ1NGcmFtZTEwJyk7CiAgICBjb25zdCBpbmZvID0gdGV4dEVuY29kZXIuZW5jb2RlKCdzYWx0Jyk7CiAgICBjb25zdCB3cml0ZUlWQnVmZmVyID0gYXdhaXQgY3J5cHRvLnN1YnRsZS5kZXJpdmVCaXRzKHsKICAgICAgICBuYW1lOiAnSEtERicsCiAgICAgICAgc2FsdDogc2FsdCwKICAgICAgICBoYXNoOiAnU0hBLTM4NCcsCiAgICAgICAgaW5mbzogaW5mbywKICAgIH0sIG1hdGVyaWFsLCAKICAgIC8vIElWIOOBryA5NiDjg5Pjg4Pjg4jjgarjga7jgacKICAgIE5uICogOCk7CiAgICBjb25zdCB3cml0ZUlWID0gbmV3IFVpbnQ4QXJyYXkod3JpdGVJVkJ1ZmZlcik7CiAgICByZXR1cm4gd3JpdGVJVjsKfQpsZXQgcmVtb3ZhbFRpbWVvdXRJZCA9IDA7Cm9ubWVzc2FnZSA9IChldmVudCkgPT4gewogICAgY29uc3QgeyB0eXBlIH0gPSBldmVudC5kYXRhOwogICAgaWYgKHR5cGUgPT09ICdzZWxmU2VjcmV0S2V5TWF0ZXJpYWwnKSB7CiAgICAgICAgY29uc3QgeyBzZWxmU2VjcmV0S2V5TWF0ZXJpYWwsIHNlbGZDb25uZWN0aW9uSWQsIHNlbGZLZXlJZCwgd2FpdGluZ1RpbWUgfSA9IGV2ZW50LmRhdGE7CiAgICAgICAgY29uc3QgdGltZW91dElkID0gc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgIGNyeXB0by5zdWJ0bGUKICAgICAgICAgICAgICAgIC5pbXBvcnRLZXkoJ3JhdycsIHNlbGZTZWNyZXRLZXlNYXRlcmlhbC5idWZmZXIsICdIS0RGJywgZmFsc2UsIFsnZGVyaXZlQml0cycsICdkZXJpdmVLZXknXSkKICAgICAgICAgICAgICAgIC50aGVuKChtYXRlcmlhbCkgPT4gewogICAgICAgICAgICAgICAgZ2VuZXJhdGVEZXJpdmVLZXkobWF0ZXJpYWwpLnRoZW4oKGRlcml2ZUtleSkgPT4gewogICAgICAgICAgICAgICAgICAgIHNldFNlbGZEZXJpdmVLZXkoc2VsZkNvbm5lY3Rpb25JZCwgc2VsZktleUlkLCBkZXJpdmVLZXkpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBnZW5lcmF0ZVdyaXRlSVYobWF0ZXJpYWwpLnRoZW4oKHdyaXRlSVYpID0+IHsKICAgICAgICAgICAgICAgICAgICBzZXRXcml0ZUlWKHNlbGZDb25uZWN0aW9uSWQsIHNlbGZLZXlJZCwgd3JpdGVJVik7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0SWQpOwogICAgICAgICAgICB9KTsKICAgICAgICB9LCB3YWl0aW5nVGltZSB8fCAwKTsKICAgICAgICAvLyBUT0RPOiArMTAwMCDjgafpjbXnlJ/miJDlvozjgavlrp/ooYzjgZXjgozjgovjgojjgYbjgavjgZfjgabjgYTjgovjgYznn63jgYTloLTlkIjjga/kvLjjgbDjgZkKICAgICAgICBjb25zdCByZW1vdmFsV2FpdGluZ1RpbWUgPSAod2FpdGluZ1RpbWUgfHwgMCkgKyAxMDAwOwogICAgICAgIGlmIChyZW1vdmFsVGltZW91dElkKSB7CiAgICAgICAgICAgIC8vIOWLleS9nOa4iOOBv+OCv+OCpOODnuODvOacieOCigogICAgICAgICAgICBpZiAod2FpdGluZ1RpbWUpIHsKICAgICAgICAgICAgICAgIC8vIGNvbm5lY3Rpb24uZGVzdHJveWVkCiAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQocmVtb3ZhbFRpbWVvdXRJZCk7CiAgICAgICAgICAgICAgICByZW1vdmFsVGltZW91dElkID0gc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgcmVtb3ZlT2xkUmVtb3RlRGVyaXZlS2V5cygpOwogICAgICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dChyZW1vdmFsVGltZW91dElkKTsKICAgICAgICAgICAgICAgICAgICByZW1vdmFsVGltZW91dElkID0gMDsKICAgICAgICAgICAgICAgIH0sIHJlbW92YWxXYWl0aW5nVGltZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIC8vIOWLleS9nOa4iOOBv+OCv+OCpOODnuODvOOBquOBlwogICAgICAgICAgICAvLyBjb25uZWN0aW9uLmNyZWF0ZWQg44Gu5aC05ZCI44KC5bCR44GX5a6f6KGM44KS6YGF44KJ44Gb44KLCiAgICAgICAgICAgIHJlbW92YWxUaW1lb3V0SWQgPSBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgIHJlbW92ZU9sZFJlbW90ZURlcml2ZUtleXMoKTsKICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dChyZW1vdmFsVGltZW91dElkKTsKICAgICAgICAgICAgICAgIHJlbW92YWxUaW1lb3V0SWQgPSAwOwogICAgICAgICAgICB9LCByZW1vdmFsV2FpdGluZ1RpbWUpOwogICAgICAgIH0KICAgIH0KICAgIGVsc2UgaWYgKHR5cGUgPT09ICdyZW1vdGVTZWNyZXRLZXlNYXRlcmlhbHMnKSB7CiAgICAgICAgY29uc3QgeyByZW1vdGVTZWNyZXRLZXlNYXRlcmlhbHMgfSA9IGV2ZW50LmRhdGE7CiAgICAgICAgZm9yIChjb25zdCBbY29ubmVjdGlvbklkLCByZW1vdGVTZWNyZXRLZXlNYXRlcmlhbF0gb2YgT2JqZWN0LmVudHJpZXMocmVtb3RlU2VjcmV0S2V5TWF0ZXJpYWxzKSkgewogICAgICAgICAgICBjb25zdCB7IGtleUlkLCBzZWNyZXRLZXlNYXRlcmlhbCB9ID0gcmVtb3RlU2VjcmV0S2V5TWF0ZXJpYWw7CiAgICAgICAgICAgIGNyeXB0by5zdWJ0bGUKICAgICAgICAgICAgICAgIC5pbXBvcnRLZXkoJ3JhdycsIHNlY3JldEtleU1hdGVyaWFsLmJ1ZmZlciwgJ0hLREYnLCBmYWxzZSwgWydkZXJpdmVCaXRzJywgJ2Rlcml2ZUtleSddKQogICAgICAgICAgICAgICAgLnRoZW4oKG1hdGVyaWFsKSA9PiB7CiAgICAgICAgICAgICAgICBnZW5lcmF0ZURlcml2ZUtleShtYXRlcmlhbCkudGhlbigoZGVyaXZlS2V5KSA9PiB7CiAgICAgICAgICAgICAgICAgICAgc2V0UmVtb3RlRGVyaXZlS2V5KGNvbm5lY3Rpb25JZCwga2V5SWQsIGRlcml2ZUtleSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIGdlbmVyYXRlV3JpdGVJVihtYXRlcmlhbCkudGhlbigod3JpdGVJVikgPT4gewogICAgICAgICAgICAgICAgICAgIHNldFdyaXRlSVYoY29ubmVjdGlvbklkLCBrZXlJZCwgd3JpdGVJVik7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHNldExhdGVzdFJlbW90ZUtleUlkKGNvbm5lY3Rpb25JZCwga2V5SWQpOwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9CiAgICBlbHNlIGlmICh0eXBlID09PSAncmVtb3ZlUmVtb3RlRGVyaXZlS2V5JykgewogICAgICAgIGNvbnN0IHsgY29ubmVjdGlvbklkIH0gPSBldmVudC5kYXRhOwogICAgICAgIHJlbW92ZURlcml2ZUtleShjb25uZWN0aW9uSWQpOwogICAgfQogICAgZWxzZSBpZiAodHlwZSA9PT0gJ2VuY3J5cHQnKSB7CiAgICAgICAgY29uc3QgeyByZWFkYWJsZVN0cmVhbSwgd3JpdGFibGVTdHJlYW0gfSA9IGV2ZW50LmRhdGE7CiAgICAgICAgY29uc3QgdHJhbnNmb3JtU3RyZWFtID0gbmV3IFRyYW5zZm9ybVN0cmVhbSh7CiAgICAgICAgICAgIHRyYW5zZm9ybTogZW5jcnlwdEZ1bmN0aW9uLAogICAgICAgIH0pOwogICAgICAgIHJlYWRhYmxlU3RyZWFtLnBpcGVUaHJvdWdoKHRyYW5zZm9ybVN0cmVhbSkucGlwZVRvKHdyaXRhYmxlU3RyZWFtKTsKICAgIH0KICAgIGVsc2UgaWYgKHR5cGUgPT09ICdkZWNyeXB0JykgewogICAgICAgIGNvbnN0IHsgcmVhZGFibGVTdHJlYW0sIHdyaXRhYmxlU3RyZWFtIH0gPSBldmVudC5kYXRhOwogICAgICAgIGNvbnN0IHRyYW5zZm9ybVN0cmVhbSA9IG5ldyBUcmFuc2Zvcm1TdHJlYW0oewogICAgICAgICAgICB0cmFuc2Zvcm06IGRlY3J5cHRGdW5jdGlvbiwKICAgICAgICB9KTsKICAgICAgICByZWFkYWJsZVN0cmVhbS5waXBlVGhyb3VnaCh0cmFuc2Zvcm1TdHJlYW0pLnBpcGVUbyh3cml0YWJsZVN0cmVhbSk7CiAgICB9CiAgICBlbHNlIGlmICh0eXBlID09PSAnY2xlYXInKSB7CiAgICAgICAgY291bnRNYXAuY2xlYXIoKTsKICAgICAgICB3cml0ZUlWTWFwLmNsZWFyKCk7CiAgICAgICAgcmVtb3RlRGVyaXZlS2V5TWFwLmNsZWFyKCk7CiAgICAgICAgbGF0ZXN0UmVtb3RlS2V5SWRNYXAuY2xlYXIoKTsKICAgICAgICBzZWxmRGVyaXZlS2V5TWFwLmNsZWFyKCk7CiAgICB9Cn07Cg==");this.worker=new Worker(URL.createObjectURL(new Blob([e],{type:"application/javascript"}))),this.worker.onmessage=e=>{let{operation:t}=e.data;"disconnect"===t&&"function"==typeof this.onWorkerDisconnect&&this.onWorkerDisconnect()}}clearWorker(){this.worker&&this.worker.postMessage({type:"clear"})}terminateWorker(){this.worker&&this.worker.terminate()}async init(){let{preKeyBundle:e}=await window.e2ee.init();return e}setupSenderTransform(e,t){if(!this.worker)throw Error("Worker is null. Call startWorker in advance.");this.worker.postMessage({type:"encrypt",readableStream:e,writableStream:t},[e,t])}setupReceiverTransform(e,t){if(!this.worker)throw Error("Worker is null. Call startWorker in advance.");this.worker.postMessage({type:"decrypt",readableStream:e,writableStream:t},[e,t])}postRemoteSecretKeyMaterials(e){if(!this.worker)throw Error("Worker is null. Call startWorker in advance.");this.worker.postMessage({type:"remoteSecretKeyMaterials",remoteSecretKeyMaterials:e.remoteSecretKeyMaterials})}postRemoveRemoteDeriveKey(e){if(!this.worker)throw Error("Worker is null. Call startWorker in advance.");this.worker.postMessage({type:"removeRemoteDeriveKey",connectionId:e})}postSelfSecretKeyMaterial(e,t,i,n=0){if(!this.worker)throw Error("Worker is null. Call startWorker in advance.");this.worker.postMessage({type:"selfSecretKeyMaterial",selfConnectionId:e,selfKeyId:t,selfSecretKeyMaterial:i,waitingTime:n})}startSession(e,t){let[i,n]=window.e2ee.startSession(e,t.identityKey,t.signedPreKey,t.preKeySignature);if(n)throw n;return i}stopSession(e){let[t,i]=window.e2ee.stopSession(e);if(i)throw i;return t}receiveMessage(e){let[t,i]=window.e2ee.receiveMessage(e);if(i)throw i;return t}start(e){let[t,i]=window.e2ee.start(e);if(i)throw i;return t}addPreKeyBundle(e,t){let i=window.e2ee.addPreKeyBundle(e,t.identityKey,t.signedPreKey,t.preKeySignature);if(i)throw i}selfFingerprint(){return window.e2ee.selfFingerprint()}remoteFingerprints(){return window.e2ee.remoteFingerprints()}static async loadWasm(e){if(window.e2ee,(()=>{if("undefined"!=typeof global);else if("undefined"!=typeof window)window.global=window;else if("undefined"!=typeof self)self.global=self;else throw Error("cannot export Go (neither global, window nor self is defined)");if(global.require||"undefined"==typeof require||(global.require=require),!global.fs&&global.require){let e=require("fs");0!==Object.keys(e)&&(global.fs=e)}let e=()=>{let e=Error("not implemented");return e.code="ENOSYS",e};if(!global.fs){let t="";global.fs={constants:{O_WRONLY:-1,O_RDWR:-1,O_CREAT:-1,O_TRUNC:-1,O_APPEND:-1,O_EXCL:-1},writeSync(e,n){let a=(t+=i.decode(n)).lastIndexOf("\n");return -1!=a&&(console.log(t.substr(0,a)),t=t.substr(a+1)),n.length},write(t,i,n,a,s,o){if(0!==n||a!==i.length||null!==s){o(e());return}o(null,this.writeSync(t,i))},chmod(t,i,n){n(e())},chown(t,i,n,a){a(e())},close(t,i){i(e())},fchmod(t,i,n){n(e())},fchown(t,i,n,a){a(e())},fstat(t,i){i(e())},fsync(e,t){t(null)},ftruncate(t,i,n){n(e())},lchown(t,i,n,a){a(e())},link(t,i,n){n(e())},lstat(t,i){i(e())},mkdir(t,i,n){n(e())},open(t,i,n,a){a(e())},read(t,i,n,a,s,o){o(e())},readdir(t,i){i(e())},readlink(t,i){i(e())},rename(t,i,n){n(e())},rmdir(t,i){i(e())},stat(t,i){i(e())},symlink(t,i,n){n(e())},truncate(t,i,n){n(e())},unlink(t,i){i(e())},utimes(t,i,n,a){a(e())}}}if(global.process||(global.process={getuid:()=>-1,getgid:()=>-1,geteuid:()=>-1,getegid:()=>-1,getgroups(){throw e()},pid:-1,ppid:-1,umask(){throw e()},cwd(){throw e()},chdir(){throw e()}}),!global.crypto){let e=require("crypto");global.crypto={getRandomValues(t){e.randomFillSync(t)}}}global.performance||(global.performance={now(){let[e,t]=n.hrtime();return 1e3*e+t/1e6}}),global.TextEncoder||(global.TextEncoder=require("util").TextEncoder),global.TextDecoder||(global.TextDecoder=require("util").TextDecoder);let t=new TextEncoder("utf-8"),i=new TextDecoder("utf-8");if(global.Go=class{constructor(){this.argv=["js"],this.env={},this.exit=e=>{0!==e&&console.warn("exit code:",e)},this._exitPromise=new Promise(e=>{this._resolveExitPromise=e}),this._pendingEvent=null,this._scheduledTimeouts=new Map,this._nextCallbackTimeoutID=1;let e=(e,t)=>{this.mem.setUint32(e+0,t,!0),this.mem.setUint32(e+4,Math.floor(t/4294967296),!0)},n=e=>this.mem.getUint32(e+0,!0)+4294967296*this.mem.getInt32(e+4,!0),a=e=>{let t=this.mem.getFloat64(e,!0);if(0===t)return;if(!isNaN(t))return t;let i=this.mem.getUint32(e,!0);return this._values[i]},s=(e,t)=>{if("number"==typeof t&&0!==t){if(isNaN(t)){this.mem.setUint32(e+4,2146959360,!0),this.mem.setUint32(e,0,!0);return}this.mem.setFloat64(e,t,!0);return}if(void 0===t){this.mem.setFloat64(e,0,!0);return}let i=this._ids.get(t);void 0===i&&(void 0===(i=this._idPool.pop())&&(i=this._values.length),this._values[i]=t,this._goRefCounts[i]=0,this._ids.set(t,i)),this._goRefCounts[i]++;let n=0;switch(typeof t){case"object":null!==t&&(n=1);break;case"string":n=2;break;case"symbol":n=3;break;case"function":n=4}this.mem.setUint32(e+4,2146959360|n,!0),this.mem.setUint32(e,i,!0)},o=e=>{let t=n(e+0),i=n(e+8);return new Uint8Array(this._inst.exports.mem.buffer,t,i)},l=e=>{let t=n(e+0),i=n(e+8),s=Array(i);for(let e=0;e<i;e++)s[e]=a(t+8*e);return s},r=e=>{let t=n(e+0),a=n(e+8);return i.decode(new DataView(this._inst.exports.mem.buffer,t,a))},g=Date.now()-performance.now();this.importObject={go:{"runtime.wasmExit":e=>{let t=this.mem.getInt32(e+8,!0);this.exited=!0,delete this._inst,delete this._values,delete this._goRefCounts,delete this._ids,delete this._idPool,this.exit(t)},"runtime.wasmWrite":e=>{let t=n(e+8),i=n(e+16),a=this.mem.getInt32(e+24,!0);fs.writeSync(t,new Uint8Array(this._inst.exports.mem.buffer,i,a))},"runtime.resetMemoryDataView":e=>{this.mem=new DataView(this._inst.exports.mem.buffer)},"runtime.nanotime1":t=>{e(t+8,(g+performance.now())*1e6)},"runtime.walltime1":t=>{let i=(new Date).getTime();e(t+8,i/1e3),this.mem.setInt32(t+16,i%1e3*1e6,!0)},"runtime.scheduleTimeoutEvent":e=>{let t=this._nextCallbackTimeoutID;this._nextCallbackTimeoutID++,this._scheduledTimeouts.set(t,setTimeout(()=>{for(this._resume();this._scheduledTimeouts.has(t);)console.warn("scheduleTimeoutEvent: missed timeout event"),this._resume()},n(e+8)+1)),this.mem.setInt32(e+16,t,!0)},"runtime.clearTimeoutEvent":e=>{let t=this.mem.getInt32(e+8,!0);clearTimeout(this._scheduledTimeouts.get(t)),this._scheduledTimeouts.delete(t)},"runtime.getRandomData":e=>{crypto.getRandomValues(o(e+8))},"syscall/js.finalizeRef":e=>{let t=this.mem.getUint32(e+8,!0);if(this._goRefCounts[t]--,0===this._goRefCounts[t]){let e=this._values[t];this._values[t]=null,this._ids.delete(e),this._idPool.push(t)}},"syscall/js.stringVal":e=>{s(e+24,r(e+8))},"syscall/js.valueGet":e=>{let t=Reflect.get(a(e+8),r(e+16));s((e=this._inst.exports.getsp())+32,t)},"syscall/js.valueSet":e=>{Reflect.set(a(e+8),r(e+16),a(e+32))},"syscall/js.valueDelete":e=>{Reflect.deleteProperty(a(e+8),r(e+16))},"syscall/js.valueIndex":e=>{s(e+24,Reflect.get(a(e+8),n(e+16)))},"syscall/js.valueSetIndex":e=>{Reflect.set(a(e+8),n(e+16),a(e+24))},"syscall/js.valueCall":e=>{try{let t=a(e+8),i=Reflect.get(t,r(e+16)),n=l(e+32),o=Reflect.apply(i,t,n);e=this._inst.exports.getsp(),s(e+56,o),this.mem.setUint8(e+64,1)}catch(t){s(e+56,t),this.mem.setUint8(e+64,0)}},"syscall/js.valueInvoke":e=>{try{let t=a(e+8),i=l(e+16),n=Reflect.apply(t,void 0,i);e=this._inst.exports.getsp(),s(e+40,n),this.mem.setUint8(e+48,1)}catch(t){s(e+40,t),this.mem.setUint8(e+48,0)}},"syscall/js.valueNew":e=>{try{let t=a(e+8),i=l(e+16),n=Reflect.construct(t,i);e=this._inst.exports.getsp(),s(e+40,n),this.mem.setUint8(e+48,1)}catch(t){s(e+40,t),this.mem.setUint8(e+48,0)}},"syscall/js.valueLength":t=>{e(t+16,parseInt(a(t+8).length))},"syscall/js.valuePrepareString":i=>{let n=t.encode(String(a(i+8)));s(i+16,n),e(i+24,n.length)},"syscall/js.valueLoadString":e=>{let t=a(e+8);o(e+16).set(t)},"syscall/js.valueInstanceOf":e=>{this.mem.setUint8(e+24,a(e+8) instanceof a(e+16)?1:0)},"syscall/js.copyBytesToGo":t=>{let i=o(t+8),n=a(t+32);if(!(n instanceof Uint8Array||n instanceof Uint8ClampedArray)){this.mem.setUint8(t+48,0);return}let s=n.subarray(0,i.length);i.set(s),e(t+40,s.length),this.mem.setUint8(t+48,1)},"syscall/js.copyBytesToJS":t=>{let i=a(t+8),n=o(t+16);if(!(i instanceof Uint8Array||i instanceof Uint8ClampedArray)){this.mem.setUint8(t+48,0);return}let s=n.subarray(0,i.length);i.set(s),e(t+40,s.length),this.mem.setUint8(t+48,1)},debug:e=>{console.log(e)}}}}async run(e){this._inst=e,this.mem=new DataView(this._inst.exports.mem.buffer),this._values=[NaN,0,null,!0,!1,global,this],this._goRefCounts=Array(this._values.length).fill(1/0),this._ids=new Map([[0,1],[null,2],[!0,3],[!1,4],[global,5],[this,6]]),this._idPool=[],this.exited=!1;let i=4096,n=e=>{let n=i,a=t.encode(e+"\x00");return new Uint8Array(this.mem.buffer,i,a.length).set(a),(i+=a.length)%8!=0&&(i+=8-i%8),n},a=this.argv.length,s=[];this.argv.forEach(e=>{s.push(n(e))}),s.push(0),Object.keys(this.env).sort().forEach(e=>{s.push(n(`${e}=${this.env[e]}`))}),s.push(0);let o=i;s.forEach(e=>{this.mem.setUint32(i,e,!0),this.mem.setUint32(i+4,0,!0),i+=8}),this._inst.exports.run(a,o),this.exited&&this._resolveExitPromise(),await this._exitPromise}_resume(){if(this.exited)throw Error("Go program has already exited");this._inst.exports.resume(),this.exited&&this._resolveExitPromise()}_makeFuncWrapper(e){let t=this;return function(){let i={id:e,this:this,args:arguments};return t._pendingEvent=i,t._resume(),i.result}}},global.require&&global.require.main===module&&global.process&&global.process.versions&&!global.process.versions.electron){n.argv.length<3&&(console.error("usage: go_js_wasm_exec [wasm binary] [arguments]"),n.exit(1));let e=new Go;e.argv=n.argv.slice(2),e.env=Object.assign({TMPDIR:require("os").tmpdir()},n.env),e.exit=n.exit,WebAssembly.instantiate(fs.readFileSync(n.argv[2]),e.importObject).then(t=>(n.on("exit",t=>{0!==t||e.exited||(e._pendingEvent={id:0},e._resume())}),e.run(t.instance))).catch(e=>{console.error(e),n.exit(1)})}})(),!window.Go)throw Error(`Failed to load module Go. window.Go is ${window.Go}.`);let t=new Go,{instance:i}=await WebAssembly.instantiateStreaming(fetch(e),t.importObject);if(t.run(i),!window.e2ee)throw Error(`Failed to load module e2ee. window.e2ee is ${window.e2ee}.`)}static version(){return"2021.1.0"}static wasmVersion(){return window.e2ee.version()}}async function s(e,t){if(t.audio&&"boolean"!=typeof t.audio)for(let i of e.getAudioTracks())await i.applyConstraints(t.audio);if(t.video&&"boolean"!=typeof t.video)for(let i of e.getVideoTracks())await i.applyConstraints(t.video)}var o=Uint8Array,l=Uint16Array,r=Int32Array,g=new o([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),c=new o([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),C=new o([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),d=function(e,t){for(var i=new l(31),n=0;n<31;++n)i[n]=t+=1<<e[n-1];for(var a=new r(i[30]),n=1;n<30;++n)for(var s=i[n];s<i[n+1];++s)a[s]=s-i[n]<<5|n;return{b:i,r:a}},h=d(g,2),I=h.b,m=h.r;I[28]=258,m[258]=28;for(var u=d(c,0),A=u.b,b=u.r,p=new l(32768),Z=0;Z<32768;++Z){var w=(43690&Z)>>1|(21845&Z)<<1;w=(61680&(w=(52428&w)>>2|(13107&w)<<2))>>4|(3855&w)<<4,p[Z]=((65280&w)>>8|(255&w)<<8)>>1}for(var S=function(e,t,i){for(var n,a=e.length,s=0,o=new l(t);s<a;++s)e[s]&&++o[e[s]-1];var r=new l(t);for(s=1;s<t;++s)r[s]=r[s-1]+o[s-1]<<1;if(i){n=new l(1<<t);var g=15-t;for(s=0;s<a;++s)if(e[s])for(var c=s<<4|e[s],C=t-e[s],d=r[e[s]-1]++<<C,h=d|(1<<C)-1;d<=h;++d)n[p[d]>>g]=c}else for(s=0,n=new l(a);s<a;++s)e[s]&&(n[s]=p[r[e[s]-1]++]>>15-e[s]);return n},f=new o(288),Z=0;Z<144;++Z)f[Z]=8;for(var Z=144;Z<256;++Z)f[Z]=9;for(var Z=256;Z<280;++Z)f[Z]=7;for(var Z=280;Z<288;++Z)f[Z]=8;for(var y=new o(32),Z=0;Z<32;++Z)y[Z]=5;var V=S(f,9,0),W=S(f,9,1),G=S(y,5,0),v=S(y,5,1),k=function(e){for(var t=e[0],i=1;i<e.length;++i)e[i]>t&&(t=e[i]);return t},R=function(e,t,i){var n=t/8|0;return(e[n]|e[n+1]<<8)>>(7&t)&i},T=function(e,t){var i=t/8|0;return(e[i]|e[i+1]<<8|e[i+2]<<16)>>(7&t)},O=function(e){return(e+7)/8|0},B=function(e,t,i){return(null==t||t<0)&&(t=0),(null==i||i>e.length)&&(i=e.length),new o(e.subarray(t,i))},N=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],X=function(e,t,i){var n=Error(t||N[e]);if(n.code=e,Error.captureStackTrace&&Error.captureStackTrace(n,X),!i)throw n;return n},E=function(e,t,i,n){var a=e.length,s=n?n.length:0;if(!a||t.f&&!t.l)return i||new o(0);var l=!i,r=l||2!=t.i,d=t.i;l&&(i=new o(3*a));var h=function(e){var t=i.length;if(e>t){var n=new o(Math.max(2*t,e));n.set(i),i=n}},m=t.f||0,u=t.p||0,b=t.b||0,p=t.l,Z=t.d,w=t.m,f=t.n,y=8*a;do{if(!p){m=R(e,u,1);var V=R(e,u+1,3);if(u+=3,V){if(1==V)p=W,Z=v,w=9,f=5;else if(2==V){var G=R(e,u,31)+257,N=R(e,u+10,15)+4,E=G+R(e,u+5,31)+1;u+=14;for(var Y=new o(E),L=new o(19),D=0;D<N;++D)L[C[D]]=R(e,u+3*D,7);u+=3*N;for(var K=k(L),J=(1<<K)-1,U=S(L,K,1),D=0;D<E;){var F=U[R(e,u,J)];u+=15&F;var j=F>>4;if(j<16)Y[D++]=j;else{var P=0,Q=0;for(16==j?(Q=3+R(e,u,3),u+=2,P=Y[D-1]):17==j?(Q=3+R(e,u,7),u+=3):18==j&&(Q=11+R(e,u,127),u+=7);Q--;)Y[D++]=P}}var x=Y.subarray(0,G),H=Y.subarray(G);w=k(x),f=k(H),p=S(x,w,1),Z=S(H,f,1)}else X(1)}else{var j=O(u)+4,M=e[j-4]|e[j-3]<<8,_=j+M;if(_>a){d&&X(0);break}r&&h(b+M),i.set(e.subarray(j,_),b),t.b=b+=M,t.p=u=8*_,t.f=m;continue}if(u>y){d&&X(0);break}}r&&h(b+131072);for(var z=(1<<w)-1,q=(1<<f)-1,$=u;;$=u){var P=p[T(e,u)&z],ee=P>>4;if((u+=15&P)>y){d&&X(0);break}if(P||X(2),ee<256)i[b++]=ee;else if(256==ee){$=u,p=null;break}else{var et=ee-254;if(ee>264){var D=ee-257,ei=g[D];et=R(e,u,(1<<ei)-1)+I[D],u+=ei}var en=Z[T(e,u)&q],ea=en>>4;en||X(3),u+=15&en;var H=A[ea];if(ea>3){var ei=c[ea];H+=T(e,u)&(1<<ei)-1,u+=ei}if(u>y){d&&X(0);break}r&&h(b+131072);var es=b+et;if(b<H){var eo=s-H,el=Math.min(H,es);for(eo+b<0&&X(3);b<el;++b)i[b]=n[eo+b]}for(;b<es;++b)i[b]=i[b-H]}}t.l=p,t.p=$,t.b=b,t.f=m,p&&(m=1,t.m=w,t.d=Z,t.n=f)}while(!m);return b!=i.length&&l?B(i,0,b):i.subarray(0,b)},Y=function(e,t,i){i<<=7&t;var n=t/8|0;e[n]|=i,e[n+1]|=i>>8},L=function(e,t,i){i<<=7&t;var n=t/8|0;e[n]|=i,e[n+1]|=i>>8,e[n+2]|=i>>16},D=function(e,t){for(var i=[],n=0;n<e.length;++n)e[n]&&i.push({s:n,f:e[n]});var a=i.length,s=i.slice();if(!a)return{t:Q,l:0};if(1==a){var r=new o(i[0].s+1);return r[i[0].s]=1,{t:r,l:1}}i.sort(function(e,t){return e.f-t.f}),i.push({s:-1,f:25001});var g=i[0],c=i[1],C=0,d=1,h=2;for(i[0]={s:-1,f:g.f+c.f,l:g,r:c};d!=a-1;)g=i[i[C].f<i[h].f?C++:h++],c=i[C!=d&&i[C].f<i[h].f?C++:h++],i[d++]={s:-1,f:g.f+c.f,l:g,r:c};for(var I=s[0].s,n=1;n<a;++n)s[n].s>I&&(I=s[n].s);var m=new l(I+1),u=K(i[d-1],m,0);if(u>t){var n=0,A=0,b=u-t,p=1<<b;for(s.sort(function(e,t){return m[t.s]-m[e.s]||e.f-t.f});n<a;++n){var Z=s[n].s;if(m[Z]>t)A+=p-(1<<u-m[Z]),m[Z]=t;else break}for(A>>=b;A>0;){var w=s[n].s;m[w]<t?A-=1<<t-m[w]++-1:++n}for(;n>=0&&A;--n){var S=s[n].s;m[S]==t&&(--m[S],++A)}u=t}return{t:new o(m),l:u}},K=function(e,t,i){return -1==e.s?Math.max(K(e.l,t,i+1),K(e.r,t,i+1)):t[e.s]=i},J=function(e){for(var t=e.length;t&&!e[--t];);for(var i=new l(++t),n=0,a=e[0],s=1,o=function(e){i[n++]=e},r=1;r<=t;++r)if(e[r]==a&&r!=t)++s;else{if(!a&&s>2){for(;s>138;s-=138)o(32754);s>2&&(o(s>10?s-11<<5|28690:s-3<<5|12305),s=0)}else if(s>3){for(o(a),--s;s>6;s-=6)o(8304);s>2&&(o(s-3<<5|8208),s=0)}for(;s--;)o(a);s=1,a=e[r]}return{c:i.subarray(0,n),n:t}},U=function(e,t){for(var i=0,n=0;n<t.length;++n)i+=e[n]*t[n];return i},F=function(e,t,i){var n=i.length,a=O(t+2);e[a]=255&n,e[a+1]=n>>8,e[a+2]=255^e[a],e[a+3]=255^e[a+1];for(var s=0;s<n;++s)e[a+s+4]=i[s];return(a+4+n)*8},j=function(e,t,i,n,a,s,o,r,d,h,I){Y(t,I++,i),++a[256];for(var m,u,A,b,p=D(a,15),Z=p.t,w=p.l,W=D(s,15),v=W.t,k=W.l,R=J(Z),T=R.c,O=R.n,B=J(v),N=B.c,X=B.n,E=new l(19),K=0;K<T.length;++K)++E[31&T[K]];for(var K=0;K<N.length;++K)++E[31&N[K]];for(var j=D(E,7),P=j.t,Q=j.l,x=19;x>4&&!P[C[x-1]];--x);var H=h+5<<3,M=U(a,f)+U(s,y)+o,_=U(a,Z)+U(s,v)+o+14+3*x+U(E,P)+2*E[16]+3*E[17]+7*E[18];if(d>=0&&H<=M&&H<=_)return F(t,I,e.subarray(d,d+h));if(Y(t,I,1+(_<M)),I+=2,_<M){m=S(Z,w,0),u=Z,A=S(v,k,0),b=v;var z=S(P,Q,0);Y(t,I,O-257),Y(t,I+5,X-1),Y(t,I+10,x-4),I+=14;for(var K=0;K<x;++K)Y(t,I+3*K,P[C[K]]);I+=3*x;for(var q=[T,N],$=0;$<2;++$)for(var ee=q[$],K=0;K<ee.length;++K){var et=31&ee[K];Y(t,I,z[et]),I+=P[et],et>15&&(Y(t,I,ee[K]>>5&127),I+=ee[K]>>12)}}else m=V,u=f,A=G,b=y;for(var K=0;K<r;++K){var ei=n[K];if(ei>255){var et=ei>>18&31;L(t,I,m[et+257]),I+=u[et+257],et>7&&(Y(t,I,ei>>23&31),I+=g[et]);var en=31&ei;L(t,I,A[en]),I+=b[en],en>3&&(L(t,I,ei>>5&8191),I+=c[en])}else L(t,I,m[ei]),I+=u[ei]}return L(t,I,m[256]),I+u[256]},P=new r([65540,131080,131088,131104,262176,1048704,1048832,2114560,2117632]),Q=new o(0),x=function(e,t,i,n,a,s){var C=s.z||e.length,d=new o(n+C+5*(1+Math.ceil(C/7e3))+a),h=d.subarray(n,d.length-a),I=s.l,u=7&(s.r||0);if(t){u&&(h[0]=s.r>>3);for(var A=P[t-1],p=A>>13,Z=8191&A,w=(1<<i)-1,S=s.p||new l(32768),f=s.h||new l(w+1),y=Math.ceil(i/3),V=2*y,W=function(t){return(e[t]^e[t+1]<<y^e[t+2]<<V)&w},G=new r(25e3),v=new l(288),k=new l(32),R=0,T=0,N=s.i||0,X=0,E=s.w||0,Y=0;N+2<C;++N){var L=W(N),D=32767&N,K=f[L];if(S[D]=K,f[L]=D,E<=N){var J=C-N;if((R>7e3||X>24576)&&(J>423||!I)){u=j(e,h,0,G,v,k,T,X,Y,N-Y,u),X=R=T=0,Y=N;for(var U=0;U<286;++U)v[U]=0;for(var U=0;U<30;++U)k[U]=0}var Q=2,x=0,H=Z,M=D-K&32767;if(J>2&&L==W(N-M))for(var _=Math.min(p,J)-1,z=Math.min(32767,N),q=Math.min(258,J);M<=z&&--H&&D!=K;){if(e[N+Q]==e[N+Q-M]){for(var $=0;$<q&&e[N+$]==e[N+$-M];++$);if($>Q){if(Q=$,x=M,$>_)break;for(var ee=Math.min(M,$-2),et=0,U=0;U<ee;++U){var ei=N-M+U&32767,en=S[ei],ea=ei-en&32767;ea>et&&(et=ea,K=ei)}}}K=S[D=K],M+=D-K&32767}if(x){G[X++]=268435456|m[Q]<<18|b[x];var es=31&m[Q],eo=31&b[x];T+=g[es]+c[eo],++v[257+es],++k[eo],E=N+Q,++R}else G[X++]=e[N],++v[e[N]]}}for(N=Math.max(N,E);N<C;++N)G[X++]=e[N],++v[e[N]];u=j(e,h,I,G,v,k,T,X,Y,N-Y,u),I||(s.r=7&u|h[u/8|0]<<3,u-=7,s.h=f,s.p=S,s.i=N,s.w=E)}else{for(var N=s.w||0;N<C+I;N+=65535){var el=N+65535;el>=C&&(h[u/8|0]=I,el=C),u=F(h,u+1,e.subarray(N,el))}s.i=C}return B(d,0,n+O(u)+a)},H=function(){var e=1,t=0;return{p:function(i){for(var n=e,a=t,s=0|i.length,o=0;o!=s;){for(var l=Math.min(o+2655,s);o<l;++o)a+=n+=i[o];n=(65535&n)+15*(n>>16),a=(65535&a)+15*(a>>16)}e=n,t=a},d:function(){return e%=65521,t%=65521,(255&e)<<24|(65280&e)<<8|(255&t)<<8|t>>8}}},M=function(e,t,i,n,a){if(!a&&(a={l:1},t.dictionary)){var s=t.dictionary.subarray(-32768),l=new o(s.length+e.length);l.set(s),l.set(e,s.length),e=l,a.w=s.length}return x(e,null==t.level?6:t.level,null==t.mem?a.l?Math.ceil(1.5*Math.max(8,Math.min(13,Math.log(e.length)))):20:12+t.mem,i,n,a)},_=function(e,t,i){for(;i;++t)e[t]=i,i>>>=8},z=function(e,t){var i=t.level;if(e[0]=120,e[1]=(0==i?0:i<6?1:9==i?3:2)<<6|(t.dictionary&&32),e[1]|=31-(e[0]<<8|e[1])%31,t.dictionary){var n=H();n.p(t.dictionary),_(e,2,n.d())}};function q(e,t){t||(t={});var i=H();i.p(e);var n=M(e,t,t.dictionary?6:2,4);return z(n,t),_(n,n.length-4,i.d()),n}function $(e,t){var i;return E(e.subarray((i=t&&t.dictionary,((15&e[0])!=8||e[0]>>4>7||(e[0]<<8|e[1])%31)&&X(6,"invalid zlib data"),(e[1]>>5&1)==+!i&&X(6,"invalid zlib data: "+(32&e[1]?"need":"unexpected")+" dictionary"),(e[1]>>3&4)+2),-4),{i:2},t&&t.out,t&&t.dictionary)}var ee="undefined"!=typeof TextDecoder&&new TextDecoder;try{ee.decode(Q,{stream:!0})}catch(e){}function et(){let e=window.navigator.userAgent.toLocaleLowerCase();return -1!==e.indexOf("edge")?"edge":-1!==e.indexOf("chrome")&&-1===e.indexOf("edge")?"chrome":-1!==e.indexOf("safari")&&-1===e.indexOf("chrome")?"safari":-1!==e.indexOf("opera")?"opera":-1!==e.indexOf("firefox")?"firefox":null}function ei(e){return void 0!==e.authn_metadata?e.authn_metadata:void 0!==e.metadata?e.metadata:null}function en(e){return"object"==typeof e&&null!==e&&"pre_key_bundle"in e?e.pre_key_bundle:null}class ea extends Error{}function es(e,t,i){let n=new Event(e);try{n.data=JSON.parse(JSON.stringify(t))}catch(e){n.data=t}return n.transportType=i,n}function eo(e,t,i,n,a){let s=new Event(e);try{s.data=JSON.parse(JSON.stringify(t))}catch(e){s.data=t}return s.logType=i,s.dataChannelId=n,s.dataChannelLabel=a,s}function el(e,t){if(t){let t=$(new Uint8Array(e));return new TextDecoder().decode(t)}return e}class er{constructor(e,t,i,n,a,s){this.senderStreamInitialized=new WeakSet,this.role=t,this.channelId=i,this.metadata=n,this.signalingUrlCandidates=e,this.options=a,this.connectionTimeout=6e4,"number"==typeof this.options.timeout&&(console.warn("@deprecated timeout option will be removed in a future version. Use connectionTimeout."),this.connectionTimeout=this.options.timeout),"number"==typeof this.options.connectionTimeout&&(this.connectionTimeout=this.options.connectionTimeout),this.disconnectWaitTimeout=3e3,"number"==typeof this.options.disconnectWaitTimeout&&(this.disconnectWaitTimeout=this.options.disconnectWaitTimeout),this.signalingCandidateTimeout=3e3,"number"==typeof this.options.signalingCandidateTimeout&&(this.signalingCandidateTimeout=this.options.signalingCandidateTimeout),this.constraints=null,this.debug=s,this.clientId=null,this.connectionId=null,this.sessionId=null,this.remoteConnectionIds=[],this.stream=null,this.ws=null,this.pc=null,this.encodings=[],this.callbacks={disconnect:()=>{},push:()=>{},addstream:()=>{},track:()=>{},removestream:()=>{},removetrack:()=>{},notify:()=>{},log:()=>{},timeout:()=>{},timeline:()=>{},signaling:()=>{},message:()=>{},datachannel:()=>{}},this.authMetadata=null,this.e2ee=null,this.connectionTimeoutTimerId=0,this.monitorSignalingWebSocketEventTimerId=0,this.monitorIceConnectionStateChangeTimerId=0,this.soraDataChannels={},this.mids={audio:"",video:""},this.signalingSwitched=!1,this.signalingOfferMessageDataChannels={},this.connectedSignalingUrl="",this.contactSignalingUrl=""}on(e,t){"addstream"===e?console.warn("@deprecated addstream callback will be removed in a future version. Use track callback."):"removestream"===e&&console.warn("@deprecated removestream callback will be removed in a future version. Use removetrack callback."),e in this.callbacks&&(this.callbacks[e]=t)}stopAudioTrack(e){return console.warn("@deprecated stopAudioTrack will be removed in a future version. Use removeAudioTrack instead."),this.removeAudioTrack(e)}removeAudioTrack(e){for(let t of e.getAudioTracks())t.enabled=!1;return new Promise((t,i)=>{setTimeout(()=>{Promise.all(e.getAudioTracks().map(async t=>{if(t.stop(),e.removeTrack(t),null!==this.pc){let e=this.pc.getSenders().find(e=>e.track&&e.track.id===t.id);if(e)return e.replaceTrack(null)}})).then(()=>t()).catch(i)},100)})}stopVideoTrack(e){return console.warn("@deprecated stopVideoTrack will be removed in a future version. Use removeVideoTrack instead."),this.removeVideoTrack(e)}removeVideoTrack(e){for(let t of e.getVideoTracks())t.enabled=!1;return new Promise((t,i)=>{setTimeout(()=>{Promise.all(e.getVideoTracks().map(async t=>{if(t.stop(),e.removeTrack(t),null!==this.pc){let e=this.pc.getSenders().find(e=>e.track&&e.track.id===t.id);if(e)return e.replaceTrack(null)}})).then(()=>t()).catch(i)},100)})}async replaceAudioTrack(e,t){await this.removeAudioTrack(e);let i=this.getAudioTransceiver();if(null===i)throw Error("Unable to set an audio track. Audio track sender is undefined");e.addTrack(t),await i.sender.replaceTrack(t),await this.setupSenderTransform(i.sender)}async replaceVideoTrack(e,t){await this.removeVideoTrack(e);let i=this.getVideoTransceiver();if(null===i)throw Error("Unable to set video track. Video track sender is undefined");e.addTrack(t),await i.sender.replaceTrack(t),await this.setupSenderTransform(i.sender)}signalingTerminate(){for(let e of Object.keys(this.soraDataChannels)){let t=this.soraDataChannels[e];t&&t.close(),delete this.soraDataChannels[e]}this.ws&&(this.ws.close(),this.ws=null),this.pc&&this.pc.close(),this.e2ee&&this.e2ee.terminateWorker(),this.initializeConnection()}abendPeerConnectionState(e){for(let e of(this.clearMonitorIceConnectionStateChange(),this.pc&&(this.pc.ondatachannel=null,this.pc.oniceconnectionstatechange=null,this.pc.onicegatheringstatechange=null,this.pc.onconnectionstatechange=null),this.ws&&(this.ws.onclose=e=>{this.writeWebSocketTimelineLog("onclose",{code:e.code,reason:e.reason})},this.ws.onmessage=null,this.ws.onerror=null),Object.keys(this.soraDataChannels))){let t=this.soraDataChannels[e];t&&(t.onclose=e=>{let t=e.currentTarget;this.writeDataChannelTimelineLog("onclose",t),this.trace("CLOSE DATA CHANNEL",t.label)},t.onmessage=null,t.onerror=null)}for(let e of Object.keys(this.soraDataChannels)){let t=this.soraDataChannels[e];t&&t.close(),delete this.soraDataChannels[e]}this.ws&&(this.ws.close(),this.ws=null),this.pc&&this.pc.close(),this.e2ee&&this.e2ee.terminateWorker(),this.initializeConnection();let t=this.soraCloseEvent("abend",e);this.callbacks.disconnect(t),this.writeSoraTimelineLog("disconnect-abend",t)}async abend(e,t){for(let e of(this.clearMonitorIceConnectionStateChange(),this.pc&&(this.pc.ondatachannel=null,this.pc.oniceconnectionstatechange=null,this.pc.onicegatheringstatechange=null,this.pc.onconnectionstatechange=null),this.ws&&(this.ws.onclose=e=>{this.writeWebSocketTimelineLog("onclose",{code:e.code,reason:e.reason})},this.ws.onmessage=null,this.ws.onerror=null),Object.keys(this.soraDataChannels))){let t=this.soraDataChannels[e];t&&(t.onclose=e=>{let t=e.currentTarget;this.writeDataChannelTimelineLog("onclose",t),this.trace("CLOSE DATA CHANNEL",t.label)},t.onmessage=null,t.onerror=null)}if(this.soraDataChannels.signaling){let t={type:"disconnect",reason:e};if(this.signalingOfferMessageDataChannels.signaling&&!0===this.signalingOfferMessageDataChannels.signaling.compress){let e=q(new TextEncoder().encode(JSON.stringify(t)),{});if("open"===this.soraDataChannels.signaling.readyState)try{this.soraDataChannels.signaling.send(e),this.writeDataChannelSignalingLog("send-disconnect",this.soraDataChannels.signaling,t)}catch(t){let e=t.message;this.writeDataChannelSignalingLog("failed-to-send-disconnect",this.soraDataChannels.signaling,e)}}else if("open"===this.soraDataChannels.signaling.readyState)try{this.soraDataChannels.signaling.send(JSON.stringify(t)),this.writeDataChannelSignalingLog("send-disconnect",this.soraDataChannels.signaling,t)}catch(t){let e=t.message;this.writeDataChannelSignalingLog("failed-to-send-disconnect",this.soraDataChannels.signaling,e)}}for(let e of Object.keys(this.soraDataChannels)){let t=this.soraDataChannels[e];t&&(t.onerror=null,t.close()),delete this.soraDataChannels[e]}if(await this.disconnectWebSocket(e),await this.disconnectPeerConnection(),this.e2ee&&this.e2ee.terminateWorker(),this.initializeConnection(),"WEBSOCKET-ONCLOSE"===e&&t&&(1e3===t.code||1005===t.code)){let e=this.soraCloseEvent("normal","DISCONNECT",t);this.writeSoraTimelineLog("disconnect-normal",e),this.callbacks.disconnect(e);return}let i=this.soraCloseEvent("abend",e,t);this.writeSoraTimelineLog("disconnect-abend",i),this.callbacks.disconnect(this.soraCloseEvent("abend",e,t))}initializeConnection(){this.clientId=null,this.connectionId=null,this.sessionId=null,this.remoteConnectionIds=[],this.stream=null,this.ws=null,this.pc=null,this.encodings=[],this.authMetadata=null,this.e2ee=null,this.soraDataChannels={},this.mids={audio:"",video:""},this.signalingSwitched=!1,this.signalingOfferMessageDataChannels={},this.contactSignalingUrl="",this.connectedSignalingUrl="",this.clearConnectionTimeout()}disconnectWebSocket(e){let t=0;return this.signalingSwitched?(this.ws&&(this.ws.close(),this.ws=null),Promise.resolve(null)):new Promise((i,n)=>{if(!this.ws)return i(null);if(this.ws.onclose=e=>(this.ws&&(this.ws.close(),this.ws=null),clearTimeout(t),this.writeWebSocketTimelineLog("onclose",{code:e.code,reason:e.reason}),i({code:e.code,reason:e.reason})),1!==this.ws.readyState)return this.ws.close(),this.ws=null,i(null);{let n={type:"disconnect",reason:e};this.ws.send(JSON.stringify(n)),this.writeWebSocketSignalingLog("send-disconnect",n),t=setTimeout(()=>{this.ws&&(this.ws.close(),this.ws=null),i({code:1006,reason:""})},this.disconnectWaitTimeout)}})}disconnectDataChannel(){let e=()=>{for(let e of Object.keys(this.soraDataChannels)){let t=this.soraDataChannels[e];t&&(t.onerror=null,t.close()),delete this.soraDataChannels[e]}};return new Promise((t,i)=>{if(!this.soraDataChannels.signaling)return e(),t({code:4999,reason:""});let n=setTimeout(()=>(e(),i()),this.disconnectWaitTimeout),a=[];for(let i of Object.keys(this.soraDataChannels)){let s=this.soraDataChannels[i];if(s){s.onerror=()=>(clearTimeout(n),e(),t({code:4999,reason:""}));let i=()=>new Promise((e,t)=>{let i=0,n=setInterval(()=>{i++,"closed"===s.readyState&&(clearInterval(n),e()),this.disconnectWaitTimeout<100*i&&(e(),clearInterval(n))},100)});a.push(i())}}Promise.all(a).then(()=>{0===Object.keys(this.soraDataChannels).length?t(null):t({code:4999,reason:""})}).catch(e=>i(e)).finally(()=>{e(),clearTimeout(n)});let s={type:"disconnect",reason:"NO-ERROR"};if(this.signalingOfferMessageDataChannels.signaling&&!0===this.signalingOfferMessageDataChannels.signaling.compress){let e=q(new TextEncoder().encode(JSON.stringify(s)),{});if("open"===this.soraDataChannels.signaling.readyState)try{this.soraDataChannels.signaling.send(e),this.writeDataChannelSignalingLog("send-disconnect",this.soraDataChannels.signaling,s)}catch(t){let e=t.message;this.writeDataChannelSignalingLog("failed-to-send-disconnect",this.soraDataChannels.signaling,e)}}else if("open"===this.soraDataChannels.signaling.readyState)try{this.soraDataChannels.signaling.send(JSON.stringify(s)),this.writeDataChannelSignalingLog("send-disconnect",this.soraDataChannels.signaling,s)}catch(t){let e=t.message;this.writeDataChannelSignalingLog("failed-to-send-disconnect",this.soraDataChannels.signaling,e)}})}disconnectPeerConnection(){return new Promise((e,t)=>(this.pc&&"closed"!==this.pc.connectionState&&this.pc.close(),e()))}async disconnect(){for(let e of(this.clearMonitorIceConnectionStateChange(),this.pc&&(this.pc.ondatachannel=null,this.pc.oniceconnectionstatechange=null,this.pc.onicegatheringstatechange=null,this.pc.onconnectionstatechange=null),this.ws&&(this.ws.onclose=e=>{this.writeWebSocketTimelineLog("onclose",{code:e.code,reason:e.reason})},this.ws.onmessage=null,this.ws.onerror=null),Object.keys(this.soraDataChannels))){let t=this.soraDataChannels[e];t&&(t.onmessage=null,t.onclose=e=>{let t=e.currentTarget;this.writeDataChannelTimelineLog("onclose",t),this.trace("CLOSE DATA CHANNEL",t.label)})}let e=null;if(this.signalingSwitched){try{let t=await this.disconnectDataChannel();null!==t&&(e=this.soraCloseEvent("normal","DISCONNECT",t))}catch(t){e=this.soraCloseEvent("abend","DISCONNECT-TIMEOUT")}await this.disconnectWebSocket("NO-ERROR"),await this.disconnectPeerConnection()}else{let t=await this.disconnectWebSocket("NO-ERROR");await this.disconnectPeerConnection(),null!==t&&(e=this.soraCloseEvent("normal","DISCONNECT",t))}this.e2ee&&this.e2ee.terminateWorker(),this.initializeConnection(),e&&("abend"===e.type?this.writeSoraTimelineLog("disconnect-abend",e):"normal"===e.type&&this.writeSoraTimelineLog("disconnect-normal",e),this.callbacks.disconnect(e))}setupE2EE(){!0===this.options.e2ee&&(this.e2ee=new a,this.e2ee.onWorkerDisconnect=async()=>{await this.abend("INTERNAL-ERROR",{reason:"CRASH-E2EE-WORKER"})},this.e2ee.startWorker())}startE2EE(){if(!0===this.options.e2ee&&this.e2ee){if(!this.connectionId){let e=Error();throw e.message="E2EE failed. Self connectionId is null",e}this.e2ee.clearWorker();let e=this.e2ee.start(this.connectionId);this.e2ee.postSelfSecretKeyMaterial(this.connectionId,e.selfKeyId,e.selfSecretKeyMaterial)}}async getSignalingWebSocket(e){if("string"==typeof e)return new Promise((t,i)=>{let n=new WebSocket(e);n.onclose=e=>{let t=new ea(`Signaling failed. CloseEventCode:${e.code} CloseEventReason:'${e.reason}'`);t.code=e.code,t.reason=e.reason,this.writeWebSocketTimelineLog("onclose",t),i(t)},n.onopen=e=>{t(n)}});if(Array.isArray(e)){let t=!1,i=e=>new Promise((i,n)=>{let a=new WebSocket(e),s=setTimeout(()=>{this.writeWebSocketSignalingLog("signaling-url-candidate",{type:"timeout",url:a.url}),a&&!t&&(a.onclose=null,a.onerror=null,a.onopen=null,a.close(),n())},this.signalingCandidateTimeout);a.onclose=e=>{this.writeWebSocketSignalingLog("signaling-url-candidate",{type:"close",url:a.url,message:"WebSocket closed",code:e.code,reason:e.reason}),a&&a.close(),clearInterval(s),n()},a.onerror=e=>{this.writeWebSocketSignalingLog("signaling-url-candidate",{type:"error",url:a.url,message:"Failed to connect WebSocket"}),a&&(a.onclose=null,a.close()),clearInterval(s),n()},a.onopen=e=>{a&&(clearInterval(s),t?(this.writeWebSocketSignalingLog("signaling-url-candidate",{type:"open",url:a.url,selected:!1}),a.onerror=null,a.onclose=null,a.onopen=null,a.close(),n()):(this.writeWebSocketSignalingLog("signaling-url-candidate",{type:"open",url:a.url,selected:!0}),a.onerror=null,a.onclose=null,a.onopen=null,t=!0,i(a)))}});try{return await Promise.any(e.map(e=>i(e)))}catch(e){throw new ea("Signaling failed. All signaling URL candidates failed to connect")}}throw new ea("Signaling failed. Invalid format signaling URL candidates")}async signaling(e,t=!1){let i=await this.createOffer();return this.trace("CREATE OFFER",i),new Promise((n,a)=>{this.writeWebSocketSignalingLog("new-websocket",e.url),e.binaryType="arraybuffer",e.onclose=e=>{let t=new ea(`Signaling failed. CloseEventCode:${e.code} CloseEventReason:'${e.reason}'`);t.code=e.code,t.reason=e.reason,this.writeWebSocketTimelineLog("onclose",t),this.signalingTerminate(),a(t)},e.onmessage=async t=>{if(t.data instanceof ArrayBuffer){this.writeWebSocketSignalingLog("onmessage-e2ee",t.data),this.signalingOnMessageE2EE(t.data);return}if("string"!=typeof t.data)throw Error("Received invalid signaling data");let i=JSON.parse(t.data);if("offer"===i.type)this.writeWebSocketSignalingLog("onmessage-offer",i),this.signalingOnMessageTypeOffer(i),this.connectedSignalingUrl=e.url,n(i);else if("update"===i.type)this.writeWebSocketSignalingLog("onmessage-update",i),await this.signalingOnMessageTypeUpdate(i);else if("re-offer"===i.type)this.writeWebSocketSignalingLog("onmessage-re-offer",i),await this.signalingOnMessageTypeReOffer(i);else if("ping"===i.type)await this.signalingOnMessageTypePing(i);else if("push"===i.type)this.callbacks.push(i,"websocket");else if("notify"===i.type)"connection.created"===i.event_type?this.writeWebSocketTimelineLog("notify-connection.created",i):"connection.destroyed"===i.event_type&&this.writeWebSocketTimelineLog("notify-connection.destroyed",i),this.signalingOnMessageTypeNotify(i,"websocket");else if("switched"===i.type)this.writeWebSocketSignalingLog("onmessage-switched",i),this.signalingOnMessageTypeSwitched(i);else if("redirect"===i.type){this.writeWebSocketSignalingLog("onmessage-redirect",i);try{let e=await this.signalingOnMessageTypeRedirect(i);n(e)}catch(e){a(e)}}},(async()=>{let n;try{n=function(e,t,i,n,a,s){if("sendrecv"!==t&&"sendonly"!==t&&"recvonly"!==t)throw Error("Unknown role type");if(null==i)throw Error("channelId can not be null or undefined");let o={type:"connect",sora_client:"Sora JavaScript SDK 2024.1.0-canary.0",environment:window.navigator.userAgent,role:t,channel_id:i,sdp:e,audio:!0,video:!0};if("sendrecv"===t&&!1===a.multistream)throw Error("Failed to parse options. Options multistream must be true when connecting using 'sendrecv'");!0===s&&(o.redirect=!0),"boolean"==typeof a.multistream&&(o.multistream=a.multistream),"boolean"==typeof a.simulcast&&(o.simulcast=a.simulcast),void 0!==a.simulcastRid&&0<=["r0","r1","r2"].indexOf(a.simulcastRid)&&(o.simulcast_rid=a.simulcastRid),"boolean"==typeof a.spotlight&&(o.spotlight=a.spotlight),"spotlightNumber"in a&&(o.spotlight_number=a.spotlightNumber);let l=["none","r0","r1","r2"];void 0!==a.spotlightFocusRid&&0<=l.indexOf(a.spotlightFocusRid)&&(o.spotlight_focus_rid=a.spotlightFocusRid),void 0!==a.spotlightUnfocusRid&&0<=l.indexOf(a.spotlightUnfocusRid)&&(o.spotlight_unfocus_rid=a.spotlightUnfocusRid),void 0!==n&&(o.metadata=n),void 0!==a.signalingNotifyMetadata&&(o.signaling_notify_metadata=a.signalingNotifyMetadata),void 0!==a.forwardingFilter&&(o.forwarding_filter=a.forwardingFilter),void 0!==a.clientId&&(o.client_id=a.clientId),void 0!==a.bundleId&&(o.bundle_id=a.bundleId),"boolean"==typeof a.dataChannelSignaling&&(o.data_channel_signaling=a.dataChannelSignaling),"boolean"==typeof a.ignoreDisconnectWebSocket&&(o.ignore_disconnect_websocket=a.ignoreDisconnectWebSocket);let r=["audioCodecType","audioBitRate"],g=["audioOpusParamsChannels","audioOpusParamsMaxplaybackrate","audioOpusParamsStereo","audioOpusParamsSpropStereo","audioOpusParamsMinptime","audioOpusParamsPtime","audioOpusParamsUseinbandfec","audioOpusParamsUsedtx"],c=["videoCodecType","videoBitRate","videoVP9Params","videoH264Params","videoH265Params","videoAV1Params"],C=Object.assign({},a);Object.keys(C).filter(e=>{"audio"===e&&"boolean"==typeof C[e]||"video"===e&&"boolean"==typeof C[e]||0<=r.indexOf(e)&&null!==C[e]||0<=g.indexOf(e)&&null!==C[e]||0<=c.indexOf(e)&&null!==C[e]||delete C[e]}),void 0!==C.audio&&(o.audio=C.audio);let d=Object.keys(C).some(e=>0<=r.indexOf(e));o.audio&&d&&(o.audio={},"audioCodecType"in C&&(o.audio.codec_type=C.audioCodecType),"audioBitRate"in C&&(o.audio.bit_rate=C.audioBitRate));let h=Object.keys(C).some(e=>0<=g.indexOf(e));o.audio&&h&&("object"!=typeof o.audio&&(o.audio={}),o.audio.opus_params={},"audioOpusParamsChannels"in C&&(o.audio.opus_params.channels=C.audioOpusParamsChannels),"audioOpusParamsMaxplaybackrate"in C&&(o.audio.opus_params.maxplaybackrate=C.audioOpusParamsMaxplaybackrate),"audioOpusParamsStereo"in C&&(o.audio.opus_params.stereo=C.audioOpusParamsStereo),"audioOpusParamsSpropStereo"in C&&(o.audio.opus_params.sprop_stereo=C.audioOpusParamsSpropStereo),"audioOpusParamsMinptime"in C&&(o.audio.opus_params.minptime=C.audioOpusParamsMinptime),"audioOpusParamsPtime"in C&&(o.audio.opus_params.ptime=C.audioOpusParamsPtime),"audioOpusParamsUseinbandfec"in C&&(o.audio.opus_params.useinbandfec=C.audioOpusParamsUseinbandfec),"audioOpusParamsUsedtx"in C&&(o.audio.opus_params.usedtx=C.audioOpusParamsUsedtx)),void 0!==C.video&&(o.video=C.video);let I=Object.keys(C).some(e=>0<=c.indexOf(e));if(o.video&&I&&(o.video={},"videoCodecType"in C&&(o.video.codec_type=C.videoCodecType),"videoBitRate"in C&&(o.video.bit_rate=C.videoBitRate),"videoVP9Params"in C&&(o.video.vp9_params=C.videoVP9Params),"videoH264Params"in C&&(o.video.h264_params=C.videoH264Params),"videoH265Params"in C&&(o.video.h265_params=C.videoH265Params),"videoAV1Params"in C&&(o.video.av1_params=C.videoAV1Params)),o.simulcast&&!function(){if(!window.RTCRtpSender||!RTCRtpSender.getCapabilities)return!1;let e=RTCRtpSender.getCapabilities("video");if(!e)return!1;let t=e.headerExtensions.map(e=>e.uri);return["urn:ietf:params:rtp-hdrext:sdes:mid","urn:ietf:params:rtp-hdrext:sdes:rtp-stream-id","urn:ietf:params:rtp-hdrext:sdes:repaired-rtp-stream-id"].every(e=>t.includes(e))}()&&"recvonly"!==t)throw Error("Simulcast can not be used with this browser");if("boolean"==typeof a.e2ee&&(o.e2ee=a.e2ee),!0===a.e2ee){if(void 0===o.signaling_notify_metadata&&(o.signaling_notify_metadata={}),null===o.signaling_notify_metadata||"object"!=typeof o.signaling_notify_metadata)throw Error("E2EE failed. Options signalingNotifyMetadata must be type 'object'");!0===o.video&&(o.video={}),o.video&&(o.video.codec_type="VP8")}return Array.isArray(a.dataChannels)&&0<a.dataChannels.length&&(o.data_channels=function(e){let t=[];for(let i of e)t.push(function(e){if("object"!=typeof e||null===e)throw Error("Failed to parse options dataChannels. Options dataChannels element must be type 'object'");let t={};return"string"==typeof e.label&&(t.label=e.label),"string"==typeof e.direction&&(t.direction=e.direction),"boolean"==typeof e.ordered&&(t.ordered=e.ordered),"boolean"==typeof e.compress&&(t.compress=e.compress),"number"==typeof e.maxPacketLifeTime&&(t.max_packet_life_time=e.maxPacketLifeTime),"number"==typeof e.maxRetransmits&&(t.max_retransmits=e.maxRetransmits),"string"==typeof e.protocol&&(t.protocol=e.protocol),t}(i));return t}(a.dataChannels)),void 0!==a.audioStreamingLanguageCode&&(o.audio_streaming_language_code=a.audioStreamingLanguageCode),o}(i.sdp||"",this.role,this.channelId,this.metadata,this.options,t)}catch(e){a(e);return}if(n.e2ee&&this.e2ee){let e=await this.e2ee.init();n.signaling_notify_metadata.pre_key_bundle=e}this.trace("SIGNALING CONNECT MESSAGE",n),e&&(e.send(JSON.stringify(n)),this.writeWebSocketSignalingLog(`send-${n.type}`,n),this.ws=e,t||(this.contactSignalingUrl=e.url,this.writeWebSocketSignalingLog("contact-signaling-url",this.contactSignalingUrl)))})()})}async connectPeerConnection(e){let t=Object.assign({},e.config);this.e2ee&&(t=Object.assign({encodedInsertableStreams:!0},t)),void 0!==window.RTCPeerConnection.generateCertificate&&(t=Object.assign({certificates:[await window.RTCPeerConnection.generateCertificate({name:"ECDSA",namedCurve:"P-256"})]},t)),this.trace("PEER CONNECTION CONFIG",t),this.writePeerConnectionTimelineLog("new-peerconnection",t),this.pc=new window.RTCPeerConnection(t,this.constraints),this.pc.oniceconnectionstatechange=e=>{this.pc&&(this.writePeerConnectionTimelineLog("oniceconnectionstatechange",{connectionState:this.pc.connectionState,iceConnectionState:this.pc.iceConnectionState,iceGatheringState:this.pc.iceGatheringState}),this.trace("ONICECONNECTIONSTATECHANGE ICECONNECTIONSTATE",this.pc.iceConnectionState))},this.pc.onicegatheringstatechange=e=>{this.pc&&this.writePeerConnectionTimelineLog("onicegatheringstatechange",{connectionState:this.pc.connectionState,iceConnectionState:this.pc.iceConnectionState,iceGatheringState:this.pc.iceGatheringState})},this.pc.onconnectionstatechange=e=>{this.pc&&this.writePeerConnectionTimelineLog("onconnectionstatechange",{connectionState:this.pc.connectionState,iceConnectionState:this.pc.iceConnectionState,iceGatheringState:this.pc.iceGatheringState})},this.pc.ondatachannel=e=>{this.onDataChannel(e)}}async setRemoteDescription(e){if(!this.pc)return;let t=this.processOfferSdp(e.sdp),i=new RTCSessionDescription({type:"offer",sdp:t});await this.pc.setRemoteDescription(i),this.writePeerConnectionTimelineLog("set-remote-description",i)}async createAnswer(e){if(!this.pc)return;for(let e of Object.values(this.mids)){let t=this.pc.getTransceivers().find(t=>t.mid===e);t&&"recvonly"===t.direction&&(t.direction="sendrecv")}if(this.options.simulcast&&("sendrecv"===this.role||"sendonly"===this.role)){let t=this.pc.getTransceivers().find(e=>{if(null!==e.mid&&null!==e.sender.track&&(null===e.currentDirection||"sendonly"===e.currentDirection)&&(""!==this.mids.video&&this.mids.video===e.mid||0<=e.mid.indexOf("video")))return e});if(t){await this.setSenderParameters(t,this.encodings),await this.setRemoteDescription(e),this.trace("TRANSCEIVER SENDER GET_PARAMETERS",t.sender.getParameters()),await this.setSenderParameters(t,this.encodings);let i=await this.pc.createAnswer();await this.pc.setLocalDescription(i),this.trace("TRANSCEIVER SENDER GET_PARAMETERS",t.sender.getParameters());return}}let t=await this.pc.createAnswer();this.writePeerConnectionTimelineLog("create-answer",t),await this.pc.setLocalDescription(t),this.writePeerConnectionTimelineLog("set-local-description",t)}processOfferSdp(e){let t=e;return"firefox"===et()&&(t=t.replace(/^m=(audio|video) 0 /gm,(e,t)=>`m=${t} 9 `)),t}async setupSenderTransform(e){if(null===this.e2ee||null===e.track||this.senderStreamInitialized.has(e)||"transform"in RTCRtpSender.prototype)return;let t=e.createEncodedStreams(),i=t.readable;this.e2ee.setupSenderTransform(i,t.writable),this.senderStreamInitialized.add(e)}async setupReceiverTransform(e,t){if(null===this.e2ee||"transform"in RTCRtpSender.prototype)return;let i=t.createEncodedStreams(),n=i.writable;this.e2ee.setupReceiverTransform(i.readable,n)}sendAnswer(){if(this.pc&&this.ws&&this.pc.localDescription){this.trace("ANSWER SDP",this.pc.localDescription.sdp);let e={type:"answer",sdp:this.pc.localDescription.sdp};this.ws.send(JSON.stringify(e)),this.writeWebSocketSignalingLog("send-answer",e)}}onIceCandidate(){return new Promise((e,t)=>{this.pc&&(this.pc.oniceconnectionstatechange=t=>{this.pc&&(this.writePeerConnectionTimelineLog("oniceconnectionstatechange",{connectionState:this.pc.connectionState,iceConnectionState:this.pc.iceConnectionState,iceGatheringState:this.pc.iceGatheringState}),this.trace("ONICECONNECTIONSTATECHANGE ICECONNECTIONSTATE",this.pc.iceConnectionState),"connected"===this.pc.iceConnectionState&&e())},this.pc.onicecandidate=t=>{if(this.writePeerConnectionTimelineLog("onicecandidate",t.candidate),this.pc&&this.trace("ONICECANDIDATE ICEGATHERINGSTATE",this.pc.iceGatheringState),null===t.candidate)e();else{let e=Object.assign(t.candidate.toJSON(),{type:"candidate"});this.trace("ONICECANDIDATE CANDIDATE MESSAGE",e),this.sendSignalingMessage(e)}})})}waitChangeConnectionStateConnected(){return new Promise((e,t)=>{if(this.pc&&void 0===this.pc.connectionState){e();return}let i=setInterval(()=>{if(this.pc)this.pc&&"connected"===this.pc.connectionState&&(clearInterval(i),e());else{let e=Error();e.message="PeerConnection connectionState did not change to 'connected'",clearInterval(i),t(e)}},10)})}monitorSignalingWebSocketEvent(){return new Promise((e,t)=>{this.monitorSignalingWebSocketEventTimerId=setInterval(()=>{this.ws&&(this.clearMonitorSignalingWebSocketEvent(),this.ws.onclose=e=>{let i=new ea(`Signaling failed. CloseEventCode:${e.code} CloseEventReason:'${e.reason}'`);i.code=e.code,i.reason=e.reason,this.writeWebSocketTimelineLog("onclose",i),this.signalingTerminate(),t(i)},this.ws.onerror=e=>{let i=new ea("Signaling failed. WebSocket onerror was called");this.writeWebSocketSignalingLog("onerror",i),this.signalingTerminate(),t(i)})},100)})}monitorWebSocketEvent(){this.ws&&(this.ws.onclose=async e=>{this.writeWebSocketTimelineLog("onclose",{code:e.code,reason:e.reason}),await this.abend("WEBSOCKET-ONCLOSE",{code:e.code,reason:e.reason})},this.ws.onerror=async e=>{this.writeWebSocketSignalingLog("onerror"),await this.abend("WEBSOCKET-ONERROR")})}monitorPeerConnectionState(){this.pc&&(this.pc.oniceconnectionstatechange=e=>{this.pc&&void 0===this.pc.connectionState&&(this.writePeerConnectionTimelineLog("oniceconnectionstatechange",{connectionState:this.pc.connectionState,iceConnectionState:this.pc.iceConnectionState,iceGatheringState:this.pc.iceGatheringState}),this.trace("ONICECONNECTIONSTATECHANGE ICECONNECTIONSTATE",this.pc.iceConnectionState),clearTimeout(this.monitorIceConnectionStateChangeTimerId),"failed"===this.pc.iceConnectionState?this.abendPeerConnectionState("ICE-CONNECTION-STATE-FAILED"):"disconnected"===this.pc.iceConnectionState&&(this.monitorIceConnectionStateChangeTimerId=setTimeout(()=>{this.pc&&"disconnected"===this.pc.iceConnectionState&&this.abendPeerConnectionState("ICE-CONNECTION-STATE-DISCONNECTED-TIMEOUT")},1e4)))},this.pc.onconnectionstatechange=e=>{this.pc&&(this.writePeerConnectionTimelineLog("onconnectionstatechange",{connectionState:this.pc.connectionState,iceConnectionState:this.pc.iceConnectionState,iceGatheringState:this.pc.iceGatheringState}),"failed"===this.pc.connectionState&&this.abendPeerConnectionState("CONNECTION-STATE-FAILED"))})}setConnectionTimeout(){return new Promise((e,t)=>{0<this.connectionTimeout&&(this.connectionTimeoutTimerId=setTimeout(()=>{if(!this.pc||this.pc&&void 0!==this.pc.connectionState&&"connected"!==this.pc.connectionState){let e=Error();e.message="Signaling connection timeout",this.callbacks.timeout(),this.trace("DISCONNECT","Signaling connection timeout"),this.writePeerConnectionTimelineLog("signaling-connection-timeout",{connectionTimeout:this.connectionTimeout}),this.signalingTerminate(),t(e)}},this.connectionTimeout))})}clearConnectionTimeout(){clearTimeout(this.connectionTimeoutTimerId)}clearMonitorSignalingWebSocketEvent(){clearInterval(this.monitorSignalingWebSocketEventTimerId)}clearMonitorIceConnectionStateChange(){clearInterval(this.monitorIceConnectionStateChangeTimerId)}trace(e,t){this.callbacks.log(e,t),this.debug&&function(e,t,i){let n=e=>{if(e&&"object"==typeof e){let t=null;try{t=Object.keys(JSON.parse(JSON.stringify(e)))}catch(e){}t&&Array.isArray(t)?t.filter(t=>{console.group(t),n(e[t]),console.groupEnd()}):console.info(e)}else console.info(e)},a="";window.performance&&(a=`[${(window.performance.now()/1e3).toFixed(3)}]`),e&&(a=`${a}[${e}]`),void 0!==console.info&&void 0!==console.group?(console.group(`${a} ${t}`),n(i),console.groupEnd()):console.log(`${a} ${t}
`,i)}(this.clientId,e,t)}writeWebSocketSignalingLog(e,t){this.callbacks.signaling(es(e,t,"websocket")),this.writeWebSocketTimelineLog(e,t)}writeDataChannelSignalingLog(e,t,i){this.callbacks.signaling(es(e,i,"datachannel")),this.writeDataChannelTimelineLog(e,t,i)}writeWebSocketTimelineLog(e,t){let i=eo(e,t,"websocket");this.callbacks.timeline(i)}writeDataChannelTimelineLog(e,t,i){let n=eo(e,i,"datachannel",t.id,t.label);this.callbacks.timeline(n)}writePeerConnectionTimelineLog(e,t){let i=eo(e,t,"peerconnection");this.callbacks.timeline(i)}writeSoraTimelineLog(e,t){let i=eo(e,t,"sora");this.callbacks.timeline(i)}async createOffer(){let e=new window.RTCPeerConnection({iceServers:[]});if("safari"===et()){e.addTransceiver("video",{direction:"recvonly"}),e.addTransceiver("audio",{direction:"recvonly"});let t=await e.createOffer();return e.close(),this.writePeerConnectionTimelineLog("create-offer",t),t}let t=await e.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});return e.close(),this.writePeerConnectionTimelineLog("create-offer",t),t}signalingOnMessageE2EE(e){if(this.e2ee){let t=new Uint8Array(e),i=this.e2ee.receiveMessage(t);this.e2ee.postRemoteSecretKeyMaterials(i),i.messages.filter(e=>{this.sendE2EEMessage(e.buffer)})}}signalingOnMessageTypeOffer(e){if(this.clientId=e.client_id,this.connectionId=e.connection_id,void 0!==e.session_id&&(this.sessionId=e.session_id),void 0!==e.metadata&&(this.authMetadata=e.metadata),Array.isArray(e.encodings)&&(this.encodings=e.encodings),void 0!==e.mid&&void 0!==e.mid.audio&&(this.mids.audio=e.mid.audio),void 0!==e.mid&&void 0!==e.mid.video&&(this.mids.video=e.mid.video),e.data_channels)for(let t of e.data_channels)this.signalingOfferMessageDataChannels[t.label]=t;this.trace("SIGNALING OFFER MESSAGE",e),this.trace("OFFER SDP",e.sdp)}sendUpdateAnswer(){this.pc&&this.ws&&this.pc.localDescription&&(this.trace("ANSWER SDP",this.pc.localDescription.sdp),this.sendSignalingMessage({type:"update",sdp:this.pc.localDescription.sdp}))}sendReAnswer(){this.pc?.localDescription&&(this.trace("RE ANSWER SDP",this.pc.localDescription.sdp),this.sendSignalingMessage({type:"re-answer",sdp:this.pc.localDescription.sdp}))}async signalingOnMessageTypeUpdate(e){this.trace("SIGNALING UPDATE MESSGE",e),this.trace("UPDATE SDP",e.sdp),await this.setRemoteDescription(e),await this.createAnswer(e),this.sendUpdateAnswer()}async signalingOnMessageTypeReOffer(e){this.trace("SIGNALING RE OFFER MESSGE",e),this.trace("RE OFFER SDP",e.sdp),await this.setRemoteDescription(e),await this.createAnswer(e),this.sendReAnswer()}async signalingOnMessageTypePing(e){let t={type:"pong"};if(e.stats){let e=await this.getStats();t.stats=e}this.ws&&this.ws.send(JSON.stringify(t))}signalingOnMessageTypeNotify(e,t){if("connection.created"===e.event_type){let t=e.connection_id;if(this.connectionId!==t){let i=en(ei(e));if(i&&this.e2ee&&t){let e=this.e2ee.startSession(t,i);this.e2ee.postRemoteSecretKeyMaterials(e),e.messages.filter(e=>{this.sendE2EEMessage(e.buffer)}),this.e2ee.postSelfSecretKeyMaterial(e.selfConnectionId,e.selfKeyId,e.selfSecretKeyMaterial)}}(e.data&&Array.isArray(e.data)?e.data:e.metadata_list&&Array.isArray(e.metadata_list)?e.metadata_list:[]).filter(e=>{let t=en(ei(e)),i=e.connection_id;i&&this.e2ee&&t&&this.e2ee.addPreKeyBundle(i,t)})}else if("connection.destroyed"===e.event_type){let t=en(ei(e)),i=e.connection_id;if(t&&this.e2ee&&i){let e=this.e2ee.stopSession(i);this.e2ee.postSelfSecretKeyMaterial(e.selfConnectionId,e.selfKeyId,e.selfSecretKeyMaterial,5e3),e.messages.filter(e=>{this.sendE2EEMessage(e.buffer)}),this.e2ee.postRemoveRemoteDeriveKey(i)}}this.callbacks.notify(e,t)}signalingOnMessageTypeSwitched(e){if(this.signalingSwitched=!0,this.ws)for(let t of(e.ignore_disconnect_websocket&&(this.ws&&(this.ws.onclose=null,this.ws.close(),this.ws=null),this.writeWebSocketSignalingLog("close")),this.datachannels))this.callbacks.datachannel(function(e){let t=new Event("datachannel");return t.datachannel=e,t}(t))}async signalingOnMessageTypeRedirect(e){this.ws&&(this.ws.onclose=null,this.ws.onerror=null,this.ws.close(),this.ws=null);let t=await this.getSignalingWebSocket(e.location);return await this.signaling(t,!0)}async setSenderParameters(e,t){let i=e.sender.getParameters();i.encodings=t,await e.sender.setParameters(i),this.trace("TRANSCEIVER SENDER SET_PARAMETERS",i),this.writePeerConnectionTimelineLog("transceiver-sender-set-parameters",i)}async getStats(){let e=[];return this.pc&&(await this.pc.getStats()).forEach(t=>{e.push(t)}),e}onDataChannel(e){let t=e.channel;t.bufferedAmountLowThreshold=65536,t.binaryType="arraybuffer",this.soraDataChannels[t.label]=t,this.writeDataChannelTimelineLog("ondatachannel",t,{binaryType:t.binaryType,bufferedAmount:t.bufferedAmount,bufferedAmountLowThreshold:t.bufferedAmountLowThreshold,id:t.id,label:t.label,maxPacketLifeTime:t.maxPacketLifeTime,maxRetransmits:t.maxRetransmits,negotiated:t.negotiated,ordered:t.ordered,protocol:t.protocol,readyState:t.readyState,reliable:t.reliable}),e.channel.onbufferedamountlow=e=>{let t=e.currentTarget;this.writeDataChannelTimelineLog("onbufferedamountlow",t)},e.channel.onopen=e=>{let t=e.currentTarget;this.trace("OPEN DATA CHANNEL",t.label),"signaling"===t.label&&this.ws?this.writeDataChannelSignalingLog("onopen",t):this.writeDataChannelTimelineLog("onopen",t)},e.channel.onclose=async e=>{let t=e.currentTarget;this.writeDataChannelTimelineLog("onclose",t),this.trace("CLOSE DATA CHANNEL",t.label),await this.disconnect()},e.channel.onerror=async e=>{let t=e.currentTarget;this.writeDataChannelTimelineLog("onerror",t),this.trace("ERROR DATA CHANNEL",t.label),await this.abend("DATA-CHANNEL-ONERROR",{params:{label:t.label}})},"signaling"===e.channel.label?e.channel.onmessage=async e=>{let t=e.currentTarget,i=t.label,n=this.signalingOfferMessageDataChannels[i];if(!n){console.warn(`Received onmessage event for '${i}' DataChannel. But '${i}' DataChannel settings doesn't exist`);return}let a=JSON.parse(el(e.data,n.compress));this.writeDataChannelSignalingLog(`onmessage-${a.type}`,t,a),"re-offer"===a.type&&await this.signalingOnMessageTypeReOffer(a)}:"notify"===e.channel.label?e.channel.onmessage=e=>{let t=e.currentTarget,i=t.label,n=this.signalingOfferMessageDataChannels[i];if(!n){console.warn(`Received onmessage event for '${i}' DataChannel. But '${i}' DataChannel settings doesn't exist`);return}let a=JSON.parse(el(e.data,n.compress));"connection.created"===a.event_type?this.writeDataChannelTimelineLog("notify-connection.created",t,a):"connection.destroyed"===a.event_type&&this.writeDataChannelTimelineLog("notify-connection.destroyed",t,a),this.signalingOnMessageTypeNotify(a,"datachannel")}:"push"===e.channel.label?e.channel.onmessage=e=>{let t=e.currentTarget.label,i=this.signalingOfferMessageDataChannels[t];if(!i){console.warn(`Received onmessage event for '${t}' DataChannel. But '${t}' DataChannel settings doesn't exist`);return}let n=JSON.parse(el(e.data,i.compress));this.callbacks.push(n,"datachannel")}:"e2ee"===e.channel.label?e.channel.onmessage=e=>{let t=e.currentTarget,i=e.data;this.signalingOnMessageE2EE(i),this.writeDataChannelSignalingLog("onmessage-e2ee",t,i)}:"stats"===e.channel.label?e.channel.onmessage=async e=>{let t=e.currentTarget.label,i=this.signalingOfferMessageDataChannels[t];if(!i){console.warn(`Received onmessage event for '${t}' DataChannel. But '${t}' DataChannel settings doesn't exist`);return}if("req-stats"===JSON.parse(el(e.data,i.compress)).type){let e=await this.getStats();this.sendStatsMessage(e)}}:/^#.*/.exec(e.channel.label)&&(e.channel.onmessage=e=>{let t;if(null===e.currentTarget)return;let i=e.currentTarget.label,n=this.signalingOfferMessageDataChannels[i];if(!n){console.warn(`Received onmessage event for '${i}' DataChannel. But '${i}' DataChannel settings doesn't exist`);return}let a=e.target;"string"==typeof e.data?t=new TextEncoder().encode(e.data):e.data instanceof ArrayBuffer?t=e.data:console.warn("Received onmessage event data is not of type String or ArrayBuffer."),void 0!==t&&(!0===n.compress&&(t=$(new Uint8Array(t)).buffer),this.callbacks.message(function(e,t){let i=new Event("message");return i.label=e,i.data=t,i}(a.label,t)))})}sendSignalingMessage(e){if(this.soraDataChannels.signaling){if(this.signalingOfferMessageDataChannels.signaling&&!0===this.signalingOfferMessageDataChannels.signaling.compress){let t=q(new TextEncoder().encode(JSON.stringify(e)),{});this.soraDataChannels.signaling.send(t)}else this.soraDataChannels.signaling.send(JSON.stringify(e));this.writeDataChannelSignalingLog(`send-${e.type}`,this.soraDataChannels.signaling,e)}else null!==this.ws&&(this.ws.send(JSON.stringify(e)),this.writeWebSocketSignalingLog(`send-${e.type}`,e))}sendE2EEMessage(e){this.soraDataChannels.e2ee?(this.soraDataChannels.e2ee.send(e),this.writeDataChannelSignalingLog("send-e2ee",this.soraDataChannels.e2ee,e)):null!==this.ws&&(this.ws.send(e),this.writeWebSocketSignalingLog("send-e2ee",e))}sendStatsMessage(e){if(this.soraDataChannels.stats){let t={type:"stats",reports:e};if(this.signalingOfferMessageDataChannels.stats&&!0===this.signalingOfferMessageDataChannels.stats.compress){let e=q(new TextEncoder().encode(JSON.stringify(t)),{});this.soraDataChannels.stats.send(e)}else this.soraDataChannels.stats.send(JSON.stringify(t))}}getAudioTransceiver(){return this.pc&&this.mids.audio&&this.pc.getTransceivers().find(e=>e.mid===this.mids.audio)||null}getVideoTransceiver(){return this.pc&&this.mids.video&&this.pc.getTransceivers().find(e=>e.mid===this.mids.video)||null}soraCloseEvent(e,t,i){return new class extends Event{constructor(e,t,i){super(e),i&&(i.code&&(this.code=i.code),i.reason&&(this.reason=i.reason),i.params&&(this.params=i.params)),this.title=t}}(e,t,i)}sendMessage(e,t){let i=this.soraDataChannels[e];if(null===this.pc)return;if(void 0===i)throw Error("Could not find DataChannel");if("open"!==i.readyState)throw Error("Messaging DataChannel is not open");let n=this.signalingOfferMessageDataChannels[e];if(void 0!==n&&!0===n.compress){let e=q(t,{});i.send(e)}else i.send(t)}get e2eeSelfFingerprint(){if(this.options.e2ee&&this.e2ee)return this.e2ee.selfFingerprint()}get e2eeRemoteFingerprints(){if(this.options.e2ee&&this.e2ee)return this.e2ee.remoteFingerprints()}get audio(){return null!==this.getAudioTransceiver()}get video(){return null!==this.getVideoTransceiver()}get signalingUrl(){return this.signalingUrlCandidates}get datachannels(){if(!this.signalingSwitched)return[];let e=Object.keys(this.signalingOfferMessageDataChannels).filter(e=>/^#.*/.exec(e)),t=[];for(let i of e){let e=this.soraDataChannels[i];if(!e)continue;let n=this.signalingOfferMessageDataChannels[i];if(!n)continue;let a={label:e.label,ordered:e.ordered,protocol:e.protocol,compress:n.compress,direction:n.direction};"number"==typeof e.maxPacketLifeTime&&(a.maxPacketLifeTime=e.maxPacketLifeTime),"number"==typeof e.maxRetransmits&&(a.maxRetransmits=e.maxRetransmits),t.push(a)}return t}}class eg extends er{async connect(e){return!1===this.options.multistream?await Promise.race([this.legacyStream(e).finally(()=>{this.clearConnectionTimeout(),this.clearMonitorSignalingWebSocketEvent()}),this.setConnectionTimeout(),this.monitorSignalingWebSocketEvent()]):await Promise.race([this.multiStream(e).finally(()=>{this.clearConnectionTimeout(),this.clearMonitorSignalingWebSocketEvent()}),this.setConnectionTimeout(),this.monitorSignalingWebSocketEvent()]),this.monitorWebSocketEvent(),this.monitorPeerConnectionState(),e}async legacyStream(e){await this.disconnect(),this.setupE2EE();let t=await this.getSignalingWebSocket(this.signalingUrlCandidates),i=await this.signaling(t);if(this.startE2EE(),await this.connectPeerConnection(i),await this.setRemoteDescription(i),e.getTracks().filter(t=>{this.pc&&this.pc.addTrack(t,e)}),this.pc)for(let e of this.pc.getSenders())await this.setupSenderTransform(e);return this.stream=e,await this.createAnswer(i),this.sendAnswer(),await this.onIceCandidate(),await this.waitChangeConnectionStateConnected(),e}async multiStream(e){await this.disconnect(),this.setupE2EE();let t=await this.getSignalingWebSocket(this.signalingUrlCandidates),i=await this.signaling(t);if(this.startE2EE(),await this.connectPeerConnection(i),this.pc&&(this.pc.ontrack=async e=>{await this.setupReceiverTransform(e.transceiver.mid,e.receiver);let t=e.streams[0];if(!t)return;let i={"stream.id":t.id,id:e.track.id,label:e.track.label,enabled:e.track.enabled,kind:e.track.kind,muted:e.track.muted,readyState:e.track.readyState};this.writePeerConnectionTimelineLog("ontrack",i),"default"!==t.id&&t.id!==this.connectionId&&(this.callbacks.track(e),t.onremovetrack=e=>{if(this.callbacks.removetrack(e),e.target){let t=this.remoteConnectionIds.indexOf(e.target.id);-1<t&&(delete this.remoteConnectionIds[t],e.stream=e.target,this.callbacks.removestream(e))}},-1<this.remoteConnectionIds.indexOf(t.id)||(e.stream=t,this.remoteConnectionIds.push(t.id),this.callbacks.addstream(e)))}),await this.setRemoteDescription(i),e.getTracks().filter(t=>{this.pc&&this.pc.addTrack(t,e)}),this.pc)for(let e of this.pc.getSenders())await this.setupSenderTransform(e);return this.stream=e,await this.createAnswer(i),this.sendAnswer(),await this.onIceCandidate(),await this.waitChangeConnectionStateConnected(),e}}class ec extends er{async connect(){if(!1===this.options.multistream){let e=await Promise.race([this.legacyStream().finally(()=>{this.clearConnectionTimeout(),this.clearMonitorSignalingWebSocketEvent()}),this.setConnectionTimeout(),this.monitorSignalingWebSocketEvent()]);return this.monitorWebSocketEvent(),this.monitorPeerConnectionState(),e}await Promise.race([this.multiStream().finally(()=>{this.clearConnectionTimeout(),this.clearMonitorSignalingWebSocketEvent()}),this.setConnectionTimeout(),this.monitorSignalingWebSocketEvent()]),this.monitorWebSocketEvent(),this.monitorPeerConnectionState()}async legacyStream(){await this.disconnect(),this.setupE2EE();let e=await this.getSignalingWebSocket(this.signalingUrlCandidates),t=await this.signaling(e);return this.startE2EE(),await this.connectPeerConnection(t),this.pc&&(this.pc.ontrack=async e=>{await this.setupReceiverTransform(e.transceiver.mid,e.receiver),this.stream=e.streams[0];let t=this.stream.id;if("default"===t)return;let i={"stream.id":t,id:e.track.id,label:e.track.label,enabled:e.track.enabled,kind:e.track.kind,muted:e.track.muted,readyState:e.track.readyState};this.writePeerConnectionTimelineLog("ontrack",i),this.callbacks.track(e),this.stream.onremovetrack=e=>{if(this.callbacks.removetrack(e),e.target){let t=e.target.id,i=this.remoteConnectionIds.indexOf(t);-1<i&&(delete this.remoteConnectionIds[i],e.stream=e.target,this.callbacks.removestream(e))}},-1<this.remoteConnectionIds.indexOf(t)||(e.stream=this.stream,this.remoteConnectionIds.push(t),this.callbacks.addstream(e))}),await this.setRemoteDescription(t),await this.createAnswer(t),this.sendAnswer(),await this.onIceCandidate(),await this.waitChangeConnectionStateConnected(),this.stream||new MediaStream}async multiStream(){await this.disconnect(),this.setupE2EE();let e=await this.getSignalingWebSocket(this.signalingUrlCandidates),t=await this.signaling(e);this.startE2EE(),await this.connectPeerConnection(t),this.pc&&(this.pc.ontrack=async e=>{await this.setupReceiverTransform(e.transceiver.mid,e.receiver);let t=e.streams[0];if("default"===t.id||t.id===this.connectionId)return;let i={"stream.id":t.id,id:e.track.id,label:e.track.label,enabled:e.track.enabled,kind:e.track.kind,muted:e.track.muted,readyState:e.track.readyState};this.writePeerConnectionTimelineLog("ontrack",i),this.callbacks.track(e),t.onremovetrack=e=>{if(this.callbacks.removetrack(e),e.target){let t=e.target.id,i=this.remoteConnectionIds.indexOf(t);-1<i&&(delete this.remoteConnectionIds[i],e.stream=e.target,this.callbacks.removestream(e))}},-1<this.remoteConnectionIds.indexOf(t.id)||(e.stream=t,this.remoteConnectionIds.push(t.id),this.callbacks.addstream(e))}),await this.setRemoteDescription(t),await this.createAnswer(t),this.sendAnswer(),await this.onIceCandidate(),await this.waitChangeConnectionStateConnected()}}class eC{constructor(e,t=!1){this.signalingUrlCandidates=e,this.debug=t}sendrecv(e,t=null,i={audio:!0,video:!0}){return new eg(this.signalingUrlCandidates,"sendrecv",e,t,i,this.debug)}sendonly(e,t=null,i={audio:!0,video:!0}){return new eg(this.signalingUrlCandidates,"sendonly",e,t,i,this.debug)}recvonly(e,t=null,i={audio:!0,video:!0}){return new ec(this.signalingUrlCandidates,"recvonly",e,t,i,this.debug)}get signalingUrl(){return this.signalingUrlCandidates}}var ed={initE2EE:async e=>{await a.loadWasm(e)},connection:(e,t=!1)=>new eC(e,t),version:()=>"2024.1.0-canary.0",helpers:{applyMediaStreamConstraints:s}}}}]);