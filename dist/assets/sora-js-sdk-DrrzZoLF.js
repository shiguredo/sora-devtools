/**
 * sora-js-sdk
 * WebRTC SFU Sora JavaScript SDK
 * @version: 2025.1.0-canary.8
 * @author: Shiguredo Inc.
 * @license: Apache-2.0
 **/async function R(c,e){if(e.audio&&typeof e.audio!="boolean")for(const n of c.getAudioTracks())await n.applyConstraints(e.audio);if(e.video&&typeof e.video!="boolean")for(const n of c.getVideoTracks())await n.applyConstraints(e.video)}const m="websocket",M="datachannel",y="sendrecv",b="sendonly",W="recvonly",x="redirect",v="offer",_="answer",U="candidate",G="switched",$="ping",J="pong",j="req-stats",V="stats",F="close",O="re-offer",B="re-answer",w="disconnect",H="notify",z="push",E="update",K="signaling",q="push",Y="notify",Q="stats";class X extends Error{constructor(){super("DISCONNECT-WAIT-TIMEOUT-ERROR")}}class Z extends Error{constructor(){super("DISCONNECT-INTERNAL-ERROR")}}class ee extends Error{constructor(){super("DISCONNECT-DATA-CHANNEL-ERROR")}}function N(){const c=window.navigator.userAgent.toLocaleLowerCase();return c.indexOf("edge")!==-1?"edge":c.indexOf("chrome")!==-1&&c.indexOf("edge")===-1?"chrome":c.indexOf("safari")!==-1&&c.indexOf("chrome")===-1?"safari":c.indexOf("opera")!==-1?"opera":c.indexOf("firefox")!==-1?"firefox":null}function ne(){const c=["urn:ietf:params:rtp-hdrext:sdes:mid","urn:ietf:params:rtp-hdrext:sdes:rtp-stream-id","urn:ietf:params:rtp-hdrext:sdes:repaired-rtp-stream-id"];if(!window.RTCRtpSender||!RTCRtpSender.getCapabilities)return!1;const e=RTCRtpSender.getCapabilities("video");if(!e)return!1;const n=e.headerExtensions.map(i=>i.uri);return c.every(i=>n.includes(i))}function te(c){if(typeof c!="object"||c===null)throw new Error("Failed to parse options dataChannels. Options dataChannels element must be type 'object'");const e=c,n={};return typeof e.label=="string"&&(n.label=e.label),typeof e.direction=="string"&&(n.direction=e.direction),typeof e.ordered=="boolean"&&(n.ordered=e.ordered),typeof e.compress=="boolean"&&(n.compress=e.compress),typeof e.maxPacketLifeTime=="number"&&(n.max_packet_life_time=e.maxPacketLifeTime),typeof e.maxRetransmits=="number"&&(n.max_retransmits=e.maxRetransmits),typeof e.protocol=="string"&&(n.protocol=e.protocol),Array.isArray(e.header)&&(n.header=e.header),n}function ie(c){const e=[];for(const n of c)e.push(te(n));return e}function se(){return N()==="safari"}function ae(){return N()==="firefox"}function oe(c,e,n,i,t,o){if(e!=="sendrecv"&&e!=="sendonly"&&e!=="recvonly")throw new Error("Unknown role type");if(n==null)throw new Error("channelId can not be null or undefined");const s={type:"connect",sora_client:"Sora JavaScript SDK 2025.1.0-canary.8",environment:window.navigator.userAgent,role:e,channel_id:n,sdp:c,audio:!0,video:!0};o===!0&&(s.redirect=!0),typeof t.simulcast=="boolean"&&(s.simulcast=t.simulcast);const a=["r0","r1","r2"];t.simulcastRid!==void 0&&0<=a.indexOf(t.simulcastRid)&&(s.simulcast_rid=t.simulcastRid),typeof t.spotlight=="boolean"&&(s.spotlight=t.spotlight),"spotlightNumber"in t&&(s.spotlight_number=t.spotlightNumber);const l=["none","r0","r1","r2"];t.spotlightFocusRid!==void 0&&0<=l.indexOf(t.spotlightFocusRid)&&(s.spotlight_focus_rid=t.spotlightFocusRid),t.spotlightUnfocusRid!==void 0&&0<=l.indexOf(t.spotlightUnfocusRid)&&(s.spotlight_unfocus_rid=t.spotlightUnfocusRid),i!==void 0&&(s.metadata=i),t.signalingNotifyMetadata!==void 0&&(s.signaling_notify_metadata=t.signalingNotifyMetadata),t.forwardingFilters!==void 0&&(s.forwarding_filters=t.forwardingFilters),t.forwardingFilter!==void 0&&(s.forwarding_filter=t.forwardingFilter),t.clientId!==void 0&&(s.client_id=t.clientId),t.bundleId!==void 0&&(s.bundle_id=t.bundleId),typeof t.dataChannelSignaling=="boolean"&&(s.data_channel_signaling=t.dataChannelSignaling),typeof t.ignoreDisconnectWebSocket=="boolean"&&(s.ignore_disconnect_websocket=t.ignoreDisconnectWebSocket);const h=["audioCodecType","audioBitRate"],u=["audioOpusParamsChannels","audioOpusParamsMaxplaybackrate","audioOpusParamsStereo","audioOpusParamsSpropStereo","audioOpusParamsMinptime","audioOpusParamsPtime","audioOpusParamsUseinbandfec","audioOpusParamsUsedtx"],T=["videoCodecType","videoBitRate","videoVP9Params","videoH264Params","videoH265Params","videoAV1Params"],r=Object.assign({},t);Object.keys(r).filter(d=>{d==="audio"&&typeof r[d]=="boolean"||d==="video"&&typeof r[d]=="boolean"||0<=h.indexOf(d)&&r[d]!==null||0<=u.indexOf(d)&&r[d]!==null||0<=T.indexOf(d)&&r[d]!==null||delete r[d]}),r.audio!==void 0&&(s.audio=r.audio);const A=Object.keys(r).some(d=>0<=h.indexOf(d));s.audio&&A&&(s.audio={},"audioCodecType"in r&&(s.audio.codec_type=r.audioCodecType),"audioBitRate"in r&&(s.audio.bit_rate=r.audioBitRate));const P=Object.keys(r).some(d=>0<=u.indexOf(d));s.audio&&P&&(typeof s.audio!="object"&&(s.audio={}),s.audio.opus_params={},"audioOpusParamsChannels"in r&&(s.audio.opus_params.channels=r.audioOpusParamsChannels),"audioOpusParamsMaxplaybackrate"in r&&(s.audio.opus_params.maxplaybackrate=r.audioOpusParamsMaxplaybackrate),"audioOpusParamsStereo"in r&&(s.audio.opus_params.stereo=r.audioOpusParamsStereo),"audioOpusParamsSpropStereo"in r&&(s.audio.opus_params.sprop_stereo=r.audioOpusParamsSpropStereo),"audioOpusParamsMinptime"in r&&(s.audio.opus_params.minptime=r.audioOpusParamsMinptime),"audioOpusParamsPtime"in r&&(s.audio.opus_params.ptime=r.audioOpusParamsPtime),"audioOpusParamsUseinbandfec"in r&&(s.audio.opus_params.useinbandfec=r.audioOpusParamsUseinbandfec),"audioOpusParamsUsedtx"in r&&(s.audio.opus_params.usedtx=r.audioOpusParamsUsedtx)),r.video!==void 0&&(s.video=r.video);const L=Object.keys(r).some(d=>0<=T.indexOf(d));if(s.video&&L&&(s.video={},"videoCodecType"in r&&(s.video.codec_type=r.videoCodecType),"videoBitRate"in r&&(s.video.bit_rate=r.videoBitRate),"videoVP9Params"in r&&(s.video.vp9_params=r.videoVP9Params),"videoH264Params"in r&&(s.video.h264_params=r.videoH264Params),"videoH265Params"in r&&(s.video.h265_params=r.videoH265Params),"videoAV1Params"in r&&(s.video.av1_params=r.videoAV1Params)),s.simulcast&&!ne()&&e!=="recvonly")throw new Error("Simulcast can not be used with this browser");return Array.isArray(t.dataChannels)&&0<t.dataChannels.length&&(s.data_channels=ie(t.dataChannels)),t.audioStreamingLanguageCode!==void 0&&(s.audio_streaming_language_code=t.audioStreamingLanguageCode),s}function ce(c,e,n){const i=o=>{if(o&&typeof o=="object"){let s=null;try{s=Object.keys(JSON.parse(JSON.stringify(o)))}catch{}s&&Array.isArray(s)?s.filter(a=>{console.group(a),i(o[a]),console.groupEnd()}):console.info(o)}else console.info(o)};let t="";window.performance&&(t=`[${(window.performance.now()/1e3).toFixed(3)}]`),c&&(t=`${t}[${c}]`),console.info!==void 0&&console.group!==void 0?(console.group(`${t} ${e}`),i(n),console.groupEnd()):console.log(`${t} ${e}
`,n)}class g extends Error{code;reason}function k(c,e,n){const i=new Event(c);try{i.data=JSON.parse(JSON.stringify(e))}catch{i.data=e}return i.transportType=n,i}function re(c){return{binaryType:c.binaryType,bufferedAmount:c.bufferedAmount,bufferedAmountLowThreshold:c.bufferedAmountLowThreshold,id:c.id,label:c.label,maxPacketLifeTime:c.maxPacketLifeTime,maxRetransmits:c.maxRetransmits,negotiated:c.negotiated,ordered:c.ordered,protocol:c.protocol,readyState:c.readyState,reliable:c.reliable}}function f(c,e,n,i,t){const o=new Event(c);try{o.data=JSON.parse(JSON.stringify(e))}catch{o.data=e}return o.logType=n,o.dataChannelId=i,o.dataChannelLabel=t,o}function le(c,e){const n=new Event("message");return n.label=c,n.data=e,n}function de(c){const e=new Event("datachannel");return e.datachannel=c,e}async function C(c,e){if(e){const n=await I(new Uint8Array(c));return new TextDecoder().decode(n)}return c}const p=async c=>{const e=new Blob([c]).stream().pipeThrough(new CompressionStream("deflate"));return await new Response(e).arrayBuffer()},I=async c=>{const e=new Blob([c]).stream().pipeThrough(new DecompressionStream("deflate"));return await new Response(e).arrayBuffer()};function he(c){const e=c.match(/^(v=.+?)(m=audio.+)/ms);if(e===null)return c;const n=e[1],i=[];let t=[];for(const s of e[2].split(/\n/))s[0]==="m"?(t=[s],i.push(t)):t.push(s);const o=i.map(s=>s.join(`
`)).map(s=>!ge(s)||!ue(s)||!pe(s)||!me(s)||!fe(s)?s:Ce(s));return`${n}${o.join(`
`)}`}function ge(c){return/^m=audio/.test(c)}function ue(c){return/a=setup:active/.test(c)}function pe(c){return/a=recvonly/.test(c)}function me(c){return/a=rtpmap:\d+\sopus/.test(c)}function fe(c){return/a=fmtp:\d+/.test(c)}function Ce(c){return c.replace(/(?<!stereo=1;.*)minptime=\d+(?!.*stereo=1)/,e=>`${e};stereo=1`)}class S{role;simulcast;spotlight;channelId;metadata;signalingUrlCandidates;options;constraints;debug;bundleId;clientId;connectionId;sessionId;remoteConnectionIds;stream;authMetadata;pc;encodings;connectedSignalingUrl;contactSignalingUrl;ws;connectionTimeoutTimerId;monitorSignalingWebSocketEventTimerId;monitorIceConnectionStateChangeTimerId;soraDataChannels;connectionTimeout;signalingCandidateTimeout;disconnectWaitTimeout;mids;signalingSwitched;signalingOfferMessageDataChannels;callbacks;constructor(e,n,i,t,o,s){this.role=n,this.channelId=i,this.metadata=t,this.signalingUrlCandidates=e,this.options=o,this.options.skipIceCandidateEvent===void 0&&(this.options.skipIceCandidateEvent=!1),this.connectionTimeout=6e4,typeof this.options.timeout=="number"&&(console.warn("@deprecated timeout option will be removed in a future version. Use connectionTimeout."),this.connectionTimeout=this.options.timeout),typeof this.options.connectionTimeout=="number"&&(this.connectionTimeout=this.options.connectionTimeout),this.disconnectWaitTimeout=3e3,typeof this.options.disconnectWaitTimeout=="number"&&(this.disconnectWaitTimeout=this.options.disconnectWaitTimeout),this.signalingCandidateTimeout=3e3,typeof this.options.signalingCandidateTimeout=="number"&&(this.signalingCandidateTimeout=this.options.signalingCandidateTimeout),this.constraints=null,this.debug=s,this.simulcast=!1,this.spotlight=!1,this.sessionId=null,this.clientId=null,this.bundleId=null,this.connectionId=null,this.remoteConnectionIds=[],this.stream=null,this.ws=null,this.pc=null,this.encodings=[],this.callbacks={disconnect:()=>{},push:()=>{},track:()=>{},removetrack:()=>{},notify:()=>{},log:()=>{},timeout:()=>{},timeline:()=>{},signaling:()=>{},message:()=>{},datachannel:()=>{}},this.authMetadata=null,this.connectionTimeoutTimerId=0,this.monitorSignalingWebSocketEventTimerId=0,this.monitorIceConnectionStateChangeTimerId=0,this.soraDataChannels={},this.mids={audio:"",video:""},this.signalingSwitched=!1,this.signalingOfferMessageDataChannels={},this.connectedSignalingUrl="",this.contactSignalingUrl=""}on(e,n){e in this.callbacks&&(this.callbacks[e]=n)}stopAudioTrack(e){return console.warn("@deprecated stopAudioTrack will be removed in a future version. Use removeAudioTrack instead."),this.removeAudioTrack(e)}removeAudioTrack(e){for(const n of e.getAudioTracks())n.enabled=!1;return new Promise((n,i)=>{setTimeout(()=>{const t=e.getAudioTracks().map(async o=>{if(o.stop(),e.removeTrack(o),this.pc!==null){const s=this.pc.getSenders().find(a=>a.track&&a.track.id===o.id);if(s)return s.replaceTrack(null)}});Promise.all(t).then(()=>n()).catch(i)},100)})}stopVideoTrack(e){return console.warn("@deprecated stopVideoTrack will be removed in a future version. Use removeVideoTrack instead."),this.removeVideoTrack(e)}removeVideoTrack(e){for(const n of e.getVideoTracks())n.enabled=!1;return new Promise((n,i)=>{setTimeout(()=>{const t=e.getVideoTracks().map(async o=>{if(o.stop(),e.removeTrack(o),this.pc!==null){const s=this.pc.getSenders().find(a=>a.track&&a.track.id===o.id);if(s)return s.replaceTrack(null)}});Promise.all(t).then(()=>n()).catch(i)},100)})}async replaceAudioTrack(e,n){await this.removeAudioTrack(e);const i=this.getAudioTransceiver();if(i===null)throw new Error("Unable to set an audio track. Audio track sender is undefined");e.addTrack(n),await i.sender.replaceTrack(n)}async replaceVideoTrack(e,n){await this.removeVideoTrack(e);const i=this.getVideoTransceiver();if(i===null)throw new Error("Unable to set video track. Video track sender is undefined");e.addTrack(n),await i.sender.replaceTrack(n)}signalingTerminate(){for(const e of Object.keys(this.soraDataChannels)){const n=this.soraDataChannels[e];n&&n.close(),delete this.soraDataChannels[e]}this.ws&&(this.ws.close(),this.ws=null),this.pc&&this.pc.close(),this.initializeConnection()}abendPeerConnectionState(e){this.clearMonitorIceConnectionStateChange(),this.pc&&(this.pc.ondatachannel=null,this.pc.oniceconnectionstatechange=null,this.pc.onicegatheringstatechange=null,this.pc.onconnectionstatechange=null),this.ws&&(this.ws.onclose=i=>{this.writeWebSocketTimelineLog("onclose",{code:i.code,reason:i.reason})},this.ws.onmessage=null,this.ws.onerror=null);for(const i of Object.keys(this.soraDataChannels)){const t=this.soraDataChannels[i];t&&(t.onclose=o=>{const s=o.currentTarget;this.writeDataChannelTimelineLog("onclose",s),this.trace("CLOSE DATA CHANNEL",s.label)},t.onmessage=null,t.onerror=null)}for(const i of Object.keys(this.soraDataChannels)){const t=this.soraDataChannels[i];t&&t.close(),delete this.soraDataChannels[i]}this.ws&&(this.ws.close(),this.ws=null),this.pc&&this.pc.close(),this.initializeConnection();const n=this.soraCloseEvent("abend",e);this.callbacks.disconnect(n),this.writeSoraTimelineLog("disconnect-abend",n)}shutdown(e){this.clearMonitorIceConnectionStateChange(),this.pc&&(this.pc.ondatachannel=null,this.pc.oniceconnectionstatechange=null,this.pc.onicegatheringstatechange=null,this.pc.onconnectionstatechange=null);for(const i of Object.keys(this.soraDataChannels)){const t=this.soraDataChannels[i];t&&(t.onclose=o=>{const s=o.currentTarget;this.writeDataChannelTimelineLog("onclose",s),this.trace("CLOSE DATA CHANNEL",s.label)},t.onmessage=null,t.onerror=null,t.close()),delete this.soraDataChannels[i]}this.maybeClosePeerConnection(),this.initializeConnection();const n=this.soraCloseEvent("normal","SHUTDOWN",e);this.writeSoraTimelineLog("disconnect-normal",n),this.callbacks.disconnect(n)}async abend(e,n){this.clearMonitorIceConnectionStateChange(),this.pc&&(this.pc.ondatachannel=null,this.pc.oniceconnectionstatechange=null,this.pc.onicegatheringstatechange=null,this.pc.onconnectionstatechange=null),this.ws&&(this.ws.onclose=t=>{this.writeWebSocketTimelineLog("onclose",{code:t.code,reason:t.reason})},this.ws.onmessage=null,this.ws.onerror=null);for(const t of Object.keys(this.soraDataChannels)){const o=this.soraDataChannels[t];o&&(o.onclose=s=>{const a=s.currentTarget;this.writeDataChannelTimelineLog("onclose",a),this.trace("CLOSE DATA CHANNEL",a.label)},o.onmessage=null,o.onerror=null)}if(this.soraDataChannels.signaling){const t={type:w,reason:e};if(this.signalingOfferMessageDataChannels.signaling&&this.signalingOfferMessageDataChannels.signaling.compress===!0){const o=new TextEncoder().encode(JSON.stringify(t)),s=await p(o);if(this.soraDataChannels.signaling.readyState==="open")try{this.soraDataChannels.signaling.send(s),this.writeDataChannelSignalingLog("send-disconnect",this.soraDataChannels.signaling,t)}catch(a){const l=a.message;this.writeDataChannelSignalingLog("failed-to-send-disconnect",this.soraDataChannels.signaling,l)}}else if(this.soraDataChannels.signaling.readyState==="open")try{this.soraDataChannels.signaling.send(JSON.stringify(t)),this.writeDataChannelSignalingLog("send-disconnect",this.soraDataChannels.signaling,t)}catch(o){const s=o.message;this.writeDataChannelSignalingLog("failed-to-send-disconnect",this.soraDataChannels.signaling,s)}}for(const t of Object.keys(this.soraDataChannels)){const o=this.soraDataChannels[t];o&&(o.onerror=null,o.close()),delete this.soraDataChannels[t]}if(await this.disconnectWebSocket(e),this.maybeClosePeerConnection(),this.initializeConnection(),e==="WEBSOCKET-ONCLOSE"&&n&&(n.code===1e3||n.code===1005)){const t=this.soraCloseEvent("normal","DISCONNECT",n);this.writeSoraTimelineLog("disconnect-normal",t),this.callbacks.disconnect(t);return}const i=this.soraCloseEvent("abend",e,n);this.writeSoraTimelineLog("disconnect-abend",i),this.callbacks.disconnect(this.soraCloseEvent("abend",e,n))}initializeConnection(){this.simulcast=!1,this.spotlight=!1,this.sessionId=null,this.clientId=null,this.bundleId=null,this.connectionId=null,this.remoteConnectionIds=[],this.stream=null,this.ws=null,this.pc=null,this.encodings=[],this.authMetadata=null,this.soraDataChannels={},this.mids={audio:"",video:""},this.signalingSwitched=!1,this.signalingOfferMessageDataChannels={},this.contactSignalingUrl="",this.connectedSignalingUrl="",this.clearConnectionTimeout()}disconnectWebSocket(e){let n=0;return this.signalingSwitched?(this.ws&&(this.ws.close(),this.ws=null),Promise.resolve(null)):new Promise((i,t)=>{if(!this.ws)return i(null);if(this.ws.onclose=o=>(this.ws&&(this.ws.close(),this.ws=null),clearTimeout(n),this.writeWebSocketTimelineLog("onclose",{code:o.code,reason:o.reason}),i({code:o.code,reason:o.reason})),this.ws.readyState===1){const o={type:w,reason:e};this.ws.send(JSON.stringify(o)),this.writeWebSocketSignalingLog("send-disconnect",o),n=setTimeout(()=>{this.ws&&(this.ws.close(),this.ws=null),i({code:1006,reason:""})},this.disconnectWaitTimeout)}else return this.ws.close(),this.ws=null,i(null)})}forceCloseDataChannels(){for(const e of Object.keys(this.soraDataChannels)){const n=this.soraDataChannels[e];n&&(n.onerror=null,n.onclose=null,n.onmessage=null,n.close())}}async disconnectDataChannel(){if(!this.soraDataChannels.signaling)return this.forceCloseDataChannels(),{code:4999,reason:new Z().message};const e=new Promise((o,s)=>{setTimeout(()=>s(new X),this.disconnectWaitTimeout)}),n=[];for(const o of Object.keys(this.soraDataChannels)){const s=this.soraDataChannels[o];s&&n.push(new Promise((a,l)=>{s.onclose=h=>{const u=h.currentTarget;this.writeDataChannelTimelineLog("onclose",u),this.trace("CLOSE DATA CHANNEL",u.label),a()},s.onerror=()=>l(new ee)}))}const i=Promise.all(n),t={type:w,reason:"NO-ERROR"};if(this.signalingOfferMessageDataChannels.signaling&&this.signalingOfferMessageDataChannels.signaling.compress===!0){const o=new TextEncoder().encode(JSON.stringify(t)),s=await p(o);if(this.soraDataChannels.signaling?.readyState&&this.soraDataChannels.signaling.readyState==="open")try{this.soraDataChannels.signaling.send(s),this.writeDataChannelSignalingLog("send-disconnect",this.soraDataChannels.signaling,t)}catch(a){const l=a.message;this.writeDataChannelSignalingLog("failed-to-send-disconnect",this.soraDataChannels.signaling,l)}}else if(this.soraDataChannels.signaling.readyState==="open")try{this.soraDataChannels.signaling.send(JSON.stringify(t)),this.writeDataChannelSignalingLog("send-disconnect",this.soraDataChannels.signaling,t)}catch(o){const s=o.message;this.writeDataChannelSignalingLog("failed-to-send-disconnect",this.soraDataChannels.signaling,s)}try{return await Promise.race([e,i]),{code:1e3,reason:"TYPE-DISCONNECT"}}catch(o){return this.forceCloseDataChannels(),{code:4999,reason:o.message}}}maybeClosePeerConnection(){this.pc&&this.pc.connectionState!=="closed"&&this.pc.close()}async disconnect(){this.clearMonitorIceConnectionStateChange(),this.pc&&(this.pc.ondatachannel=null,this.pc.oniceconnectionstatechange=null,this.pc.onicegatheringstatechange=null,this.pc.onconnectionstatechange=null),this.ws&&(this.ws.onclose=n=>{this.writeWebSocketTimelineLog("onclose",{code:n.code,reason:n.reason})},this.ws.onmessage=null,this.ws.onerror=null);let e=null;if(this.signalingSwitched){const n=await this.disconnectDataChannel();n.code===4999&&(e=this.soraCloseEvent("abend",n.reason)),e=this.soraCloseEvent("normal","DISCONNECT",n),await this.disconnectWebSocket("NO-ERROR"),this.maybeClosePeerConnection()}else{const n=await this.disconnectWebSocket("NO-ERROR");this.maybeClosePeerConnection(),this.forceCloseDataChannels(),n!==null&&(e=this.soraCloseEvent("normal","DISCONNECT",n))}this.initializeConnection(),e&&(e.type==="abend"?this.writeSoraTimelineLog("disconnect-abend",e):e.type==="normal"&&this.writeSoraTimelineLog("disconnect-normal",e),this.callbacks.disconnect(e))}async getSignalingWebSocket(e){if(Array.isArray(e)&&e.length===0)throw new g("Signaling failed. The signalingUrlCandidates array is empty.");if(typeof e=="string"||e.length===1){const n=typeof e=="string"?e:e[0];return new Promise((i,t)=>{const o=new WebSocket(n);o.onclose=s=>{const a=new g(`Signaling failed. CloseEventCode:${s.code} CloseEventReason:'${s.reason}'`);a.code=s.code,a.reason=s.reason,this.writeWebSocketTimelineLog("onclose",a),t(a)},o.onopen=s=>{i(o)}})}if(Array.isArray(e)){let n=!1;const i=t=>new Promise((o,s)=>{const a=new WebSocket(t),l=setTimeout(()=>{this.writeWebSocketSignalingLog("signaling-url-candidate",{type:"timeout",url:a.url}),a&&!n&&(a.onclose=null,a.onerror=null,a.onopen=null,a.close(),s())},this.signalingCandidateTimeout);a.onclose=h=>{this.writeWebSocketSignalingLog("signaling-url-candidate",{type:"close",url:a.url,message:"WebSocket closed",code:h.code,reason:h.reason}),a&&a.close(),clearInterval(l),s()},a.onerror=h=>{this.writeWebSocketSignalingLog("signaling-url-candidate",{type:"error",url:a.url,message:"Failed to connect WebSocket"}),a&&(a.onclose=null,a.close()),clearInterval(l),s()},a.onopen=h=>{a&&(clearInterval(l),n?(this.writeWebSocketSignalingLog("signaling-url-candidate",{type:"open",url:a.url,selected:!1}),a.onerror=null,a.onclose=null,a.onopen=null,a.close(),s()):(this.writeWebSocketSignalingLog("signaling-url-candidate",{type:"open",url:a.url,selected:!0}),a.onerror=null,a.onclose=null,a.onopen=null,n=!0,o(a)))}});try{return await Promise.any(e.map(t=>i(t)))}catch{throw new g("Signaling failed. All signaling URL candidates failed to connect")}}throw new g("Signaling failed. Invalid format signaling URL candidates")}async signaling(e,n=!1){const i=await this.createOffer();return this.trace("CREATE OFFER",i),new Promise((t,o)=>{this.writeWebSocketSignalingLog("new-websocket",e.url),e.binaryType="arraybuffer",e.onclose=s=>{const a=new g(`Signaling failed. CloseEventCode:${s.code} CloseEventReason:'${s.reason}'`);a.code=s.code,a.reason=s.reason,this.writeWebSocketTimelineLog("onclose",a),this.signalingTerminate(),o(a)},e.onmessage=async s=>{if(typeof s.data!="string")throw new Error("Received invalid signaling data");const a=JSON.parse(s.data);if(a.type===v)this.writeWebSocketSignalingLog("onmessage-offer",a),this.signalingOnMessageTypeOffer(a),this.connectedSignalingUrl=e.url,t(a);else if(a.type===E)this.writeWebSocketSignalingLog("onmessage-update",a),await this.signalingOnMessageTypeUpdate(a);else if(a.type===O)this.writeWebSocketSignalingLog("onmessage-re-offer",a),await this.signalingOnMessageTypeReOffer(a);else if(a.type===$)await this.signalingOnMessageTypePing(a);else if(a.type===z)this.callbacks.push(a,m);else if(a.type===H)a.event_type==="connection.created"?this.writeWebSocketTimelineLog("notify-connection.created",a):a.event_type==="connection.destroyed"&&this.writeWebSocketTimelineLog("notify-connection.destroyed",a),this.signalingOnMessageTypeNotify(a,m);else if(a.type===G)this.writeWebSocketSignalingLog("onmessage-switched",a),this.signalingOnMessageTypeSwitched(a);else if(a.type===x){this.writeWebSocketSignalingLog("onmessage-redirect",a);try{const l=await this.signalingOnMessageTypeRedirect(a);t(l)}catch(l){o(l)}}},(async()=>{let s;try{s=oe(i.sdp||"",this.role,this.channelId,this.metadata,this.options,n)}catch(a){o(a);return}this.trace("SIGNALING CONNECT MESSAGE",s),e&&(e.send(JSON.stringify(s)),this.writeWebSocketSignalingLog(`send-${s.type}`,s),this.ws=e,n||(this.contactSignalingUrl=e.url,this.writeWebSocketSignalingLog("contact-signaling-url",this.contactSignalingUrl)))})()})}async connectPeerConnection(e){let n=Object.assign({},e.config);if(window.RTCPeerConnection.generateCertificate!==void 0){const i=await window.RTCPeerConnection.generateCertificate({name:"ECDSA",namedCurve:"P-256"});n=Object.assign({certificates:[i]},n)}this.trace("PEER CONNECTION CONFIG",n),this.writePeerConnectionTimelineLog("new-peerconnection",n),this.pc=new window.RTCPeerConnection(n,this.constraints),this.pc.oniceconnectionstatechange=i=>{this.pc&&(this.writePeerConnectionTimelineLog("oniceconnectionstatechange",{connectionState:this.pc.connectionState,iceConnectionState:this.pc.iceConnectionState,iceGatheringState:this.pc.iceGatheringState}),this.trace("ONICECONNECTIONSTATECHANGE ICECONNECTIONSTATE",this.pc.iceConnectionState))},this.pc.onicegatheringstatechange=i=>{this.pc&&this.writePeerConnectionTimelineLog("onicegatheringstatechange",{connectionState:this.pc.connectionState,iceConnectionState:this.pc.iceConnectionState,iceGatheringState:this.pc.iceGatheringState})},this.pc.onconnectionstatechange=i=>{this.pc&&this.writePeerConnectionTimelineLog("onconnectionstatechange",{connectionState:this.pc.connectionState,iceConnectionState:this.pc.iceConnectionState,iceGatheringState:this.pc.iceGatheringState})},this.pc.ondatachannel=i=>{this.onDataChannel(i)}}async setRemoteDescription(e){if(!this.pc)return;const n=this.processOfferSdp(e.sdp),i=new RTCSessionDescription({type:v,sdp:n});await this.pc.setRemoteDescription(i),this.writePeerConnectionTimelineLog("set-remote-description",i)}async createAnswer(e){if(!this.pc)return;for(const i of Object.values(this.mids)){const t=this.pc.getTransceivers().find(o=>o.mid===i);t&&t.direction===W&&(t.direction=y)}if(this.simulcast&&(this.role===y||this.role===b)){const i=this.pc.getTransceivers().find(t=>{if(t.mid!==null&&t.sender.track!==null&&!(t.currentDirection!==null&&t.currentDirection!==b)&&(this.mids.video!==""&&this.mids.video===t.mid||0<=t.mid.indexOf("video")))return t});if(i){await this.setSenderParameters(i,this.encodings),await this.setRemoteDescription(e),this.trace("TRANSCEIVER SENDER GET_PARAMETERS",i.sender.getParameters()),await this.setSenderParameters(i,this.encodings);const t=await this.pc.createAnswer();await this.pc.setLocalDescription(t),this.trace("TRANSCEIVER SENDER GET_PARAMETERS",i.sender.getParameters());return}}const n=await this.pc.createAnswer();this.writePeerConnectionTimelineLog("create-answer",n),this.options.forceStereoOutput&&n.sdp&&(n.sdp=he(n.sdp)),await this.pc.setLocalDescription(n),this.writePeerConnectionTimelineLog("set-local-description",n)}processOfferSdp(e){let n=e;return ae()&&(n=n.replace(/^m=(audio|video) 0 /gm,(i,t)=>`m=${t} 9 `)),n}sendAnswer(){if(this.pc&&this.ws&&this.pc.localDescription){this.trace("ANSWER SDP",this.pc.localDescription.sdp);const e=this.pc.localDescription.sdp,n={type:_,sdp:e};this.ws.send(JSON.stringify(n)),this.writeWebSocketSignalingLog("send-answer",n)}}onIceCandidate(){return new Promise((e,n)=>{this.pc&&(this.pc.oniceconnectionstatechange=i=>{this.pc&&(this.writePeerConnectionTimelineLog("oniceconnectionstatechange",{connectionState:this.pc.connectionState,iceConnectionState:this.pc.iceConnectionState,iceGatheringState:this.pc.iceGatheringState}),this.trace("ONICECONNECTIONSTATECHANGE ICECONNECTIONSTATE",this.pc.iceConnectionState),this.pc.iceConnectionState==="connected"&&e())},this.pc.onicecandidate=async i=>{if(this.writePeerConnectionTimelineLog("onicecandidate",i.candidate),this.pc&&this.trace("ONICECANDIDATE ICEGATHERINGSTATE",this.pc.iceGatheringState),i.candidate===null)e();else{const t=i.candidate.toJSON(),o=Object.assign(t,{type:U});this.trace("ONICECANDIDATE CANDIDATE MESSAGE",o),await this.sendSignalingMessage(o)}})})}waitChangeConnectionStateConnected(){return new Promise((e,n)=>{if(this.pc&&this.pc.connectionState===void 0){e();return}const i=setInterval(()=>{if(this.pc)this.pc&&this.pc.connectionState==="connected"&&(clearInterval(i),e());else{const t=new Error;t.message="PeerConnection connectionState did not change to 'connected'",clearInterval(i),n(t)}},10)})}monitorSignalingWebSocketEvent(){return new Promise((e,n)=>{this.monitorSignalingWebSocketEventTimerId=setInterval(()=>{this.ws&&(this.clearMonitorSignalingWebSocketEvent(),this.ws.onclose=i=>{const t=new g(`Signaling failed. CloseEventCode:${i.code} CloseEventReason:'${i.reason}'`);t.code=i.code,t.reason=i.reason,this.writeWebSocketTimelineLog("onclose",t),this.signalingTerminate(),n(t)},this.ws.onerror=i=>{const t=new g("Signaling failed. WebSocket onerror was called");this.writeWebSocketSignalingLog("onerror",t),this.signalingTerminate(),n(t)})},100)})}monitorWebSocketEvent(){this.ws&&(this.ws.onclose=async e=>{this.writeWebSocketTimelineLog("onclose",{code:e.code,reason:e.reason}),e.code===1e3?this.shutdown({code:e.code,reason:e.reason}):await this.abend("WEBSOCKET-ONCLOSE",{code:e.code,reason:e.reason})},this.ws.onerror=async e=>{this.writeWebSocketSignalingLog("onerror"),await this.abend("WEBSOCKET-ONERROR")})}monitorPeerConnectionState(){this.pc&&(this.pc.oniceconnectionstatechange=e=>{this.pc&&this.pc.connectionState===void 0&&(this.writePeerConnectionTimelineLog("oniceconnectionstatechange",{connectionState:this.pc.connectionState,iceConnectionState:this.pc.iceConnectionState,iceGatheringState:this.pc.iceGatheringState}),this.trace("ONICECONNECTIONSTATECHANGE ICECONNECTIONSTATE",this.pc.iceConnectionState),clearTimeout(this.monitorIceConnectionStateChangeTimerId),this.pc.iceConnectionState==="failed"?this.abendPeerConnectionState("ICE-CONNECTION-STATE-FAILED"):this.pc.iceConnectionState==="disconnected"&&(this.monitorIceConnectionStateChangeTimerId=setTimeout(()=>{this.pc&&this.pc.iceConnectionState==="disconnected"&&this.abendPeerConnectionState("ICE-CONNECTION-STATE-DISCONNECTED-TIMEOUT")},1e4)))},this.pc.onconnectionstatechange=e=>{this.pc&&(this.writePeerConnectionTimelineLog("onconnectionstatechange",{connectionState:this.pc.connectionState,iceConnectionState:this.pc.iceConnectionState,iceGatheringState:this.pc.iceGatheringState}),this.pc.connectionState==="failed"&&this.abendPeerConnectionState("CONNECTION-STATE-FAILED"))})}setConnectionTimeout(){return new Promise((e,n)=>{0<this.connectionTimeout&&(this.connectionTimeoutTimerId=setTimeout(()=>{if(!this.pc||this.pc&&this.pc.connectionState!==void 0&&this.pc.connectionState!=="connected"){const i=new Error;i.message="Signaling connection timeout",this.callbacks.timeout(),this.trace("DISCONNECT","Signaling connection timeout"),this.writePeerConnectionTimelineLog("signaling-connection-timeout",{connectionTimeout:this.connectionTimeout}),this.signalingTerminate(),n(i)}},this.connectionTimeout))})}clearConnectionTimeout(){clearTimeout(this.connectionTimeoutTimerId)}clearMonitorSignalingWebSocketEvent(){clearInterval(this.monitorSignalingWebSocketEventTimerId)}clearMonitorIceConnectionStateChange(){clearInterval(this.monitorIceConnectionStateChangeTimerId)}trace(e,n){this.callbacks.log(e,n),this.debug&&ce(this.clientId,e,n)}writeWebSocketSignalingLog(e,n){this.callbacks.signaling(k(e,n,m)),this.writeWebSocketTimelineLog(e,n)}writeDataChannelSignalingLog(e,n,i){this.callbacks.signaling(k(e,i,M)),this.writeDataChannelTimelineLog(e,n,i)}writeWebSocketTimelineLog(e,n){const i=f(e,n,m);this.callbacks.timeline(i)}writeDataChannelTimelineLog(e,n,i){const t=f(e,i,"datachannel",n.id,n.label);this.callbacks.timeline(t)}writePeerConnectionTimelineLog(e,n){const i=f(e,n,"peerconnection");this.callbacks.timeline(i)}writeSoraTimelineLog(e,n){const i=f(e,n,"sora");this.callbacks.timeline(i)}async createOffer(){const e={iceServers:[]},n=new window.RTCPeerConnection(e);if(se()){n.addTransceiver("video",{direction:"recvonly"}),n.addTransceiver("audio",{direction:"recvonly"});const t=await n.createOffer();return n.close(),this.writePeerConnectionTimelineLog("create-offer",t),t}const i=await n.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});return n.close(),this.writePeerConnectionTimelineLog("create-offer",i),i}signalingOnMessageTypeOffer(e){if(this.simulcast=e.simulcast,this.spotlight=e.spotlight,e.session_id!==void 0&&(this.sessionId=e.session_id),this.clientId=e.client_id,this.bundleId=e.bundle_id,this.connectionId=e.connection_id,e.metadata!==void 0&&(this.authMetadata=e.metadata),Array.isArray(e.encodings)&&(this.encodings=e.encodings),e.mid!==void 0&&e.mid.audio!==void 0&&(this.mids.audio=e.mid.audio),e.mid!==void 0&&e.mid.video!==void 0&&(this.mids.video=e.mid.video),e.data_channels)for(const n of e.data_channels)this.signalingOfferMessageDataChannels[n.label]=n;this.trace("SIGNALING OFFER MESSAGE",e),this.trace("OFFER SDP",e.sdp)}async sendUpdateAnswer(){this.pc&&this.ws&&this.pc.localDescription&&(this.trace("UPDATE ANSWER SDP",this.pc.localDescription.sdp),await this.sendSignalingMessage({type:E,sdp:this.pc.localDescription.sdp}))}async sendReAnswer(){this.pc?.localDescription&&(this.trace("RE ANSWER SDP",this.pc.localDescription.sdp),await this.sendSignalingMessage({type:B,sdp:this.pc.localDescription.sdp}))}async signalingOnMessageTypeUpdate(e){this.trace("SIGNALING UPDATE MESSGE",e),this.trace("UPDATE SDP",e.sdp),await this.setRemoteDescription(e),await this.createAnswer(e),await this.sendUpdateAnswer()}async signalingOnMessageTypeReOffer(e){this.trace("SIGNALING RE OFFER MESSGE",e),this.trace("RE OFFER SDP",e.sdp),await this.setRemoteDescription(e),await this.createAnswer(e),await this.sendReAnswer()}async signalingOnMessageTypeClose(e){this.trace("SIGNALING DISCONNECT MESSAGE",e),this.shutdown({code:e.code,reason:e.reason})}async signalingOnMessageTypePing(e){const n={type:J};if(e.stats){const i=await this.getStats();n.stats=i}this.ws&&this.ws.send(JSON.stringify(n))}signalingOnMessageTypeNotify(e,n){this.callbacks.notify(e,n)}signalingOnMessageTypeSwitched(e){if(this.signalingSwitched=!0,!!this.ws){e.ignore_disconnect_websocket&&(this.ws&&(this.ws.onclose=null,this.ws.close(),this.ws=null),this.writeWebSocketSignalingLog("close"));for(const n of this.datachannels)this.callbacks.datachannel(de(n))}}async signalingOnMessageTypeRedirect(e){this.ws&&(this.ws.onclose=null,this.ws.onerror=null,this.ws.close(),this.ws=null);const n=await this.getSignalingWebSocket(e.location);return await this.signaling(n,!0)}async setSenderParameters(e,n){const i=e.sender.getParameters();i.encodings=n,await e.sender.setParameters(i),this.trace("TRANSCEIVER SENDER SET_PARAMETERS",i),this.writePeerConnectionTimelineLog("transceiver-sender-set-parameters",i)}async getStats(){const e=[];if(!this.pc)return e;const n=await this.pc.getStats();for(const[i,t]of n.entries())e.push(t);return e}onDataChannel(e){const n=e.channel;n.bufferedAmountLowThreshold=65536,n.binaryType="arraybuffer",this.soraDataChannels[n.label]=n,this.writeDataChannelTimelineLog("ondatachannel",n,re(n)),e.channel.onbufferedamountlow=i=>{const t=i.currentTarget;this.writeDataChannelTimelineLog("onbufferedamountlow",t)},e.channel.onopen=i=>{const t=i.currentTarget;this.trace("OPEN DATA CHANNEL",t.label),t.label==="signaling"&&this.ws?this.writeDataChannelSignalingLog("onopen",t):this.writeDataChannelTimelineLog("onopen",t)},e.channel.onclose=async i=>{const t=i.currentTarget;this.writeDataChannelTimelineLog("onclose",t),this.trace("CLOSE DATA CHANNEL",t.label),await this.disconnect()},e.channel.onerror=async i=>{const t=i.currentTarget;this.writeDataChannelTimelineLog("onerror",t),this.trace("ERROR DATA CHANNEL",t.label),await this.abend("DATA-CHANNEL-ONERROR",{params:{label:t.label}})},e.channel.label===K?e.channel.onmessage=async i=>{const t=i.currentTarget,o=t.label,s=this.signalingOfferMessageDataChannels[o];if(!s){console.warn(`Received onmessage event for '${o}' DataChannel. But '${o}' DataChannel settings doesn't exist`);return}const a=await C(i.data,s.compress),l=JSON.parse(a);this.writeDataChannelSignalingLog(`onmessage-${l.type}`,t,l),l.type===O?await this.signalingOnMessageTypeReOffer(l):l.type===F&&await this.signalingOnMessageTypeClose(l)}:e.channel.label===Y?e.channel.onmessage=async i=>{const t=i.currentTarget,o=t.label,s=this.signalingOfferMessageDataChannels[o];if(!s){console.warn(`Received onmessage event for '${o}' DataChannel. But '${o}' DataChannel settings doesn't exist`);return}const a=await C(i.data,s.compress),l=JSON.parse(a);l.event_type==="connection.created"?this.writeDataChannelTimelineLog("notify-connection.created",t,l):l.event_type==="connection.destroyed"&&this.writeDataChannelTimelineLog("notify-connection.destroyed",t,l),this.signalingOnMessageTypeNotify(l,"datachannel")}:e.channel.label===q?e.channel.onmessage=async i=>{const t=i.currentTarget.label,o=this.signalingOfferMessageDataChannels[t];if(!o){console.warn(`Received onmessage event for '${t}' DataChannel. But '${t}' DataChannel settings doesn't exist`);return}const s=await C(i.data,o.compress),a=JSON.parse(s);this.callbacks.push(a,"datachannel")}:e.channel.label===Q?e.channel.onmessage=async i=>{const t=i.currentTarget.label,o=this.signalingOfferMessageDataChannels[t];if(!o){console.warn(`Received onmessage event for '${t}' DataChannel. But '${t}' DataChannel settings doesn't exist`);return}const s=await C(i.data,o.compress);if(JSON.parse(s).type===j){const a=await this.getStats();await this.sendStatsMessage(a)}}:/^#.*/.exec(e.channel.label)&&(e.channel.onmessage=async i=>{if(i.currentTarget===null)return;const t=i.currentTarget.label,o=this.signalingOfferMessageDataChannels[t];if(!o){console.warn(`Received onmessage event for '${t}' DataChannel. But '${t}' DataChannel settings doesn't exist`);return}const s=i.target;let a;typeof i.data=="string"?a=new TextEncoder().encode(i.data).buffer:i.data instanceof ArrayBuffer?a=i.data:console.warn("Received onmessage event data is not of type String or ArrayBuffer."),a!==void 0&&(o.compress===!0&&(a=await I(new Uint8Array(a))),this.callbacks.message(le(s.label,a)))})}async sendSignalingMessage(e){if(this.soraDataChannels.signaling){if(this.signalingOfferMessageDataChannels.signaling&&this.signalingOfferMessageDataChannels.signaling.compress===!0){const n=new TextEncoder().encode(JSON.stringify(e)),i=await p(n);this.soraDataChannels.signaling.send(i)}else this.soraDataChannels.signaling.send(JSON.stringify(e));this.writeDataChannelSignalingLog(`send-${e.type}`,this.soraDataChannels.signaling,e)}else this.ws!==null&&(this.ws.send(JSON.stringify(e)),this.writeWebSocketSignalingLog(`send-${e.type}`,e))}async sendStatsMessage(e){if(this.soraDataChannels.stats){const n={type:V,reports:e};if(this.signalingOfferMessageDataChannels.stats&&this.signalingOfferMessageDataChannels.stats.compress===!0){const i=new TextEncoder().encode(JSON.stringify(n)),t=await p(i);this.soraDataChannels.stats.send(t)}else this.soraDataChannels.stats.send(JSON.stringify(n))}}getAudioTransceiver(){return this.pc&&this.mids.audio&&this.pc.getTransceivers().find(e=>e.mid===this.mids.audio)||null}getVideoTransceiver(){return this.pc&&this.mids.video&&this.pc.getTransceivers().find(e=>e.mid===this.mids.video)||null}soraCloseEvent(e,n,i){const t=class extends Event{title;code;reason;params;constructor(o,s,a){super(o),a&&(a.code&&(this.code=a.code),a.reason&&(this.reason=a.reason),a.params&&(this.params=a.params)),this.title=s}};return new t(e,n,i)}async sendMessage(e,n){const i=this.soraDataChannels[e];if(this.pc===null)return;if(i===void 0)throw new Error("Could not find DataChannel");if(i.readyState!=="open")throw new Error("Messaging DataChannel is not open");const t=this.signalingOfferMessageDataChannels[e];if(t!==void 0&&t.compress===!0){const o=await p(n);i.send(o)}else i.send(n)}get audio(){return this.getAudioTransceiver()!==null}get video(){return this.getVideoTransceiver()!==null}get signalingUrl(){return this.signalingUrlCandidates}get datachannels(){if(!this.signalingSwitched)return[];const e=Object.keys(this.signalingOfferMessageDataChannels).filter(i=>/^#.*/.exec(i)),n=[];for(const i of e){const t=this.soraDataChannels[i];if(!t)continue;const o=this.signalingOfferMessageDataChannels[i];if(!o)continue;const s={label:t.label,ordered:t.ordered,protocol:t.protocol,compress:o.compress,direction:o.direction,header:o.header};typeof t.maxPacketLifeTime=="number"&&(s.maxPacketLifeTime=t.maxPacketLifeTime),typeof t.maxRetransmits=="number"&&(s.maxRetransmits=t.maxRetransmits),n.push(s)}return n}}class we extends S{async connect(){await Promise.race([this.multiStream().finally(()=>{this.clearConnectionTimeout(),this.clearMonitorSignalingWebSocketEvent()}),this.setConnectionTimeout(),this.monitorSignalingWebSocketEvent()]),this.monitorWebSocketEvent(),this.monitorPeerConnectionState()}async multiStream(){await this.disconnect();const e=await this.getSignalingWebSocket(this.signalingUrlCandidates),n=await this.signaling(e);await this.connectPeerConnection(n),await this.setRemoteDescription(n),await this.createAnswer(n),this.sendAnswer(),this.options.skipIceCandidateEvent||await this.onIceCandidate(),await this.waitChangeConnectionStateConnected()}}class D extends S{async connect(e){return await Promise.race([this.multiStream(e).finally(()=>{this.clearConnectionTimeout(),this.clearMonitorSignalingWebSocketEvent()}),this.setConnectionTimeout(),this.monitorSignalingWebSocketEvent()]),this.monitorWebSocketEvent(),this.monitorPeerConnectionState(),e}async multiStream(e){await this.disconnect();const n=await this.getSignalingWebSocket(this.signalingUrlCandidates),i=await this.signaling(n);return await this.connectPeerConnection(i),this.pc&&(this.pc.ontrack=async t=>{const o=t.streams[0];if(!o)return;const s={"stream.id":o.id,id:t.track.id,label:t.track.label,enabled:t.track.enabled,kind:t.track.kind,muted:t.track.muted,readyState:t.track.readyState};this.writePeerConnectionTimelineLog("ontrack",s),o.id!=="default"&&o.id!==this.connectionId&&(this.callbacks.track(t),o.onremovetrack=a=>{if(this.callbacks.removetrack(a),a.target){const l=a.target.id,h=this.remoteConnectionIds.indexOf(l);-1<h&&delete this.remoteConnectionIds[h]}},!(-1<this.remoteConnectionIds.indexOf(o.id))&&this.remoteConnectionIds.push(o.id))}),await this.setRemoteDescription(i),e.getTracks().filter(t=>{this.pc&&this.pc.addTrack(t,e)}),this.stream=e,await this.createAnswer(i),this.sendAnswer(),this.options.skipIceCandidateEvent||await this.onIceCandidate(),await this.waitChangeConnectionStateConnected(),e}}class Se extends S{async connect(){await Promise.race([this.multiStream().finally(()=>{this.clearConnectionTimeout(),this.clearMonitorSignalingWebSocketEvent()}),this.setConnectionTimeout(),this.monitorSignalingWebSocketEvent()]),this.monitorWebSocketEvent(),this.monitorPeerConnectionState()}async multiStream(){await this.disconnect();const e=await this.getSignalingWebSocket(this.signalingUrlCandidates),n=await this.signaling(e);await this.connectPeerConnection(n),this.pc&&(this.pc.ontrack=async i=>{const t=i.streams[0];if(t.id==="default"||t.id===this.connectionId)return;const o={"stream.id":t.id,id:i.track.id,label:i.track.label,enabled:i.track.enabled,kind:i.track.kind,muted:i.track.muted,readyState:i.track.readyState};this.writePeerConnectionTimelineLog("ontrack",o),this.callbacks.track(i),t.onremovetrack=s=>{if(this.callbacks.removetrack(s),s.target){const a=s.target.id,l=this.remoteConnectionIds.indexOf(a);-1<l&&delete this.remoteConnectionIds[l]}},!(-1<this.remoteConnectionIds.indexOf(t.id))&&this.remoteConnectionIds.push(t.id)}),await this.setRemoteDescription(n),await this.createAnswer(n),this.sendAnswer(),this.options.skipIceCandidateEvent||await this.onIceCandidate(),await this.waitChangeConnectionStateConnected()}}class Te{signalingUrlCandidates;debug;constructor(e,n=!1){this.signalingUrlCandidates=e,this.debug=n}sendrecv(e,n=null,i={audio:!0,video:!0}){return new D(this.signalingUrlCandidates,"sendrecv",e,n,i,this.debug)}sendonly(e,n=null,i={audio:!0,video:!0}){return new D(this.signalingUrlCandidates,"sendonly",e,n,i,this.debug)}recvonly(e,n=null,i={audio:!0,video:!0}){return new Se(this.signalingUrlCandidates,"recvonly",e,n,i,this.debug)}messaging(e,n=null,i={audio:!1,video:!1}){return i.audio=!1,i.video=!1,i.dataChannelSignaling=!0,new we(this.signalingUrlCandidates,"sendonly",e,n,i,this.debug)}get signalingUrl(){return this.signalingUrlCandidates}}const ye={connection:(c,e=!1)=>new Te(c,e),version:()=>"2025.1.0-canary.8",helpers:{applyMediaStreamConstraints:R}};export{ye as y};
