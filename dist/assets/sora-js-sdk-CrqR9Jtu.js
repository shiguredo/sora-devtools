/**
 * sora-js-sdk
 * WebRTC SFU Sora JavaScript SDK
 * @version: 2025.1.0-canary.0
 * @author: Shiguredo Inc.
 * @license: Apache-2.0
 **/async function R(c,e){if(e.audio&&typeof e.audio!="boolean")for(const t of c.getAudioTracks())await t.applyConstraints(e.audio);if(e.video&&typeof e.video!="boolean")for(const t of c.getVideoTracks())await t.applyConstraints(e.video)}const p="websocket",W="datachannel",y="sendrecv",b="sendonly",M="recvonly",x="redirect",v="offer",_="answer",U="candidate",G="switched",$="ping",J="pong",j="req-stats",F="stats",V="close",O="re-offer",B="re-answer",w="disconnect",H="notify",z="push",k="update",K="signaling",q="push",Y="notify",Q="stats";class X extends Error{constructor(){super("DISCONNECT-WAIT-TIMEOUT-ERROR")}}class Z extends Error{constructor(){super("DISCONNECT-INTERNAL-ERROR")}}class ee extends Error{constructor(){super("DISCONNECT-DATA-CHANNEL-ERROR")}}function N(){const c=window.navigator.userAgent.toLocaleLowerCase();return c.indexOf("edge")!==-1?"edge":c.indexOf("chrome")!==-1&&c.indexOf("edge")===-1?"chrome":c.indexOf("safari")!==-1&&c.indexOf("chrome")===-1?"safari":c.indexOf("opera")!==-1?"opera":c.indexOf("firefox")!==-1?"firefox":null}function te(){const c=["urn:ietf:params:rtp-hdrext:sdes:mid","urn:ietf:params:rtp-hdrext:sdes:rtp-stream-id","urn:ietf:params:rtp-hdrext:sdes:repaired-rtp-stream-id"];if(!window.RTCRtpSender||!RTCRtpSender.getCapabilities)return!1;const e=RTCRtpSender.getCapabilities("video");if(!e)return!1;const t=e.headerExtensions.map(i=>i.uri);return c.every(i=>t.includes(i))}function ne(c){if(typeof c!="object"||c===null)throw new Error("Failed to parse options dataChannels. Options dataChannels element must be type 'object'");const e=c,t={};return typeof e.label=="string"&&(t.label=e.label),typeof e.direction=="string"&&(t.direction=e.direction),typeof e.ordered=="boolean"&&(t.ordered=e.ordered),typeof e.compress=="boolean"&&(t.compress=e.compress),typeof e.maxPacketLifeTime=="number"&&(t.max_packet_life_time=e.maxPacketLifeTime),typeof e.maxRetransmits=="number"&&(t.max_retransmits=e.maxRetransmits),typeof e.protocol=="string"&&(t.protocol=e.protocol),Array.isArray(e.header)&&(t.header=e.header),t}function ie(c){const e=[];for(const t of c)e.push(ne(t));return e}function se(){return N()==="safari"}function ae(){return N()==="firefox"}function oe(c,e,t,i,n,o){if(e!=="sendrecv"&&e!=="sendonly"&&e!=="recvonly")throw new Error("Unknown role type");if(t==null)throw new Error("channelId can not be null or undefined");const s={type:"connect",sora_client:"Sora JavaScript SDK 2025.1.0-canary.0",environment:window.navigator.userAgent,role:e,channel_id:t,sdp:c,audio:!0,video:!0};if(e==="sendrecv"&&n.multistream===!1)throw new Error("Failed to parse options. Options multistream must be true when connecting using 'sendrecv'");o===!0&&(s.redirect=!0),typeof n.multistream=="boolean"&&(s.multistream=n.multistream),typeof n.simulcast=="boolean"&&(s.simulcast=n.simulcast);const a=["r0","r1","r2"];n.simulcastRid!==void 0&&0<=a.indexOf(n.simulcastRid)&&(s.simulcast_rid=n.simulcastRid),typeof n.spotlight=="boolean"&&(s.spotlight=n.spotlight),"spotlightNumber"in n&&(s.spotlight_number=n.spotlightNumber);const l=["none","r0","r1","r2"];n.spotlightFocusRid!==void 0&&0<=l.indexOf(n.spotlightFocusRid)&&(s.spotlight_focus_rid=n.spotlightFocusRid),n.spotlightUnfocusRid!==void 0&&0<=l.indexOf(n.spotlightUnfocusRid)&&(s.spotlight_unfocus_rid=n.spotlightUnfocusRid),i!==void 0&&(s.metadata=i),n.signalingNotifyMetadata!==void 0&&(s.signaling_notify_metadata=n.signalingNotifyMetadata),n.forwardingFilters!==void 0&&(s.forwarding_filters=n.forwardingFilters),n.forwardingFilter!==void 0&&(s.forwarding_filter=n.forwardingFilter),n.clientId!==void 0&&(s.client_id=n.clientId),n.bundleId!==void 0&&(s.bundle_id=n.bundleId),typeof n.dataChannelSignaling=="boolean"&&(s.data_channel_signaling=n.dataChannelSignaling),typeof n.ignoreDisconnectWebSocket=="boolean"&&(s.ignore_disconnect_websocket=n.ignoreDisconnectWebSocket);const d=["audioCodecType","audioBitRate"],u=["audioOpusParamsChannels","audioOpusParamsMaxplaybackrate","audioOpusParamsStereo","audioOpusParamsSpropStereo","audioOpusParamsMinptime","audioOpusParamsPtime","audioOpusParamsUseinbandfec","audioOpusParamsUsedtx"],T=["videoCodecType","videoBitRate","videoVP9Params","videoH264Params","videoH265Params","videoAV1Params"],r=Object.assign({},n);Object.keys(r).filter(h=>{h==="audio"&&typeof r[h]=="boolean"||h==="video"&&typeof r[h]=="boolean"||0<=d.indexOf(h)&&r[h]!==null||0<=u.indexOf(h)&&r[h]!==null||0<=T.indexOf(h)&&r[h]!==null||delete r[h]}),r.audio!==void 0&&(s.audio=r.audio);const A=Object.keys(r).some(h=>0<=d.indexOf(h));s.audio&&A&&(s.audio={},"audioCodecType"in r&&(s.audio.codec_type=r.audioCodecType),"audioBitRate"in r&&(s.audio.bit_rate=r.audioBitRate));const I=Object.keys(r).some(h=>0<=u.indexOf(h));s.audio&&I&&(typeof s.audio!="object"&&(s.audio={}),s.audio.opus_params={},"audioOpusParamsChannels"in r&&(s.audio.opus_params.channels=r.audioOpusParamsChannels),"audioOpusParamsMaxplaybackrate"in r&&(s.audio.opus_params.maxplaybackrate=r.audioOpusParamsMaxplaybackrate),"audioOpusParamsStereo"in r&&(s.audio.opus_params.stereo=r.audioOpusParamsStereo),"audioOpusParamsSpropStereo"in r&&(s.audio.opus_params.sprop_stereo=r.audioOpusParamsSpropStereo),"audioOpusParamsMinptime"in r&&(s.audio.opus_params.minptime=r.audioOpusParamsMinptime),"audioOpusParamsPtime"in r&&(s.audio.opus_params.ptime=r.audioOpusParamsPtime),"audioOpusParamsUseinbandfec"in r&&(s.audio.opus_params.useinbandfec=r.audioOpusParamsUseinbandfec),"audioOpusParamsUsedtx"in r&&(s.audio.opus_params.usedtx=r.audioOpusParamsUsedtx)),r.video!==void 0&&(s.video=r.video);const L=Object.keys(r).some(h=>0<=T.indexOf(h));if(s.video&&L&&(s.video={},"videoCodecType"in r&&(s.video.codec_type=r.videoCodecType),"videoBitRate"in r&&(s.video.bit_rate=r.videoBitRate),"videoVP9Params"in r&&(s.video.vp9_params=r.videoVP9Params),"videoH264Params"in r&&(s.video.h264_params=r.videoH264Params),"videoH265Params"in r&&(s.video.h265_params=r.videoH265Params),"videoAV1Params"in r&&(s.video.av1_params=r.videoAV1Params)),s.simulcast&&!te()&&e!=="recvonly")throw new Error("Simulcast can not be used with this browser");return Array.isArray(n.dataChannels)&&0<n.dataChannels.length&&(s.data_channels=ie(n.dataChannels)),n.audioStreamingLanguageCode!==void 0&&(s.audio_streaming_language_code=n.audioStreamingLanguageCode),s}function ce(c,e,t){const i=o=>{if(o&&typeof o=="object"){let s=null;try{s=Object.keys(JSON.parse(JSON.stringify(o)))}catch{}s&&Array.isArray(s)?s.filter(a=>{console.group(a),i(o[a]),console.groupEnd()}):console.info(o)}else console.info(o)};let n="";window.performance&&(n=`[${(window.performance.now()/1e3).toFixed(3)}]`),c&&(n=`${n}[${c}]`),console.info!==void 0&&console.group!==void 0?(console.group(`${n} ${e}`),i(t),console.groupEnd()):console.log(`${n} ${e}
`,t)}class g extends Error{code;reason}function E(c,e,t){const i=new Event(c);try{i.data=JSON.parse(JSON.stringify(e))}catch{i.data=e}return i.transportType=t,i}function re(c){return{binaryType:c.binaryType,bufferedAmount:c.bufferedAmount,bufferedAmountLowThreshold:c.bufferedAmountLowThreshold,id:c.id,label:c.label,maxPacketLifeTime:c.maxPacketLifeTime,maxRetransmits:c.maxRetransmits,negotiated:c.negotiated,ordered:c.ordered,protocol:c.protocol,readyState:c.readyState,reliable:c.reliable}}function f(c,e,t,i,n){const o=new Event(c);try{o.data=JSON.parse(JSON.stringify(e))}catch{o.data=e}return o.logType=t,o.dataChannelId=i,o.dataChannelLabel=n,o}function le(c,e){const t=new Event("message");return t.label=c,t.data=e,t}function he(c){const e=new Event("datachannel");return e.datachannel=c,e}async function C(c,e){if(e){const t=await P(new Uint8Array(c));return new TextDecoder().decode(t)}return c}const m=async c=>{const e=new Blob([c]).stream().pipeThrough(new CompressionStream("deflate"));return await new Response(e).arrayBuffer()},P=async c=>{const e=new Blob([c]).stream().pipeThrough(new DecompressionStream("deflate"));return await new Response(e).arrayBuffer()};function de(c){const e=c.match(/^(v=.+?)(m=audio.+)/ms);if(e===null)return c;const t=e[1],i=[];let n=[];for(const s of e[2].split(/\n/))s[0]==="m"?(n=[s],i.push(n)):n.push(s);const o=i.map(s=>s.join(`
`)).map(s=>!ge(s)||!ue(s)||!me(s)||!pe(s)||!fe(s)?s:Ce(s));return`${t}${o.join(`
`)}`}function ge(c){return/^m=audio/.test(c)}function ue(c){return/a=setup:active/.test(c)}function me(c){return/a=recvonly/.test(c)}function pe(c){return/a=rtpmap:\d+\sopus/.test(c)}function fe(c){return/a=fmtp:\d+/.test(c)}function Ce(c){return c.replace(/(?<!stereo=1;.*)minptime=\d+(?!.*stereo=1)/,e=>`${e};stereo=1`)}class S{role;simulcast;spotlight;channelId;metadata;signalingUrlCandidates;options;constraints;debug;bundleId;clientId;connectionId;sessionId;remoteConnectionIds;stream;authMetadata;pc;encodings;connectedSignalingUrl;contactSignalingUrl;ws;connectionTimeoutTimerId;monitorSignalingWebSocketEventTimerId;monitorIceConnectionStateChangeTimerId;soraDataChannels;connectionTimeout;signalingCandidateTimeout;disconnectWaitTimeout;mids;signalingSwitched;signalingOfferMessageDataChannels;callbacks;constructor(e,t,i,n,o,s){this.role=t,this.channelId=i,this.metadata=n,this.signalingUrlCandidates=e,this.options=o,this.connectionTimeout=6e4,typeof this.options.timeout=="number"&&(console.warn("@deprecated timeout option will be removed in a future version. Use connectionTimeout."),this.connectionTimeout=this.options.timeout),typeof this.options.connectionTimeout=="number"&&(this.connectionTimeout=this.options.connectionTimeout),this.disconnectWaitTimeout=3e3,typeof this.options.disconnectWaitTimeout=="number"&&(this.disconnectWaitTimeout=this.options.disconnectWaitTimeout),this.signalingCandidateTimeout=3e3,typeof this.options.signalingCandidateTimeout=="number"&&(this.signalingCandidateTimeout=this.options.signalingCandidateTimeout),this.constraints=null,this.debug=s,this.simulcast=!1,this.spotlight=!1,this.sessionId=null,this.clientId=null,this.bundleId=null,this.connectionId=null,this.remoteConnectionIds=[],this.stream=null,this.ws=null,this.pc=null,this.encodings=[],this.callbacks={disconnect:()=>{},push:()=>{},track:()=>{},removetrack:()=>{},notify:()=>{},log:()=>{},timeout:()=>{},timeline:()=>{},signaling:()=>{},message:()=>{},datachannel:()=>{}},this.authMetadata=null,this.connectionTimeoutTimerId=0,this.monitorSignalingWebSocketEventTimerId=0,this.monitorIceConnectionStateChangeTimerId=0,this.soraDataChannels={},this.mids={audio:"",video:""},this.signalingSwitched=!1,this.signalingOfferMessageDataChannels={},this.connectedSignalingUrl="",this.contactSignalingUrl=""}on(e,t){e in this.callbacks&&(this.callbacks[e]=t)}stopAudioTrack(e){return console.warn("@deprecated stopAudioTrack will be removed in a future version. Use removeAudioTrack instead."),this.removeAudioTrack(e)}removeAudioTrack(e){for(const t of e.getAudioTracks())t.enabled=!1;return new Promise((t,i)=>{setTimeout(()=>{const n=e.getAudioTracks().map(async o=>{if(o.stop(),e.removeTrack(o),this.pc!==null){const s=this.pc.getSenders().find(a=>a.track&&a.track.id===o.id);if(s)return s.replaceTrack(null)}});Promise.all(n).then(()=>t()).catch(i)},100)})}stopVideoTrack(e){return console.warn("@deprecated stopVideoTrack will be removed in a future version. Use removeVideoTrack instead."),this.removeVideoTrack(e)}removeVideoTrack(e){for(const t of e.getVideoTracks())t.enabled=!1;return new Promise((t,i)=>{setTimeout(()=>{const n=e.getVideoTracks().map(async o=>{if(o.stop(),e.removeTrack(o),this.pc!==null){const s=this.pc.getSenders().find(a=>a.track&&a.track.id===o.id);if(s)return s.replaceTrack(null)}});Promise.all(n).then(()=>t()).catch(i)},100)})}async replaceAudioTrack(e,t){await this.removeAudioTrack(e);const i=this.getAudioTransceiver();if(i===null)throw new Error("Unable to set an audio track. Audio track sender is undefined");e.addTrack(t),await i.sender.replaceTrack(t)}async replaceVideoTrack(e,t){await this.removeVideoTrack(e);const i=this.getVideoTransceiver();if(i===null)throw new Error("Unable to set video track. Video track sender is undefined");e.addTrack(t),await i.sender.replaceTrack(t)}signalingTerminate(){for(const e of Object.keys(this.soraDataChannels)){const t=this.soraDataChannels[e];t&&t.close(),delete this.soraDataChannels[e]}this.ws&&(this.ws.close(),this.ws=null),this.pc&&this.pc.close(),this.initializeConnection()}abendPeerConnectionState(e){this.clearMonitorIceConnectionStateChange(),this.pc&&(this.pc.ondatachannel=null,this.pc.oniceconnectionstatechange=null,this.pc.onicegatheringstatechange=null,this.pc.onconnectionstatechange=null),this.ws&&(this.ws.onclose=i=>{this.writeWebSocketTimelineLog("onclose",{code:i.code,reason:i.reason})},this.ws.onmessage=null,this.ws.onerror=null);for(const i of Object.keys(this.soraDataChannels)){const n=this.soraDataChannels[i];n&&(n.onclose=o=>{const s=o.currentTarget;this.writeDataChannelTimelineLog("onclose",s),this.trace("CLOSE DATA CHANNEL",s.label)},n.onmessage=null,n.onerror=null)}for(const i of Object.keys(this.soraDataChannels)){const n=this.soraDataChannels[i];n&&n.close(),delete this.soraDataChannels[i]}this.ws&&(this.ws.close(),this.ws=null),this.pc&&this.pc.close(),this.initializeConnection();const t=this.soraCloseEvent("abend",e);this.callbacks.disconnect(t),this.writeSoraTimelineLog("disconnect-abend",t)}shutdown(e){this.clearMonitorIceConnectionStateChange(),this.pc&&(this.pc.ondatachannel=null,this.pc.oniceconnectionstatechange=null,this.pc.onicegatheringstatechange=null,this.pc.onconnectionstatechange=null);for(const i of Object.keys(this.soraDataChannels)){const n=this.soraDataChannels[i];n&&(n.onclose=o=>{const s=o.currentTarget;this.writeDataChannelTimelineLog("onclose",s),this.trace("CLOSE DATA CHANNEL",s.label)},n.onmessage=null,n.onerror=null,n.close()),delete this.soraDataChannels[i]}this.maybeClosePeerConnection(),this.initializeConnection();const t=this.soraCloseEvent("normal","SHUTDOWN",e);this.writeSoraTimelineLog("disconnect-normal",t),this.callbacks.disconnect(t)}async abend(e,t){this.clearMonitorIceConnectionStateChange(),this.pc&&(this.pc.ondatachannel=null,this.pc.oniceconnectionstatechange=null,this.pc.onicegatheringstatechange=null,this.pc.onconnectionstatechange=null),this.ws&&(this.ws.onclose=n=>{this.writeWebSocketTimelineLog("onclose",{code:n.code,reason:n.reason})},this.ws.onmessage=null,this.ws.onerror=null);for(const n of Object.keys(this.soraDataChannels)){const o=this.soraDataChannels[n];o&&(o.onclose=s=>{const a=s.currentTarget;this.writeDataChannelTimelineLog("onclose",a),this.trace("CLOSE DATA CHANNEL",a.label)},o.onmessage=null,o.onerror=null)}if(this.soraDataChannels.signaling){const n={type:w,reason:e};if(this.signalingOfferMessageDataChannels.signaling&&this.signalingOfferMessageDataChannels.signaling.compress===!0){const o=new TextEncoder().encode(JSON.stringify(n)),s=await m(o);if(this.soraDataChannels.signaling.readyState==="open")try{this.soraDataChannels.signaling.send(s),this.writeDataChannelSignalingLog("send-disconnect",this.soraDataChannels.signaling,n)}catch(a){const l=a.message;this.writeDataChannelSignalingLog("failed-to-send-disconnect",this.soraDataChannels.signaling,l)}}else if(this.soraDataChannels.signaling.readyState==="open")try{this.soraDataChannels.signaling.send(JSON.stringify(n)),this.writeDataChannelSignalingLog("send-disconnect",this.soraDataChannels.signaling,n)}catch(o){const s=o.message;this.writeDataChannelSignalingLog("failed-to-send-disconnect",this.soraDataChannels.signaling,s)}}for(const n of Object.keys(this.soraDataChannels)){const o=this.soraDataChannels[n];o&&(o.onerror=null,o.close()),delete this.soraDataChannels[n]}if(await this.disconnectWebSocket(e),this.maybeClosePeerConnection(),this.initializeConnection(),e==="WEBSOCKET-ONCLOSE"&&t&&(t.code===1e3||t.code===1005)){const n=this.soraCloseEvent("normal","DISCONNECT",t);this.writeSoraTimelineLog("disconnect-normal",n),this.callbacks.disconnect(n);return}const i=this.soraCloseEvent("abend",e,t);this.writeSoraTimelineLog("disconnect-abend",i),this.callbacks.disconnect(this.soraCloseEvent("abend",e,t))}initializeConnection(){this.simulcast=!1,this.spotlight=!1,this.sessionId=null,this.clientId=null,this.bundleId=null,this.connectionId=null,this.remoteConnectionIds=[],this.stream=null,this.ws=null,this.pc=null,this.encodings=[],this.authMetadata=null,this.soraDataChannels={},this.mids={audio:"",video:""},this.signalingSwitched=!1,this.signalingOfferMessageDataChannels={},this.contactSignalingUrl="",this.connectedSignalingUrl="",this.clearConnectionTimeout()}disconnectWebSocket(e){let t=0;return this.signalingSwitched?(this.ws&&(this.ws.close(),this.ws=null),Promise.resolve(null)):new Promise((i,n)=>{if(!this.ws)return i(null);if(this.ws.onclose=o=>(this.ws&&(this.ws.close(),this.ws=null),clearTimeout(t),this.writeWebSocketTimelineLog("onclose",{code:o.code,reason:o.reason}),i({code:o.code,reason:o.reason})),this.ws.readyState===1){const o={type:w,reason:e};this.ws.send(JSON.stringify(o)),this.writeWebSocketSignalingLog("send-disconnect",o),t=setTimeout(()=>{this.ws&&(this.ws.close(),this.ws=null),i({code:1006,reason:""})},this.disconnectWaitTimeout)}else return this.ws.close(),this.ws=null,i(null)})}forceCloseDataChannels(){for(const e of Object.keys(this.soraDataChannels)){const t=this.soraDataChannels[e];t&&(t.onerror=null,t.onclose=null,t.onmessage=null,t.close())}}async disconnectDataChannel(){if(!this.soraDataChannels.signaling)return this.forceCloseDataChannels(),{code:4999,reason:new Z().message};const e=new Promise((o,s)=>{setTimeout(()=>s(new X),this.disconnectWaitTimeout)}),t=[];for(const o of Object.keys(this.soraDataChannels)){const s=this.soraDataChannels[o];s&&t.push(new Promise((a,l)=>{s.onclose=d=>{const u=d.currentTarget;this.writeDataChannelTimelineLog("onclose",u),this.trace("CLOSE DATA CHANNEL",u.label),a()},s.onerror=()=>l(new ee)}))}const i=Promise.all(t),n={type:w,reason:"NO-ERROR"};if(this.signalingOfferMessageDataChannels.signaling&&this.signalingOfferMessageDataChannels.signaling.compress===!0){const o=new TextEncoder().encode(JSON.stringify(n)),s=await m(o);if(this.soraDataChannels.signaling?.readyState&&this.soraDataChannels.signaling.readyState==="open")try{this.soraDataChannels.signaling.send(s),this.writeDataChannelSignalingLog("send-disconnect",this.soraDataChannels.signaling,n)}catch(a){const l=a.message;this.writeDataChannelSignalingLog("failed-to-send-disconnect",this.soraDataChannels.signaling,l)}}else if(this.soraDataChannels.signaling.readyState==="open")try{this.soraDataChannels.signaling.send(JSON.stringify(n)),this.writeDataChannelSignalingLog("send-disconnect",this.soraDataChannels.signaling,n)}catch(o){const s=o.message;this.writeDataChannelSignalingLog("failed-to-send-disconnect",this.soraDataChannels.signaling,s)}try{return await Promise.race([e,i]),{code:1e3,reason:"TYPE-DISCONNECT"}}catch(o){return this.forceCloseDataChannels(),{code:4999,reason:o.message}}}maybeClosePeerConnection(){this.pc&&this.pc.connectionState!=="closed"&&this.pc.close()}async disconnect(){this.clearMonitorIceConnectionStateChange(),this.pc&&(this.pc.ondatachannel=null,this.pc.oniceconnectionstatechange=null,this.pc.onicegatheringstatechange=null,this.pc.onconnectionstatechange=null),this.ws&&(this.ws.onclose=t=>{this.writeWebSocketTimelineLog("onclose",{code:t.code,reason:t.reason})},this.ws.onmessage=null,this.ws.onerror=null);let e=null;if(this.signalingSwitched){const t=await this.disconnectDataChannel();t.code===4999&&(e=this.soraCloseEvent("abend",t.reason)),e=this.soraCloseEvent("normal","DISCONNECT",t),await this.disconnectWebSocket("NO-ERROR"),this.maybeClosePeerConnection()}else{const t=await this.disconnectWebSocket("NO-ERROR");this.maybeClosePeerConnection(),this.forceCloseDataChannels(),t!==null&&(e=this.soraCloseEvent("normal","DISCONNECT",t))}this.initializeConnection(),e&&(e.type==="abend"?this.writeSoraTimelineLog("disconnect-abend",e):e.type==="normal"&&this.writeSoraTimelineLog("disconnect-normal",e),this.callbacks.disconnect(e))}async getSignalingWebSocket(e){if(typeof e=="string"){const t=e;return new Promise((i,n)=>{const o=new WebSocket(t);o.onclose=s=>{const a=new g(`Signaling failed. CloseEventCode:${s.code} CloseEventReason:'${s.reason}'`);a.code=s.code,a.reason=s.reason,this.writeWebSocketTimelineLog("onclose",a),n(a)},o.onopen=s=>{i(o)}})}if(Array.isArray(e)){let t=!1;const i=n=>new Promise((o,s)=>{const a=new WebSocket(n),l=setTimeout(()=>{this.writeWebSocketSignalingLog("signaling-url-candidate",{type:"timeout",url:a.url}),a&&!t&&(a.onclose=null,a.onerror=null,a.onopen=null,a.close(),s())},this.signalingCandidateTimeout);a.onclose=d=>{this.writeWebSocketSignalingLog("signaling-url-candidate",{type:"close",url:a.url,message:"WebSocket closed",code:d.code,reason:d.reason}),a&&a.close(),clearInterval(l),s()},a.onerror=d=>{this.writeWebSocketSignalingLog("signaling-url-candidate",{type:"error",url:a.url,message:"Failed to connect WebSocket"}),a&&(a.onclose=null,a.close()),clearInterval(l),s()},a.onopen=d=>{a&&(clearInterval(l),t?(this.writeWebSocketSignalingLog("signaling-url-candidate",{type:"open",url:a.url,selected:!1}),a.onerror=null,a.onclose=null,a.onopen=null,a.close(),s()):(this.writeWebSocketSignalingLog("signaling-url-candidate",{type:"open",url:a.url,selected:!0}),a.onerror=null,a.onclose=null,a.onopen=null,t=!0,o(a)))}});try{return await Promise.any(e.map(n=>i(n)))}catch{throw new g("Signaling failed. All signaling URL candidates failed to connect")}}throw new g("Signaling failed. Invalid format signaling URL candidates")}async signaling(e,t=!1){const i=await this.createOffer();return this.trace("CREATE OFFER",i),new Promise((n,o)=>{this.writeWebSocketSignalingLog("new-websocket",e.url),e.binaryType="arraybuffer",e.onclose=s=>{const a=new g(`Signaling failed. CloseEventCode:${s.code} CloseEventReason:'${s.reason}'`);a.code=s.code,a.reason=s.reason,this.writeWebSocketTimelineLog("onclose",a),this.signalingTerminate(),o(a)},e.onmessage=async s=>{if(typeof s.data!="string")throw new Error("Received invalid signaling data");const a=JSON.parse(s.data);if(a.type===v)this.writeWebSocketSignalingLog("onmessage-offer",a),this.signalingOnMessageTypeOffer(a),this.connectedSignalingUrl=e.url,n(a);else if(a.type===k)this.writeWebSocketSignalingLog("onmessage-update",a),await this.signalingOnMessageTypeUpdate(a);else if(a.type===O)this.writeWebSocketSignalingLog("onmessage-re-offer",a),await this.signalingOnMessageTypeReOffer(a);else if(a.type===$)await this.signalingOnMessageTypePing(a);else if(a.type===z)this.callbacks.push(a,p);else if(a.type===H)a.event_type==="connection.created"?this.writeWebSocketTimelineLog("notify-connection.created",a):a.event_type==="connection.destroyed"&&this.writeWebSocketTimelineLog("notify-connection.destroyed",a),this.signalingOnMessageTypeNotify(a,p);else if(a.type===G)this.writeWebSocketSignalingLog("onmessage-switched",a),this.signalingOnMessageTypeSwitched(a);else if(a.type===x){this.writeWebSocketSignalingLog("onmessage-redirect",a);try{const l=await this.signalingOnMessageTypeRedirect(a);n(l)}catch(l){o(l)}}},(async()=>{let s;try{s=oe(i.sdp||"",this.role,this.channelId,this.metadata,this.options,t)}catch(a){o(a);return}this.trace("SIGNALING CONNECT MESSAGE",s),e&&(e.send(JSON.stringify(s)),this.writeWebSocketSignalingLog(`send-${s.type}`,s),this.ws=e,t||(this.contactSignalingUrl=e.url,this.writeWebSocketSignalingLog("contact-signaling-url",this.contactSignalingUrl)))})()})}async connectPeerConnection(e){let t=Object.assign({},e.config);if(window.RTCPeerConnection.generateCertificate!==void 0){const i=await window.RTCPeerConnection.generateCertificate({name:"ECDSA",namedCurve:"P-256"});t=Object.assign({certificates:[i]},t)}this.trace("PEER CONNECTION CONFIG",t),this.writePeerConnectionTimelineLog("new-peerconnection",t),this.pc=new window.RTCPeerConnection(t,this.constraints),this.pc.oniceconnectionstatechange=i=>{this.pc&&(this.writePeerConnectionTimelineLog("oniceconnectionstatechange",{connectionState:this.pc.connectionState,iceConnectionState:this.pc.iceConnectionState,iceGatheringState:this.pc.iceGatheringState}),this.trace("ONICECONNECTIONSTATECHANGE ICECONNECTIONSTATE",this.pc.iceConnectionState))},this.pc.onicegatheringstatechange=i=>{this.pc&&this.writePeerConnectionTimelineLog("onicegatheringstatechange",{connectionState:this.pc.connectionState,iceConnectionState:this.pc.iceConnectionState,iceGatheringState:this.pc.iceGatheringState})},this.pc.onconnectionstatechange=i=>{this.pc&&this.writePeerConnectionTimelineLog("onconnectionstatechange",{connectionState:this.pc.connectionState,iceConnectionState:this.pc.iceConnectionState,iceGatheringState:this.pc.iceGatheringState})},this.pc.ondatachannel=i=>{this.onDataChannel(i)}}async setRemoteDescription(e){if(!this.pc)return;const t=this.processOfferSdp(e.sdp),i=new RTCSessionDescription({type:v,sdp:t});await this.pc.setRemoteDescription(i),this.writePeerConnectionTimelineLog("set-remote-description",i)}async createAnswer(e){if(!this.pc)return;for(const i of Object.values(this.mids)){const n=this.pc.getTransceivers().find(o=>o.mid===i);n&&n.direction===M&&(n.direction=y)}if(this.simulcast&&(this.role===y||this.role===b)){const i=this.pc.getTransceivers().find(n=>{if(n.mid!==null&&n.sender.track!==null&&!(n.currentDirection!==null&&n.currentDirection!==b)&&(this.mids.video!==""&&this.mids.video===n.mid||0<=n.mid.indexOf("video")))return n});if(i){await this.setSenderParameters(i,this.encodings),await this.setRemoteDescription(e),this.trace("TRANSCEIVER SENDER GET_PARAMETERS",i.sender.getParameters()),await this.setSenderParameters(i,this.encodings);const n=await this.pc.createAnswer();await this.pc.setLocalDescription(n),this.trace("TRANSCEIVER SENDER GET_PARAMETERS",i.sender.getParameters());return}}const t=await this.pc.createAnswer();this.writePeerConnectionTimelineLog("create-answer",t),this.options.forceStereoOutput&&t.sdp&&(t.sdp=de(t.sdp)),await this.pc.setLocalDescription(t),this.writePeerConnectionTimelineLog("set-local-description",t)}processOfferSdp(e){let t=e;return ae()&&(t=t.replace(/^m=(audio|video) 0 /gm,(i,n)=>`m=${n} 9 `)),t}sendAnswer(){if(this.pc&&this.ws&&this.pc.localDescription){this.trace("ANSWER SDP",this.pc.localDescription.sdp);const e=this.pc.localDescription.sdp,t={type:_,sdp:e};this.ws.send(JSON.stringify(t)),this.writeWebSocketSignalingLog("send-answer",t)}}onIceCandidate(){return new Promise((e,t)=>{this.pc&&(this.pc.oniceconnectionstatechange=i=>{this.pc&&(this.writePeerConnectionTimelineLog("oniceconnectionstatechange",{connectionState:this.pc.connectionState,iceConnectionState:this.pc.iceConnectionState,iceGatheringState:this.pc.iceGatheringState}),this.trace("ONICECONNECTIONSTATECHANGE ICECONNECTIONSTATE",this.pc.iceConnectionState),this.pc.iceConnectionState==="connected"&&e())},this.pc.onicecandidate=async i=>{if(this.writePeerConnectionTimelineLog("onicecandidate",i.candidate),this.pc&&this.trace("ONICECANDIDATE ICEGATHERINGSTATE",this.pc.iceGatheringState),i.candidate===null)e();else{const n=i.candidate.toJSON(),o=Object.assign(n,{type:U});this.trace("ONICECANDIDATE CANDIDATE MESSAGE",o),await this.sendSignalingMessage(o)}})})}waitChangeConnectionStateConnected(){return new Promise((e,t)=>{if(this.pc&&this.pc.connectionState===void 0){e();return}const i=setInterval(()=>{if(this.pc)this.pc&&this.pc.connectionState==="connected"&&(clearInterval(i),e());else{const n=new Error;n.message="PeerConnection connectionState did not change to 'connected'",clearInterval(i),t(n)}},10)})}monitorSignalingWebSocketEvent(){return new Promise((e,t)=>{this.monitorSignalingWebSocketEventTimerId=setInterval(()=>{this.ws&&(this.clearMonitorSignalingWebSocketEvent(),this.ws.onclose=i=>{const n=new g(`Signaling failed. CloseEventCode:${i.code} CloseEventReason:'${i.reason}'`);n.code=i.code,n.reason=i.reason,this.writeWebSocketTimelineLog("onclose",n),this.signalingTerminate(),t(n)},this.ws.onerror=i=>{const n=new g("Signaling failed. WebSocket onerror was called");this.writeWebSocketSignalingLog("onerror",n),this.signalingTerminate(),t(n)})},100)})}monitorWebSocketEvent(){this.ws&&(this.ws.onclose=async e=>{this.writeWebSocketTimelineLog("onclose",{code:e.code,reason:e.reason}),e.code===1e3?this.shutdown({code:e.code,reason:e.reason}):await this.abend("WEBSOCKET-ONCLOSE",{code:e.code,reason:e.reason})},this.ws.onerror=async e=>{this.writeWebSocketSignalingLog("onerror"),await this.abend("WEBSOCKET-ONERROR")})}monitorPeerConnectionState(){this.pc&&(this.pc.oniceconnectionstatechange=e=>{this.pc&&this.pc.connectionState===void 0&&(this.writePeerConnectionTimelineLog("oniceconnectionstatechange",{connectionState:this.pc.connectionState,iceConnectionState:this.pc.iceConnectionState,iceGatheringState:this.pc.iceGatheringState}),this.trace("ONICECONNECTIONSTATECHANGE ICECONNECTIONSTATE",this.pc.iceConnectionState),clearTimeout(this.monitorIceConnectionStateChangeTimerId),this.pc.iceConnectionState==="failed"?this.abendPeerConnectionState("ICE-CONNECTION-STATE-FAILED"):this.pc.iceConnectionState==="disconnected"&&(this.monitorIceConnectionStateChangeTimerId=setTimeout(()=>{this.pc&&this.pc.iceConnectionState==="disconnected"&&this.abendPeerConnectionState("ICE-CONNECTION-STATE-DISCONNECTED-TIMEOUT")},1e4)))},this.pc.onconnectionstatechange=e=>{this.pc&&(this.writePeerConnectionTimelineLog("onconnectionstatechange",{connectionState:this.pc.connectionState,iceConnectionState:this.pc.iceConnectionState,iceGatheringState:this.pc.iceGatheringState}),this.pc.connectionState==="failed"&&this.abendPeerConnectionState("CONNECTION-STATE-FAILED"))})}setConnectionTimeout(){return new Promise((e,t)=>{0<this.connectionTimeout&&(this.connectionTimeoutTimerId=setTimeout(()=>{if(!this.pc||this.pc&&this.pc.connectionState!==void 0&&this.pc.connectionState!=="connected"){const i=new Error;i.message="Signaling connection timeout",this.callbacks.timeout(),this.trace("DISCONNECT","Signaling connection timeout"),this.writePeerConnectionTimelineLog("signaling-connection-timeout",{connectionTimeout:this.connectionTimeout}),this.signalingTerminate(),t(i)}},this.connectionTimeout))})}clearConnectionTimeout(){clearTimeout(this.connectionTimeoutTimerId)}clearMonitorSignalingWebSocketEvent(){clearInterval(this.monitorSignalingWebSocketEventTimerId)}clearMonitorIceConnectionStateChange(){clearInterval(this.monitorIceConnectionStateChangeTimerId)}trace(e,t){this.callbacks.log(e,t),this.debug&&ce(this.clientId,e,t)}writeWebSocketSignalingLog(e,t){this.callbacks.signaling(E(e,t,p)),this.writeWebSocketTimelineLog(e,t)}writeDataChannelSignalingLog(e,t,i){this.callbacks.signaling(E(e,i,W)),this.writeDataChannelTimelineLog(e,t,i)}writeWebSocketTimelineLog(e,t){const i=f(e,t,p);this.callbacks.timeline(i)}writeDataChannelTimelineLog(e,t,i){const n=f(e,i,"datachannel",t.id,t.label);this.callbacks.timeline(n)}writePeerConnectionTimelineLog(e,t){const i=f(e,t,"peerconnection");this.callbacks.timeline(i)}writeSoraTimelineLog(e,t){const i=f(e,t,"sora");this.callbacks.timeline(i)}async createOffer(){const e={iceServers:[]},t=new window.RTCPeerConnection(e);if(se()){t.addTransceiver("video",{direction:"recvonly"}),t.addTransceiver("audio",{direction:"recvonly"});const n=await t.createOffer();return t.close(),this.writePeerConnectionTimelineLog("create-offer",n),n}const i=await t.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});return t.close(),this.writePeerConnectionTimelineLog("create-offer",i),i}signalingOnMessageTypeOffer(e){if(this.simulcast=e.simulcast,this.spotlight=e.spotlight,e.session_id!==void 0&&(this.sessionId=e.session_id),this.clientId=e.client_id,this.bundleId=e.bundle_id,this.connectionId=e.connection_id,e.metadata!==void 0&&(this.authMetadata=e.metadata),Array.isArray(e.encodings)&&(this.encodings=e.encodings),e.mid!==void 0&&e.mid.audio!==void 0&&(this.mids.audio=e.mid.audio),e.mid!==void 0&&e.mid.video!==void 0&&(this.mids.video=e.mid.video),e.data_channels)for(const t of e.data_channels)this.signalingOfferMessageDataChannels[t.label]=t;this.trace("SIGNALING OFFER MESSAGE",e),this.trace("OFFER SDP",e.sdp)}async sendUpdateAnswer(){this.pc&&this.ws&&this.pc.localDescription&&(this.trace("UPDATE ANSWER SDP",this.pc.localDescription.sdp),await this.sendSignalingMessage({type:k,sdp:this.pc.localDescription.sdp}))}async sendReAnswer(){this.pc?.localDescription&&(this.trace("RE ANSWER SDP",this.pc.localDescription.sdp),await this.sendSignalingMessage({type:B,sdp:this.pc.localDescription.sdp}))}async signalingOnMessageTypeUpdate(e){this.trace("SIGNALING UPDATE MESSGE",e),this.trace("UPDATE SDP",e.sdp),await this.setRemoteDescription(e),await this.createAnswer(e),await this.sendUpdateAnswer()}async signalingOnMessageTypeReOffer(e){this.trace("SIGNALING RE OFFER MESSGE",e),this.trace("RE OFFER SDP",e.sdp),await this.setRemoteDescription(e),await this.createAnswer(e),await this.sendReAnswer()}async signalingOnMessageTypeClose(e){this.trace("SIGNALING DISCONNECT MESSAGE",e),this.shutdown({code:e.code,reason:e.reason})}async signalingOnMessageTypePing(e){const t={type:J};if(e.stats){const i=await this.getStats();t.stats=i}this.ws&&this.ws.send(JSON.stringify(t))}signalingOnMessageTypeNotify(e,t){this.callbacks.notify(e,t)}signalingOnMessageTypeSwitched(e){if(this.signalingSwitched=!0,!!this.ws){e.ignore_disconnect_websocket&&(this.ws&&(this.ws.onclose=null,this.ws.close(),this.ws=null),this.writeWebSocketSignalingLog("close"));for(const t of this.datachannels)this.callbacks.datachannel(he(t))}}async signalingOnMessageTypeRedirect(e){this.ws&&(this.ws.onclose=null,this.ws.onerror=null,this.ws.close(),this.ws=null);const t=await this.getSignalingWebSocket(e.location);return await this.signaling(t,!0)}async setSenderParameters(e,t){const i=e.sender.getParameters();i.encodings=t,await e.sender.setParameters(i),this.trace("TRANSCEIVER SENDER SET_PARAMETERS",i),this.writePeerConnectionTimelineLog("transceiver-sender-set-parameters",i)}async getStats(){const e=[];if(!this.pc)return e;const t=await this.pc.getStats();for(const[i,n]of t.entries())e.push(n);return e}onDataChannel(e){const t=e.channel;t.bufferedAmountLowThreshold=65536,t.binaryType="arraybuffer",this.soraDataChannels[t.label]=t,this.writeDataChannelTimelineLog("ondatachannel",t,re(t)),e.channel.onbufferedamountlow=i=>{const n=i.currentTarget;this.writeDataChannelTimelineLog("onbufferedamountlow",n)},e.channel.onopen=i=>{const n=i.currentTarget;this.trace("OPEN DATA CHANNEL",n.label),n.label==="signaling"&&this.ws?this.writeDataChannelSignalingLog("onopen",n):this.writeDataChannelTimelineLog("onopen",n)},e.channel.onclose=async i=>{const n=i.currentTarget;this.writeDataChannelTimelineLog("onclose",n),this.trace("CLOSE DATA CHANNEL",n.label),await this.disconnect()},e.channel.onerror=async i=>{const n=i.currentTarget;this.writeDataChannelTimelineLog("onerror",n),this.trace("ERROR DATA CHANNEL",n.label),await this.abend("DATA-CHANNEL-ONERROR",{params:{label:n.label}})},e.channel.label===K?e.channel.onmessage=async i=>{const n=i.currentTarget,o=n.label,s=this.signalingOfferMessageDataChannels[o];if(!s){console.warn(`Received onmessage event for '${o}' DataChannel. But '${o}' DataChannel settings doesn't exist`);return}const a=await C(i.data,s.compress),l=JSON.parse(a);this.writeDataChannelSignalingLog(`onmessage-${l.type}`,n,l),l.type===O?await this.signalingOnMessageTypeReOffer(l):l.type===V&&await this.signalingOnMessageTypeClose(l)}:e.channel.label===Y?e.channel.onmessage=async i=>{const n=i.currentTarget,o=n.label,s=this.signalingOfferMessageDataChannels[o];if(!s){console.warn(`Received onmessage event for '${o}' DataChannel. But '${o}' DataChannel settings doesn't exist`);return}const a=await C(i.data,s.compress),l=JSON.parse(a);l.event_type==="connection.created"?this.writeDataChannelTimelineLog("notify-connection.created",n,l):l.event_type==="connection.destroyed"&&this.writeDataChannelTimelineLog("notify-connection.destroyed",n,l),this.signalingOnMessageTypeNotify(l,"datachannel")}:e.channel.label===q?e.channel.onmessage=async i=>{const n=i.currentTarget.label,o=this.signalingOfferMessageDataChannels[n];if(!o){console.warn(`Received onmessage event for '${n}' DataChannel. But '${n}' DataChannel settings doesn't exist`);return}const s=await C(i.data,o.compress),a=JSON.parse(s);this.callbacks.push(a,"datachannel")}:e.channel.label===Q?e.channel.onmessage=async i=>{const n=i.currentTarget.label,o=this.signalingOfferMessageDataChannels[n];if(!o){console.warn(`Received onmessage event for '${n}' DataChannel. But '${n}' DataChannel settings doesn't exist`);return}const s=await C(i.data,o.compress);if(JSON.parse(s).type===j){const a=await this.getStats();await this.sendStatsMessage(a)}}:/^#.*/.exec(e.channel.label)&&(e.channel.onmessage=async i=>{if(i.currentTarget===null)return;const n=i.currentTarget.label,o=this.signalingOfferMessageDataChannels[n];if(!o){console.warn(`Received onmessage event for '${n}' DataChannel. But '${n}' DataChannel settings doesn't exist`);return}const s=i.target;let a;typeof i.data=="string"?a=new TextEncoder().encode(i.data).buffer:i.data instanceof ArrayBuffer?a=i.data:console.warn("Received onmessage event data is not of type String or ArrayBuffer."),a!==void 0&&(o.compress===!0&&(a=await P(new Uint8Array(a))),this.callbacks.message(le(s.label,a)))})}async sendSignalingMessage(e){if(this.soraDataChannels.signaling){if(this.signalingOfferMessageDataChannels.signaling&&this.signalingOfferMessageDataChannels.signaling.compress===!0){const t=new TextEncoder().encode(JSON.stringify(e)),i=await m(t);this.soraDataChannels.signaling.send(i)}else this.soraDataChannels.signaling.send(JSON.stringify(e));this.writeDataChannelSignalingLog(`send-${e.type}`,this.soraDataChannels.signaling,e)}else this.ws!==null&&(this.ws.send(JSON.stringify(e)),this.writeWebSocketSignalingLog(`send-${e.type}`,e))}async sendStatsMessage(e){if(this.soraDataChannels.stats){const t={type:F,reports:e};if(this.signalingOfferMessageDataChannels.stats&&this.signalingOfferMessageDataChannels.stats.compress===!0){const i=new TextEncoder().encode(JSON.stringify(t)),n=await m(i);this.soraDataChannels.stats.send(n)}else this.soraDataChannels.stats.send(JSON.stringify(t))}}getAudioTransceiver(){return this.pc&&this.mids.audio&&this.pc.getTransceivers().find(e=>e.mid===this.mids.audio)||null}getVideoTransceiver(){return this.pc&&this.mids.video&&this.pc.getTransceivers().find(e=>e.mid===this.mids.video)||null}soraCloseEvent(e,t,i){const n=class extends Event{title;code;reason;params;constructor(o,s,a){super(o),a&&(a.code&&(this.code=a.code),a.reason&&(this.reason=a.reason),a.params&&(this.params=a.params)),this.title=s}};return new n(e,t,i)}async sendMessage(e,t){const i=this.soraDataChannels[e];if(this.pc===null)return;if(i===void 0)throw new Error("Could not find DataChannel");if(i.readyState!=="open")throw new Error("Messaging DataChannel is not open");const n=this.signalingOfferMessageDataChannels[e];if(n!==void 0&&n.compress===!0){const o=await m(t);i.send(o)}else i.send(t)}get audio(){return this.getAudioTransceiver()!==null}get video(){return this.getVideoTransceiver()!==null}get signalingUrl(){return this.signalingUrlCandidates}get datachannels(){if(!this.signalingSwitched)return[];const e=Object.keys(this.signalingOfferMessageDataChannels).filter(i=>/^#.*/.exec(i)),t=[];for(const i of e){const n=this.soraDataChannels[i];if(!n)continue;const o=this.signalingOfferMessageDataChannels[i];if(!o)continue;const s={label:n.label,ordered:n.ordered,protocol:n.protocol,compress:o.compress,direction:o.direction,header:o.header};typeof n.maxPacketLifeTime=="number"&&(s.maxPacketLifeTime=n.maxPacketLifeTime),typeof n.maxRetransmits=="number"&&(s.maxRetransmits=n.maxRetransmits),t.push(s)}return t}}class we extends S{async connect(){await Promise.race([this.multiStream().finally(()=>{this.clearConnectionTimeout(),this.clearMonitorSignalingWebSocketEvent()}),this.setConnectionTimeout(),this.monitorSignalingWebSocketEvent()]),this.monitorWebSocketEvent(),this.monitorPeerConnectionState()}async multiStream(){await this.disconnect();const e=await this.getSignalingWebSocket(this.signalingUrlCandidates),t=await this.signaling(e);await this.connectPeerConnection(t),await this.setRemoteDescription(t),await this.createAnswer(t),this.sendAnswer(),await this.onIceCandidate(),await this.waitChangeConnectionStateConnected()}}class D extends S{async connect(e){return this.options.multistream===!1?await Promise.race([this.legacyStream(e).finally(()=>{this.clearConnectionTimeout(),this.clearMonitorSignalingWebSocketEvent()}),this.setConnectionTimeout(),this.monitorSignalingWebSocketEvent()]):await Promise.race([this.multiStream(e).finally(()=>{this.clearConnectionTimeout(),this.clearMonitorSignalingWebSocketEvent()}),this.setConnectionTimeout(),this.monitorSignalingWebSocketEvent()]),this.monitorWebSocketEvent(),this.monitorPeerConnectionState(),e}async legacyStream(e){await this.disconnect();const t=await this.getSignalingWebSocket(this.signalingUrlCandidates),i=await this.signaling(t);return await this.connectPeerConnection(i),await this.setRemoteDescription(i),e.getTracks().filter(n=>{this.pc&&this.pc.addTrack(n,e)}),this.stream=e,await this.createAnswer(i),this.sendAnswer(),await this.onIceCandidate(),await this.waitChangeConnectionStateConnected(),e}async multiStream(e){await this.disconnect();const t=await this.getSignalingWebSocket(this.signalingUrlCandidates),i=await this.signaling(t);return await this.connectPeerConnection(i),this.pc&&(this.pc.ontrack=async n=>{const o=n.streams[0];if(!o)return;const s={"stream.id":o.id,id:n.track.id,label:n.track.label,enabled:n.track.enabled,kind:n.track.kind,muted:n.track.muted,readyState:n.track.readyState};this.writePeerConnectionTimelineLog("ontrack",s),o.id!=="default"&&o.id!==this.connectionId&&(this.callbacks.track(n),o.onremovetrack=a=>{if(this.callbacks.removetrack(a),a.target){const l=a.target.id,d=this.remoteConnectionIds.indexOf(l);-1<d&&delete this.remoteConnectionIds[d]}},!(-1<this.remoteConnectionIds.indexOf(o.id))&&this.remoteConnectionIds.push(o.id))}),await this.setRemoteDescription(i),e.getTracks().filter(n=>{this.pc&&this.pc.addTrack(n,e)}),this.stream=e,await this.createAnswer(i),this.sendAnswer(),await this.onIceCandidate(),await this.waitChangeConnectionStateConnected(),e}}class Se extends S{async connect(){if(this.options.multistream===!1){const e=await Promise.race([this.legacyStream().finally(()=>{this.clearConnectionTimeout(),this.clearMonitorSignalingWebSocketEvent()}),this.setConnectionTimeout(),this.monitorSignalingWebSocketEvent()]);return this.monitorWebSocketEvent(),this.monitorPeerConnectionState(),e}await Promise.race([this.multiStream().finally(()=>{this.clearConnectionTimeout(),this.clearMonitorSignalingWebSocketEvent()}),this.setConnectionTimeout(),this.monitorSignalingWebSocketEvent()]),this.monitorWebSocketEvent(),this.monitorPeerConnectionState()}async legacyStream(){await this.disconnect();const e=await this.getSignalingWebSocket(this.signalingUrlCandidates),t=await this.signaling(e);return await this.connectPeerConnection(t),this.pc&&(this.pc.ontrack=async i=>{this.stream=i.streams[0];const n=this.stream.id;if(n==="default")return;const o={"stream.id":n,id:i.track.id,label:i.track.label,enabled:i.track.enabled,kind:i.track.kind,muted:i.track.muted,readyState:i.track.readyState};this.writePeerConnectionTimelineLog("ontrack",o),this.callbacks.track(i),this.stream.onremovetrack=s=>{if(this.callbacks.removetrack(s),s.target){const a=s.target.id,l=this.remoteConnectionIds.indexOf(a);-1<l&&delete this.remoteConnectionIds[l]}},!(-1<this.remoteConnectionIds.indexOf(n))&&this.remoteConnectionIds.push(n)}),await this.setRemoteDescription(t),await this.createAnswer(t),this.sendAnswer(),await this.onIceCandidate(),await this.waitChangeConnectionStateConnected(),this.stream||new MediaStream}async multiStream(){await this.disconnect();const e=await this.getSignalingWebSocket(this.signalingUrlCandidates),t=await this.signaling(e);await this.connectPeerConnection(t),this.pc&&(this.pc.ontrack=async i=>{const n=i.streams[0];if(n.id==="default"||n.id===this.connectionId)return;const o={"stream.id":n.id,id:i.track.id,label:i.track.label,enabled:i.track.enabled,kind:i.track.kind,muted:i.track.muted,readyState:i.track.readyState};this.writePeerConnectionTimelineLog("ontrack",o),this.callbacks.track(i),n.onremovetrack=s=>{if(this.callbacks.removetrack(s),s.target){const a=s.target.id,l=this.remoteConnectionIds.indexOf(a);-1<l&&delete this.remoteConnectionIds[l]}},!(-1<this.remoteConnectionIds.indexOf(n.id))&&this.remoteConnectionIds.push(n.id)}),await this.setRemoteDescription(t),await this.createAnswer(t),this.sendAnswer(),await this.onIceCandidate(),await this.waitChangeConnectionStateConnected()}}class Te{signalingUrlCandidates;debug;constructor(e,t=!1){this.signalingUrlCandidates=e,this.debug=t}sendrecv(e,t=null,i={audio:!0,video:!0}){return new D(this.signalingUrlCandidates,"sendrecv",e,t,i,this.debug)}sendonly(e,t=null,i={audio:!0,video:!0}){return new D(this.signalingUrlCandidates,"sendonly",e,t,i,this.debug)}recvonly(e,t=null,i={audio:!0,video:!0}){return new Se(this.signalingUrlCandidates,"recvonly",e,t,i,this.debug)}messaging(e,t=null,i={audio:!1,video:!1}){return i.audio=!1,i.video=!1,i.multistream=!0,i.dataChannelSignaling=!0,new we(this.signalingUrlCandidates,"sendonly",e,t,i,this.debug)}get signalingUrl(){return this.signalingUrlCandidates}}const ye={connection:(c,e=!1)=>new Te(c,e),version:()=>"2025.1.0-canary.0",helpers:{applyMediaStreamConstraints:R}};export{ye as b};
